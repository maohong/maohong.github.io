<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Spark on yarn的内存分配问题</title>
    <url>/20160811/Spark-on-yarn%E7%9A%84%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<h2 id="问题描述"><a class="markdownIt-Anchor" href="#问题描述"></a> 问题描述</h2>
<p>在测试spark on yarn时，发现一些内存分配上的问题，具体如下。</p>
<p>在$SPARK_HOME/conf/spark-env.sh中配置如下参数：</p>
<blockquote>
<p>SPARK_EXECUTOR_INSTANCES=4            <em>在yarn集群中启动的executor进程数</em></p>
<p>SPARK_EXECUTOR_MEMORY=2G              <em>为每个executor进程分配的内存大小</em></p>
<p>SPARK_DRIVER_MEMORY=1G                <em>为spark-driver进程分配的内存大小</em></p>
</blockquote>
<p>执行$SPARK_HOME/bin/spark-sql –master yarn，按yarn-client模式启动spark-sql交互命令行（即driver程序运行在本地，而非yarn的container中），日志显示的关于AppMaster和Executor的内存信息如下：</p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20150813/sparkonyarn-1.png" alt=""></p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20150813/sparkonyarn-2.png" alt=""></p>
<p>日志显示，AppMaster的内存是896MB，其中包含了384MB的memoryOverhead；启动了5个executor，第一个的可用内存是530.3MB，其余每个Executor的可用内存是1060.3MB。</p>
<p>到yarnUI看下资源使用情况，共启动了5个container，占用内存13G，其中一台NodeManager启动了2个container，占用内存4G（1个AppMaster占1G、另一个占3G），另外3台各启了1个container，每个占用3G内存。</p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20150813/sparkonyarn-3.png" alt=""></p>
<p>再到sparkUI看下executors的情况，这里有5个executor，其中driver是运行在执行spark-sql命令的本地服务器上，另外4个是运行在yarn集群中。Driver的可用storage memory为530.3MB，另外4个都是1060.3MB（与日志信息一致）。</p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20150813/sparkonyarn-4.png" alt=""></p>
<p>那么问题来了：</p>
<ol>
<li>
<p>Yarn为container分配的最小内存由yarn.scheduler.minimum-allocation-mb参数决定，默认是1G，从yarnUI中看确实如此，可为何spark的日志里显示AppMaster的实际内存是896-384=512MB呢？384MB是怎么算出来的？</p>
</li>
<li>
<p>spark配置文件里指定了每个executor的内存为2G，为何日志和sparkUI上显示的是1060.3MB？</p>
</li>
<li>
<p>driver的内存配置为1G，为何sparkUI里显示的是530.3MB呢？</p>
</li>
<li>
<p>为何yarn中每个container分配的内存是3G，而不是executor需要的2G呢？</p>
</li>
</ol>
<h2 id="问题解析"><a class="markdownIt-Anchor" href="#问题解析"></a> 问题解析</h2>
<p>进过一番调研，发现这里有些概念容易混淆，整理如下，序号对应上面的问题：</p>
<span id="more"></span>
<p>(1) spark的yarn-client向ResourceManager申请提交作业/启动AppMaster时，会判断是否是集群模式，如果是集群模式，则AppMaster的内存大小与driver内存大小一致，否则由spark.yarn.am.memory决定，这个参数的默认值是512MB。我们使用的是yarn-client模式，所以实际内存是512MB。</p>
<p><font color="red">384MB是spark-client为appMaster额外申请的内存</font>，计算方法如下：</p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20150813/sparkonyarn-5.png" alt=""></p>
<p>即，默认从参数读取（集群模式从spark.yarn.driver.memoryOverhead参数读，否则从spark.yarn.am.memoryOverhead参数读），若没配此参数，则从AppMaster的内存*一定系数和默认最小overhead中取较大值。</p>
<p>在spark-1.4.1版本中，MEMORY_OVERHEAD_FACTOR的默认值为0.10（之前是0.07），MEMORY_OVERHEAD_MIN默认为384，我们没有指定spark.yarn.driver.memoryOverhead和spark.yarn.am.memoryOverhead，而amMemory=512M（由spark.yarn.am.memory决定），因此memoryOverhead为max(512*0.10, 384)=384MB。</p>
<p>Executor的memoryOverhead计算方法与此一样，只是不区分是否集群模式，都默认由spark.yarn.executor.memoryOverhead配置。</p>
<p>(2) <font color="red">日志和sparkUI上显示的是executor内部用于缓存计算结果的内存空间，并不是executor所拥有的全部内存</font>。这部分内存是由以下公式计算：</p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20150813/sparkonyarn-6.png" alt=""></p>
<p>Runtime.getRuntime.maxMemory按2048MB算，storage memory大小为1105.92MB，sparkUI显示的略小于此值，是正常的。</p>
<p>(3) 与上述第2点一样，storage memory的大小略小于1024<em>0.9</em>0.6=552.96MB</p>
<p>(4) 前面提到spark会为container额外申请一部分内存（memoryOverhead），因此，实际为container提交申请的内存大小是2048 + max(2048*0.10, 384) = 2432MB，而<font color="red">yarn在做资源分配时会做资源规整化，即应用程序申请的资源量一定是最小可申请资源量的整数倍（向上取整）</font>，最小可申请内存量由yarn.scheduler.minimum-allocation-mb指定，因此，会为container分配3G内存。</p>
<h2 id="验证"><a class="markdownIt-Anchor" href="#验证"></a> 验证</h2>
<p>为了验证上述规则，继续修改配置参数：</p>
<blockquote>
<p>SPARK_EXECUTOR_INSTANCES=4          <em>在yarn集群中启动的executor进程数</em></p>
<p>SPARK_EXECUTOR_MEMORY=4G            <em>为每个executor进程分配的内存大小</em></p>
<p>SPARK_DRIVER_MEMORY=3G              <em>为spark-driver进程分配的内存大小</em></p>
</blockquote>
<p>并在启动spark-sql时指定spark.yarn.am.memory参数：</p>
<p><strong>bin/spark-sql –master yarn –conf spark.yarn.am.memory=1024m</strong></p>
<p>再看日志信息：</p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20150813/sparkonyarn-7.png" alt=""></p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20150813/sparkonyarn-8.png" alt=""></p>
<p>yarnUI状态：</p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20150813/sparkonyarn-9.png" alt=""></p>
<p>sparkUI的executors信息：</p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20150813/sparkonyarn-10.png" alt=""></p>
<p>可见，AppMaster的实际内存为1024M（1408-384），而其在yarn中的container内存大小为2G（1408大于1G，yarn按资源规整化原则为其分配2G）。</p>
<p>同理，driver的storage memory空间为3G*0.9*0.6=1.62G，executor的storage memory空间为4G*0.9*0.6=2.16G，executor所在container占用5G内存（4096+max(4096*0.10,384)= 4505.6，大于4G， yarn按资源规整化原则为其分配5G）。</p>
<p>Yarn集群的内存总占用空间为2+5*4=22G。</p>
]]></content>
      <categories>
        <category>Spark</category>
      </categories>
      <tags>
        <tag>spark</tag>
        <tag>yarn</tag>
        <tag>内存分配</tag>
      </tags>
  </entry>
  <entry>
    <title>Storm的消息可靠处理机制</title>
    <url>/20170205/Storm%E7%9A%84%E6%B6%88%E6%81%AF%E5%8F%AF%E9%9D%A0%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6/</url>
    <content><![CDATA[<h2 id="简介"><a class="markdownIt-Anchor" href="#简介"></a> 简介</h2>
<p>提交进入Storm运行的topology实际上是一个有向无环图（DAG），其中的节点是由spout和bolt组成，边则可以理解为消息从一个节点到传输到另一个节点的过程。对于spout产生的tuple，只有在topology上处理完毕后，才认为这个tuple被storm可靠处理。</p>
<p>Storm提供了可靠处理消息（storm中的通用名叫tuple）的框架，我们在写一个topology程序时，若需要保证spout产生的消息的可靠处理，需要做到两点：</p>
<p>第一是spout/bolt每生成一个新的tuple都告诉storm一下（其中spout发出的tuple有个id叫rootId），从而让storm能够追踪rootId和每个衍生tuple的处理状态。</p>
<p>第二是每个tuple被下游bolt处理完毕后，无论处理成功或失败，也再告诉storm一下，从而让storm知道是否需要spout重新发送rootId。</p>
<p>做了这两件事，storm就能知道这个tuple是否被处理完毕。如果是处理成功了的，就说明最初从spout发出的tuple（rootId）已在topology中处理完毕，无需spout重新发送。如果是处理失败的，storm则会告知spout重新发送rootId这个tuple。</p>
<h2 id="在程序中实现消息可靠处理"><a class="markdownIt-Anchor" href="#在程序中实现消息可靠处理"></a> 在程序中实现消息可靠处理</h2>
<p>那在写一个topology时，我们该如何做上面提到的两件事呢？</p>
<span id="more"></span>
<p>Storm提供了BaseRichBolt抽象类（实现了IRichBolt接口），一个示例bolt如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SplitSentence</span> <span class="keyword">extends</span> <span class="title class_">BaseRichBolt</span> {</span><br><span class="line">    OutputCollector _collector;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">prepare</span><span class="params">(Map conf, TopologyContext context, OutputCollector collector)</span> {</span><br><span class="line">        _collector = collector;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Tuple t)</span> {</span><br><span class="line">        <span class="type">String</span> <span class="variable">sentence</span> <span class="operator">=</span> t.getString(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span>(String word: sentence.split(<span class="string">" "</span>)) {</span><br><span class="line">            <span class="comment">//1. 告诉storm生成了一个新的tuple，并且这个tuple的锚点是tuple</span></span><br><span class="line">            _collector.emit(t, <span class="keyword">new</span> <span class="title class_">Values</span>(word));</span><br><span class="line">        }</span><br><span class="line">        _collector.ack(t); <span class="comment">//2. 告诉storm，t这个tuple已处理完毕</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">declareOutputFields</span><span class="params">(OutputFieldsDeclarer declarer)</span> {</span><br><span class="line">        declarer.declare(<span class="keyword">new</span> <span class="title class_">Fields</span>(<span class="string">"word"</span>));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>这段代码就做了这两件事，一是输出新的tuple并告知storm，二是对当前tuple t处理完毕后，告知storm。</p>
<p>对于第一件事，这里要注意的是，在BaseRichBolt中输出一个新的tuple（示例中是word）时，必须指定其锚点（即当前bolt正在处理的tuple），因为输出新的tuple会继续被下游bolt处理，这个锚点tuple和下游tuple之间的路径就是DAG的一条边。如果不指定锚点，则可以理解为storm不知道这条边的存在，也就不会对新输出的tuple进行跟踪了。</p>
<p>如果我们确实不需要保证消息的可靠处理，则使用以下方式输出新tuple即可。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">_collector.emit(<span class="keyword">new</span> <span class="title class_">Values</span>(word));</span><br></pre></td></tr></tbody></table></figure>
<p>另外，一个tuple的锚点tuple可以有多个，比如如下代码，新输出的tuple的锚点就是tuple1和tuple2。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="type">List</span> <span class="variable">anchors</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">anchors.add(tuple1);</span><br><span class="line">anchors.add(tuple2);</span><br><span class="line">_collector.emit(anchors, <span class="keyword">new</span> <span class="title class_">Values</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>));</span><br></pre></td></tr></tbody></table></figure>
<p>对于第二件事，通过调用OutputCollector的ack或fail方法，即可告知storm当前tuple的处理结果。比如，假设我们在bolt中做一些操作的时候出现异常（比如访问redis、DB、hdfs等），可以调fail方法快速重放rootId，避免等到storm判断这个tuple处理超时后才重放。</p>
<h2 id="更简便的方式"><a class="markdownIt-Anchor" href="#更简便的方式"></a> 更简便的方式</h2>
<p>很明显，以上方式有几个弊端：</p>
<ol>
<li>
<p>输出新tuple和对tuple的ack/fail操作需要我们自己维护，代价很高，容易遗忘。</p>
</li>
<li>
<p>storm是在内存中维护每个tuple的处理状态，如果只对tuple进行锚点标记但处理完毕后忘记ack/fail，在tuple量非常大时，有内存溢出的风险。</p>
</li>
</ol>
<p>鉴于此，storm提供了BaseBasicBolt抽象类（实现了IBasicBolt接口）来帮助我们实现对每个tuple的锚点标记和ack/fail。<br>
前面的例子可改写如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SplitSentence</span> <span class="keyword">extends</span> <span class="title class_">BaseBasicBolt</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Tuple tuple, BasicOutputCollector collector)</span> {</span><br><span class="line">        <span class="type">String</span> <span class="variable">sentence</span> <span class="operator">=</span> tuple.getString(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span>(String word: sentence.split(<span class="string">" "</span>)) {</span><br><span class="line">            collector.emit(<span class="keyword">new</span> <span class="title class_">Values</span>(word));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">declareOutputFields</span><span class="params">(OutputFieldsDeclarer declarer)</span> {</span><br><span class="line">        declarer.declare(<span class="keyword">new</span> <span class="title class_">Fields</span>(<span class="string">"word"</span>));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>可见，在代码中，我们只需要关心bolt的处理逻辑即可，至于标记锚点和ack/fail，均不用关心。</p>
<p>细究一下storm框架对IBasicBolt的处理可知，在创建topology时，IBasicBolt是被封装在BasicBoltExecutor类（实现了IRichBolt接口）中处理的。</p>
<p>构建topology时的setBolt方法：</p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20151105/bolt-executor.png" alt=""></p>
<h2 id="原理示例"><a class="markdownIt-Anchor" href="#原理示例"></a> 原理&amp;示例</h2>
<p>刚刚提到对每个topology，storm都在内存中维护其tuple的处理状态，那么对于一个大规模集群，storm是如何高效的维护大量tuple的处理状态的呢？</p>
<p>其实，topology在运行时，内部有一组特殊的任务叫acker，专门用来做tuple的ack/fail。当一个root tuple（spout输出的tuple）在DAG中处理完毕后，acker会向产生该tuple的spout发送消息来ack这个tuple。</p>
<p>我们可通过参数Config.TOPOLOGY_ACKER_EXECUTORS指定topology中的acker任务的数量，默认是与topology中的worker数相同，在处理大量消息的场景下，可以通过此参数增加topology的acker任务数，以提高对message做ack/fail的效率。</p>
<p>storm通过给每个tuple设置一个全局唯一id，并在输出tuple和tuple处理完毕时收集tuple的id，并进行异或运算，巧妙的实现tuple状态的维护。先看下图示例：</p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20151105/storm-ack.png" alt=""></p>
<p>在这个topology其中包含一个spout，3个bolt和一个acker bolt，紫色线表示tuple的流向，绿色线表示每个bolt处理完tuple后的ack/fail调用，红色线表示acker回调spout的ack/fail方法来标记root tuple处理完毕。</p>
<p>以下是storm的ack框架对tuple的处理状态维护过程说明：</p>
<p>第(1)(2)步，spout发送T1到bolt1，发送T2到bolt2，T1和T2具有相同的内容（可以认为都把spout的输出作为自己的输入）。每条消息都会有一个全局唯一id，T1的锚点为&lt;rootId,T1&gt;，T2的锚点为&lt;rootId,T2&gt;。</p>
<p>第(3)步，spout发送完毕T1、T2后，在acker中注册一条记录rootId=T1^T2。</p>
<p>第(4)(5)步，bolt1收到T1处理完毕后对T1进行ack并发送T3,T4到bolt3，所以在acker中注册T1,T3,T4，acker中的跟踪项变为rootId=T1<sup>T2</sup>T1<sup>T3</sup>T4=T2<sup>T3</sup>T4</p>
<p>第(6)(7)步，bolt2收到T2处理完毕后对T2进行ack并发送T5,T6,T7到bolt4，所以在acker中注册T2,T5,T6,T7，acker中的跟踪项变为rootId=T2<sup>T3</sup>T4<sup>T2</sup>T5<sup>T6</sup>T7=T3<sup>T4</sup>T5<sup>T6</sup>T7</p>
<p>第(8)步，bolt3收到T3,T4处理完毕后对T3,T4进行ack，没有输出新的tuple，所以在acker中注册T3,T4，acker中的跟踪项变为rootId=T3<sup>T4</sup>T5<sup>T6</sup>T7<sup>T3</sup>T4=T5<sup>T6</sup>T7</p>
<p>第(9)步，bolt4收到T5,T6,T7处理完毕后对T5,T6,T7进行ack，没有输出新的tuple，所以在acker中注册T5,T6,T7，acker中的跟踪项变为rootId=T5<sup>T6</sup>T7<sup>T5</sup>T6^T7=0</p>
<p>第(10)步，acker bolt发现rootId对应的追踪值为0，说明该rootId对应的源消息以及衍生出来的所有消息（bolt1,bolt2新输出的消息）都被成功处理完毕。于是acker bolt会回调spout的ack方法，标识消息rootId已被topology处理成功。</p>
]]></content>
      <categories>
        <category>Storm</category>
      </categories>
      <tags>
        <tag>storm</tag>
        <tag>实时计算</tag>
      </tags>
  </entry>
  <entry>
    <title>Understanding LLM based AI Agents</title>
    <url>/20250316/Understanding%20LLM%20based%20AI%20Agents/</url>
    <content><![CDATA[<h2 id="what-are-llm-based-ai-agents"><a class="markdownIt-Anchor" href="#what-are-llm-based-ai-agents"></a> What are LLM-based AI Agents?</h2>
<p>An LLM-based AI agent is an intelligent system that uses large language models (like GPT-4) to perform tasks autonomously, including <strong>perceiving the environment, reasoning about it, making decisions, and executing actions</strong>. Unlike traditional chatbots, these agents can plan tasks, take actions using external tools, and handle multi-step problems. It aims to enable people to perform and handle professional or complex tasks in a highly automated manner using natural language, driven by LLM technology, thereby freeing up personnel energy to the greatest extent.</p>
<h2 id="core-components-of-an-ai-agent"><a class="markdownIt-Anchor" href="#core-components-of-an-ai-agent"></a> Core Components of an AI Agent</h2>
<p>LLM-based agents usually rely on a modular architecture that gives the LLM the support it needs to operate autonomously. The typical agent is composed of a few key components.</p>
<pre><div class="mermaid">graph LR
U(User Request) --&gt;|input| A[Agent Core]
A --&gt;|analyse| B[Planning]
B --&gt;|action plan| A
A --&gt;|invoke| C[Tools]
A &lt;--&gt;|context| D[Memory]
A --&gt;|response| U</div></pre>
<ul>
<li><strong>Agent Core:</strong> At the heart of the agent is the LLM itself (for example, GPT-4, Claude, or an open-source model like LLaMA 2). This core interprets the user’s input and generates the agent’s responses. On its own, the LLM is very powerful at understanding language and reasoning, but it’s essentially reactive (it responds to prompts without taking additional actions). In an agent setup, the LLM core is augmented with surrounding logic so it can be more proactive, meaning it needs other components to interface with the outside world and handle complex tasks.</li>
</ul>
<span id="more"></span>
<ul>
<li>
<p><strong>Tools (Action Interfaces):</strong> Tools are how an LLM agent interacts with the world beyond its internal knowledge. A tool could be any external function or API the agent can call – for example, a web search engine, a database query, a code execution sandbox, a calculator, or a source code search function. Tools give the agent the ability to take actions like looking up information, running computations, or retrieving specific data​. In a software development context, useful tools might include:</p>
<ul>
<li>A code search tool to find snippets in a repository</li>
<li>A documentation lookup API to fetch reference docs</li>
<li>A ticket database query to pull related support tickets</li>
<li>or a shell command executor to run test cases</li>
</ul>
</li>
<li>
<p><strong>Memory:</strong> Memory provides the agent with the ability to remember information across multiple steps or interactions. There are typically two kinds of memory in such agents​.</p>
<ul>
<li><strong>Short-term memory</strong> – which keeps track of the agent’s recent “thoughts” and actions during the current task (often called the context or the transcript of the reasoning so far). This is like the agent’s scratchpad for one session – it might include what the agent has already tried and what it observed.</li>
<li><strong>Long-term memory</strong> – which persists information beyond a single session, allowing the agent to recall facts or past conversations from earlier. This could be implemented via a database or vector store that the agent queries as needed​.</li>
</ul>
</li>
<li>
<p><strong>Planning Module:</strong> This component is what makes an agent “agentic” – it allows the system to plan a multi-step strategy rather than just respond immediately. The planning module could be as simple as some prompt engineering that encourages the LLM to think step-by-step, or as elaborate as a separate algorithm or model that breaks tasks into sub-tasks. The idea is to enable task decomposition, decision-making, and iteration​. In practical, the planning does things like:</p>
<ol>
<li>Analyze the user’s request and break it into smaller problems if needed.</li>
<li>Decide which tool to use at each step.</li>
<li>Loop through actions and observations: the agent might use a tool, see the result, and then decide the next step based on that.</li>
</ol>
</li>
</ul>
<p>These components work together in a cycle. Typically, an agent loop might look like: the <strong>LLM core</strong> (with the planning prompt) decides on an <strong>Action</strong> (calls a Tool), the tool returns some data which is stored in <strong>Memory</strong> or fed back to the LLM, and the LLM then decides the <strong>next steps</strong> or gives the final answer. This continues until the agent is confident it has solved the user’s request.</p>
<p><img src="image1.png" alt=""></p>
]]></content>
      <tags>
        <tag>AI</tag>
        <tag>LLM</tag>
      </tags>
  </entry>
  <entry>
    <title>hadoop-yarn中ResourceManager的服务模块</title>
    <url>/20160606/hadoop-yarn%E4%B8%ADResourceManager%E7%9A%84%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%9D%97/</url>
    <content><![CDATA[<h2 id="yarn简述"><a class="markdownIt-Anchor" href="#yarn简述"></a> Yarn简述</h2>
<p>Hadoop2.0引入了yarn（Yet Another Resource Negotiator）资源管理框架。1.0中的MapReduce计算框架变为运行在yarn上的一种application。</p>
<p>Yarn依然采用了master/slave结构，master是ResourceManager，负责整个集群的资源管理和调度，并且支持HA，slave是NodeManager，负责管理各子节点上的资源和任务。每个MapReduce作业提交给ResourceManager并被接受后，ResourceManager会通知某个NodeManager启动一个ApplicationMaster管理此作业的生命周期。</p>
<h2 id="resourcemanager中的模块划分"><a class="markdownIt-Anchor" href="#resourcemanager中的模块划分"></a> ResourceManager中的模块划分</h2>
<p>Yarn中的大多数服务都是带状态的service实现，并通过事件驱动机制实现服务的状态转换和服务之间的交互。ResourceManager是yarn的核心组件，与NodeManager、ApplicationMaster、Client都有交互，提供了非常多的功能，下面基于hadoop2.7版本的实现，梳理一下ResourceManager中的重要service组件及其功能。</p>
<p>ResourceManager中按功能划分的service模块如下图所示。</p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20150606ResourceManager%E7%9A%84%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%9D%97/1.png" alt=""></p>
<p>ResourceManager中核心模块主要包括客户端交互模块、NodeManager管理模块、ApplicationMaster管理模块、Application管理模块、安全管理模块、以及资源管理模块（调度、预留）等。</p>
<h2 id="各模块中的服务介绍"><a class="markdownIt-Anchor" href="#各模块中的服务介绍"></a> 各模块中的服务介绍</h2>
<p><strong>客户端交互模块：</strong></p>
<ul>
<li>
<p>AdminService</p>
<ul>
<li>管理员可通过此接口管理集群，如更新节点、更新ACL、更新队列等。内部有个EmbeddedElectorService，如果RM启用了自动HA，则通过这个service做leader election。</li>
</ul>
</li>
<li>
<p>ClientRMService</p>
<ul>
<li>负责为客户端提供服务，是ApplicationClientProtocol协议的服务端。负责处理来自客户端的RPC请求，包括提交app、查询app运行状态、终止app等。</li>
</ul>
</li>
<li>
<p>Webapp</p>
<ul>
<li>提供web页面服务，展示集群状态和资源使用情况。</li>
</ul>
</li>
</ul>
<p><strong>NodeManager管理模块</strong></p>
<ul>
<li>
<p>NMLivelinessMonitor</p>
<ul>
<li>用于监控NM是否存活，若NM在一定时间内（默认10分钟）未上报心跳，则认为其挂了。</li>
</ul>
</li>
<li>
<p>NodesListManager</p>
<ul>
<li>负责维护节点列表，并动态加载白名单（yarn.resourcemanager.nodes.include-path）和黑名单（yarn.resourcemanager.nodes.exlude-path）节点。</li>
</ul>
</li>
<li>
<p>RMNodeLabelsManager</p>
<ul>
<li>负责节点的标签管理。</li>
</ul>
</li>
<li>
<p>ResourceTrackerService</p>
<ul>
<li>负责与NodeManager通信，处理来自NodeManager的请求，包括注册NodeManager和节点心跳两种。接口定义在ResourceTracker中。</li>
</ul>
</li>
</ul>
<p><strong>ApplicationMaster管理模块</strong></p>
<ul>
<li>
<p>AMLivelinessMonitor：两个实例</p>
<ul>
<li>用于监控ApplicationMaster是否正常，如果在指定时间内（默认10分钟）未收到AM的心跳，则认为其死掉了。</li>
</ul>
</li>
<li>
<p>ApplicationMasterLauncher</p>
<ul>
<li>负责通知某个NodeManager启动或销毁ApplicationMaster。在app请求被接受后，与某个NodeManager通信，告知其为此app启动相应的ApplicationMaster。若app运行结束或被kill，则通知app所在NodeManager销毁ApplicationMaster。其内部也维护了一个阻塞队列，并有一个后台线程异步处理提交进来的启动ApplicationMaster的请求。</li>
</ul>
</li>
<li>
<p>ApplicationMasterService</p>
<ul>
<li>负责与ApplicationMaster通信，是ApplicationMasterProtocol协议的服务端，ApplicationMaster在NodeManager上启动后通过此协议向ResourceManager注册自己，运行过程中向ResourceManager发送心跳，以及app运行结束后告知RM自己所在的container可以被释放了。</li>
</ul>
</li>
</ul>
<p><strong>Application管理模块</strong></p>
<ul>
<li>
<p>RMAppManager</p>
<ul>
<li>ResourceManager接受客户端提交的app后，会通过RMAppManager来触发启动app的事件RMAppEventType.START，具体启动app的工作由RMAppImpl实现。</li>
</ul>
</li>
<li>
<p>ApplicationACLsManager</p>
<ul>
<li>负责app权限控制，包括查看和修改权限。</li>
</ul>
</li>
<li>
<p>ContainerAllocationExpirer</p>
<ul>
<li>用于监听NodeManager上是否正常启动了分配给ApplicationMaster的container，若在指定时间未启动（默认10分钟），ResourceManager会强制回收该container。</li>
</ul>
</li>
<li>
<p>RMApplicationHistoryWriter</p>
<ul>
<li>负责异步持久化Application运行中的相关日志，主要是Container、Application、ApplicationAttempt在启动和结束时的日志信息。</li>
</ul>
</li>
</ul>
<p><strong>安全管理模块</strong></p>
<ul>
<li>RMSecretManagerService
<ul>
<li>负责管理各种通信密钥，包括：
<ul>
<li>RM与NM通信的NMTokenSecretManagerInRM</li>
<li>RM与container通信的RMContainerTokenSecretManager</li>
<li>客户端与AM通信的ClientToAMTokenSecretManagerInRM</li>
<li>AM与RM通信的AMRMTokenSecretManager</li>
<li>DelegationTokenRenewer</li>
<li>启用了安全时，负责定时更新认证token。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>资源管理模块</strong></p>
<ul>
<li>
<p>ResourceScheduler</p>
<ul>
<li>资源调度器，可通过yarn.resourcemanager.scheduler.class指定，ResourceManager默认使用的是org.apache.hadoop.yarn.server.resourcemanager.scheduler.capacity.CapacityScheduler。</li>
</ul>
</li>
<li>
<p>SchedulerEventDispatcher</p>
<ul>
<li>用于处理SchedulerEventType类型的事件，其内部维护了一个存储SchedulerEvent的阻塞队列，并由一个后台线程从队列中取出资源请求事件，再调用ResourceScheduler进行处理。</li>
</ul>
</li>
<li>
<p>ReservationSystem</p>
<ul>
<li>资源预留系统，对应的实现有CapacityReservationSystem和FairReservationSystem。</li>
</ul>
</li>
</ul>
<p>此外，SystemMetricsPublisher负责发布RM的系统统计信息。AsyncDispatcher是中央事件处理分发器，ResourceManager启动时，通过它绑定了几种类型的事件的处理器，包括SchedulerEventType、RMAppEventType、ApplicationAttempt、RMAppAttemptEventType、RMNodeEventType、RMAppManagerEventType、AMLaunchEventType等。</p>
<p>上述各service在ResourceManager中的启动顺序为：</p>
<ol>
<li>
<p>AsyncDispatcher</p>
</li>
<li>
<p>AdminService</p>
</li>
<li>
<p>RMActiveServices：是个CompositeService（即service列表，ResourceManager本身就是一个CompositeService），用于管理ResourceManager中的“活动”服务（必须在active的ResourceManager上启动的服务，启用HA时，备份ResourceManager上不启动这些服务），包括以下（按启动顺序）：</p>
<ul>
<li>
<p>RMSecretManagerService</p>
</li>
<li>
<p>ContainerAllocationExpirer</p>
</li>
<li>
<p>AMLivelinessMonitor</p>
</li>
<li>
<p>RMNodeLabelsManager</p>
</li>
<li>
<p>RMApplicationHistoryWriter</p>
</li>
<li>
<p>SystemMetricsPublisher</p>
</li>
<li>
<p>NodesListManager</p>
</li>
<li>
<p>ResourceScheduler</p>
</li>
<li>
<p>SchedulerEventDispatcher</p>
</li>
<li>
<p>NMLivelinessMonitor</p>
</li>
<li>
<p>ResourceTrackerService</p>
</li>
<li>
<p>ApplicationMasterService</p>
</li>
<li>
<p>ClientRMService</p>
</li>
<li>
<p>ApplicationMasterLauncher</p>
</li>
<li>
<p>DelegationTokenRenewer</p>
</li>
</ul>
</li>
</ol>
]]></content>
      <categories>
        <category>Hadoop</category>
      </categories>
      <tags>
        <tag>yarn</tag>
        <tag>hadoop</tag>
      </tags>
  </entry>
  <entry>
    <title>kafka-0.10.0启动过程分析</title>
    <url>/20170708/kafka-0-10-0%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<p>kafka-0.10.0是官方出的最新稳定版本，提供了大量新的feature，具体可见<span class="exturl" data-url="aHR0cDovL3d3dy5pdGVibG9nLmNvbS9hcmNoaXZlcy8xNjc3">这里<i class="fa fa-external-link-alt"></i></span>，本文主要分析kafka-0.10-0的源码结构和启动过程。</p>
<h2 id="源码结构"><a class="markdownIt-Anchor" href="#源码结构"></a> 源码结构</h2>
<p>kafka-0.10.0的源码可以从github上fork一份，在源码目录下执行./gradlew idea生成idea项目，然后导入idea即可。这中间需要使用gradle进行依赖包的下载，导入后可以看到其源码结构如下图所示：</p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20160708-kafka0.10.0%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/1.png" alt=""></p>
<p>包括几大重要模块：</p>
<ul>
<li>clients主要是kafka-client相关的代码，包括consumer、producer，还包括一些公共逻辑，如授权认证、序列化等。</li>
<li>connect主要是kafka-connect模块的代码逻辑，Kafka connect是0.9版本增加的特性,支持创建和管理数据流管道。通过它可以将大数据从其它系统导入到Kafka中，也可以从Kafka中导出到其它系统，比如数据库、elastic search等。</li>
<li>core模块是kafka的核心部分，主要包括broker的实现逻辑、producer和consumer的javaapi等。</li>
<li>streams模块主要是kafka-streaming的实现，提供了一整套描述常见流操作的高级语言API（比如 joining, filtering以及aggregation等），我们可以基于此开发流处理应用程序。</li>
</ul>
<span id="more"></span>
<h2 id="启动入口"><a class="markdownIt-Anchor" href="#启动入口"></a> 启动入口</h2>
<p>kafka的启动入口在core_main这个module下，入口函数如下：</p>
<figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = {</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      <span class="keyword">val</span> serverProps = getPropsFromArgs(args)</span><br><span class="line">      <span class="keyword">val</span> kafkaServerStartable = <span class="type">KafkaServerStartable</span>.fromProps(serverProps)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// attach shutdown handler to catch control-c</span></span><br><span class="line">      <span class="type">Runtime</span>.getRuntime().addShutdownHook(<span class="keyword">new</span> <span class="type">Thread</span>() {</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>() = {</span><br><span class="line">          kafkaServerStartable.shutdown</span><br><span class="line">        }</span><br><span class="line">      })</span><br><span class="line"></span><br><span class="line">      kafkaServerStartable.startup</span><br><span class="line">      kafkaServerStartable.awaitShutdown</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">catch</span> {</span><br><span class="line">      <span class="keyword">case</span> e: <span class="type">Throwable</span> =&gt;</span><br><span class="line">        fatal(e)</span><br><span class="line">        <span class="type">System</span>.exit(<span class="number">1</span>)</span><br><span class="line">    }</span><br><span class="line">    <span class="type">System</span>.exit(<span class="number">0</span>)</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure>
<p>先从命令行指定的配置文件加载配置，然后通过KafkaServerStartable类启动broker，实际上在KafkaServerStartable中维护了一个KafkaServer对象，它通过调用KafkaServer的startup方法启动broker。</p>
<h2 id="broker启动过程"><a class="markdownIt-Anchor" href="#broker启动过程"></a> broker启动过程</h2>
<p>下面并启动过程代码按启动顺序分两部分做说明。</p>
<p>第一部分主要是核心模块的启动，代码如下：</p>
<figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line">metrics = <span class="keyword">new</span> <span class="type">Metrics</span>(metricConfig, reporters, kafkaMetricsTime, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">        brokerState.newState(<span class="type">Starting</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* start scheduler */</span></span><br><span class="line">        kafkaScheduler.startup()</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* setup zookeeper */</span></span><br><span class="line">        zkUtils = initZk()</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* start log manager */</span></span><br><span class="line">        logManager = createLogManager(zkUtils.zkClient, brokerState)</span><br><span class="line">        logManager.startup()</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* generate brokerId */</span></span><br><span class="line">        config.brokerId =  getBrokerId</span><br><span class="line">        <span class="keyword">this</span>.logIdent = <span class="string">"[Kafka Server "</span> + config.brokerId + <span class="string">"], "</span></span><br><span class="line"></span><br><span class="line">        socketServer = <span class="keyword">new</span> <span class="type">SocketServer</span>(config, metrics, kafkaMetricsTime)</span><br><span class="line">        socketServer.startup()</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* start replica manager */</span></span><br><span class="line">        replicaManager = <span class="keyword">new</span> <span class="type">ReplicaManager</span>(config, metrics, time, kafkaMetricsTime, zkUtils, kafkaScheduler, logManager,</span><br><span class="line">          isShuttingDown)</span><br><span class="line">        replicaManager.startup()</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* start kafka controller */</span></span><br><span class="line">        kafkaController = <span class="keyword">new</span> <span class="type">KafkaController</span>(config, zkUtils, brokerState, kafkaMetricsTime, metrics, threadNamePrefix)</span><br><span class="line">        kafkaController.startup()</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* start group coordinator */</span></span><br><span class="line">        groupCoordinator = <span class="type">GroupCoordinator</span>(config, zkUtils, replicaManager, kafkaMetricsTime)</span><br><span class="line">        groupCoordinator.startup()</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Get the authorizer and initialize it if one is specified.*/</span></span><br><span class="line">        authorizer = <span class="type">Option</span>(config.authorizerClassName).filter(_.nonEmpty).map { authorizerClassName =&gt;</span><br><span class="line">          <span class="keyword">val</span> authZ = <span class="type">CoreUtils</span>.createObject[<span class="type">Authorizer</span>](authorizerClassName)</span><br><span class="line">          authZ.configure(config.originals())</span><br><span class="line">          authZ</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* start processing requests */</span></span><br><span class="line">        apis = <span class="keyword">new</span> <span class="type">KafkaApis</span>(socketServer.requestChannel, replicaManager, groupCoordinator,</span><br><span class="line">          kafkaController, zkUtils, config.brokerId, config, metadataCache, metrics, authorizer)</span><br><span class="line">        requestHandlerPool = <span class="keyword">new</span> <span class="type">KafkaRequestHandlerPool</span>(config.brokerId, socketServer.requestChannel, apis, config.numIoThreads)</span><br><span class="line">        brokerState.newState(<span class="type">RunningAsBroker</span>)</span><br></pre></td></tr></tbody></table></figure>
<ol>
<li>首先是初始化Metrics注册信息。</li>
<li>接着把当前broker的状态先置为Starting。</li>
<li>启动kafkaScheduler，其内部维护了一个ScheduledThreadPoolExecutor，用于执行broker内置的一些周期性运行的job或定时job。比如，启动自动提交时，broker会定期维护客户端的消费topic-partition的offset信息。</li>
<li>初始化zookeeper访问工具，建立必要的数据路径。</li>
<li>启动LogManager，也就是日志数据管理子系统，负责日志数据的创建、截断、滚动、和清理等。</li>
<li>启动SocketServer，一个基于NIO的socker服务端，其线程模型是有一个acceptor线程来接受客户端的连接，对应这个acceptor有N个processor线程，每个processor有自己的selector来从sockets读取收到的请求。另外，有M个handler线程专门处理请求并把处理结果返回给processor线程并通过socket写回给客户端。</li>
<li>启动ReplicaManager，也即副本管理器，用于管理每个topic-partition的副本状态，包括主从、ISR列表等。</li>
<li>启动KafkaController，可以理解为kafka集群的中央控制器，负责全局的协调，比如选取leader，reassignment等，其自身也支持动态选举高可用。</li>
<li>启动GroupCoordinator，主要用于broker组管理和offset管理。</li>
<li>初始化授权认证管理器，用户可以自己通过参数authorizer.class.name指定具体的Authorizer实现。kafka自带有SimpleAclAuthorizer的简单实现。</li>
<li>初始化KafkaApis，用于统一接收外部请求。</li>
<li>初始化KafkaRequestHandlerPool，内部是一个线程池，用于具体处理外部请求。</li>
<li>将当前broker的状态置为RunningAsBroker，这时，broker已经可以对外提供服务了。</li>
</ol>
<p>第二部分主要是辅助模块的启动，代码如下：</p>
<figure class="highlight scala"><table><tbody><tr><td class="code"><pre><span class="line"><span class="type">Mx4jLoader</span>.maybeLoad()</span><br><span class="line"></span><br><span class="line"><span class="comment">/* start dynamic config manager */</span></span><br><span class="line">dynamicConfigHandlers = <span class="type">Map</span>[<span class="type">String</span>, <span class="type">ConfigHandler</span>](<span class="type">ConfigType</span>.<span class="type">Topic</span> -&gt; <span class="keyword">new</span> <span class="type">TopicConfigHandler</span>(logManager, config),</span><br><span class="line">                                                   <span class="type">ConfigType</span>.<span class="type">Client</span> -&gt; <span class="keyword">new</span> <span class="type">ClientIdConfigHandler</span>(apis.quotaManagers))</span><br><span class="line"></span><br><span class="line"><span class="comment">// Apply all existing client configs to the ClientIdConfigHandler to bootstrap the overrides</span></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> Move this logic to DynamicConfigManager</span></span><br><span class="line"><span class="type">AdminUtils</span>.fetchAllEntityConfigs(zkUtils, <span class="type">ConfigType</span>.<span class="type">Client</span>).foreach {</span><br><span class="line">  <span class="keyword">case</span> (clientId, properties) =&gt; dynamicConfigHandlers(<span class="type">ConfigType</span>.<span class="type">Client</span>).processConfigChanges(clientId, properties)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create the config manager. start listening to notifications</span></span><br><span class="line">dynamicConfigManager = <span class="keyword">new</span> <span class="type">DynamicConfigManager</span>(zkUtils, dynamicConfigHandlers)</span><br><span class="line">dynamicConfigManager.startup()</span><br><span class="line"></span><br><span class="line"><span class="comment">/* tell everyone we are alive */</span></span><br><span class="line"><span class="keyword">val</span> listeners = config.advertisedListeners.map {<span class="keyword">case</span>(protocol, endpoint) =&gt;</span><br><span class="line">  <span class="keyword">if</span> (endpoint.port == <span class="number">0</span>)</span><br><span class="line">    (protocol, <span class="type">EndPoint</span>(endpoint.host, socketServer.boundPort(protocol), endpoint.protocolType))</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    (protocol, endpoint)</span><br><span class="line">}</span><br><span class="line">kafkaHealthcheck = <span class="keyword">new</span> <span class="type">KafkaHealthcheck</span>(config.brokerId, listeners, zkUtils, config.rack,</span><br><span class="line">  config.interBrokerProtocolVersion)</span><br><span class="line">kafkaHealthcheck.startup()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Now that the broker id is successfully registered via KafkaHealthcheck, checkpoint it</span></span><br><span class="line">checkpointBrokerId(config.brokerId)</span><br><span class="line"></span><br><span class="line"><span class="comment">/* register broker metrics */</span></span><br><span class="line">registerStats()</span><br><span class="line"></span><br><span class="line">shutdownLatch = <span class="keyword">new</span> <span class="type">CountDownLatch</span>(<span class="number">1</span>)</span><br><span class="line">startupComplete.set(<span class="literal">true</span>)</span><br><span class="line">isStartingUp.set(<span class="literal">false</span>)</span><br><span class="line"><span class="type">AppInfoParser</span>.registerAppInfo(jmxPrefix, config.brokerId.toString)</span><br><span class="line">info(<span class="string">"started"</span>)</span><br></pre></td></tr></tbody></table></figure>
<ol>
<li>启动jmx，通过参数kafka_mx4jenable控制是否启用jmx，默认为false。</li>
<li>初始化TopicConfigHandler和ClientIdConfigHandler，前者用于处理zk上的topic配置变更信息，后者用于zk上的clientId配置变更信息。</li>
<li>启动DynamicConfigManager，通过动态配置管理器，监听zk上的配置节点变化，并根据具体变化的配置信息调用TopicConfigHandler或ClientIdConfigHandler更新配置。</li>
<li>启动KafkaHealthcheck，用于在zk上注册当前broker节点信息，以便节点退出时其他broker和consumer能监听到，目前的节点健康度判断比较简单，只是单纯的看zk上的节点是否存在。</li>
<li>最后，在本地对当前broker做个checkpoint，并注册jmx bean信息</li>
</ol>
]]></content>
      <categories>
        <category>Kafka</category>
      </categories>
      <tags>
        <tag>kafka</tag>
        <tag>源码分析</tag>
      </tags>
  </entry>
  <entry>
    <title>redis服务端连接断开问题诊断</title>
    <url>/20150601/redis%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%BF%9E%E6%8E%A5%E6%96%AD%E5%BC%80%E9%97%AE%E9%A2%98%E8%AF%8A%E6%96%AD/</url>
    <content><![CDATA[<h2 id="问题现象"><a class="markdownIt-Anchor" href="#问题现象"></a> 问题现象</h2>
<p>前段时间，由于线上redis服务器的内存使用率达到了机器总内存的50%以上，导致内存数据的dump持久化一直失败。扩展到多台redis后，应用系统访问redis时，在业务量较少时，时不时会出现以下异常，当业务量较大，redis访问频率很高时，却不会发生这个异常，一时觉得很诡异。</p>
<blockquote>
<p>redis.clients.jedis.exceptions.JedisConnectionException: It seems like server has closed the connection.<br>
at redis.clients.util.RedisInputStream.readLine(RedisInputStream.java:90) ~[jedis-2.1.0.jar:na]<br>
at redis.clients.jedis.Protocol.processInteger(Protocol.java:110) ~[jedis-2.1.0.jar:na]<br>
at redis.clients.jedis.Protocol.process(Protocol.java:70) ~[jedis-2.1.0.jar:na]<br>
at redis.clients.jedis.Protocol.read(Protocol.java:131) ~[jedis-2.1.0.jar:na]<br>
at redis.clients.jedis.Connection.getIntegerReply(Connection.java:188) ~[jedis-2.1.0.jar:na]<br>
at redis.clients.jedis.Jedis.sismember(Jedis.java:1266) ~[jedis-2.1.0.jar:na]</p>
</blockquote>
<p>看提示，应该是服务端主动关闭了连接。查看了新上线的redis服务器的配置，有这么一项：</p>
<blockquote>
<p># Close the connection after a client is idle for N seconds (0 to disable)<br>
timeout 120</p>
</blockquote>
<p>这项配置指的是客户端连接空闲超过多少秒后，服务端主动关闭连接，默认值0表示服务端永远不主动关闭。而op人员把服务器端的超时时间设置为了120秒。</p>
<p>这就解释了发生这个异常的原因。客户端使用了一个连接池管理访问redis的所有连接，这些连接是长连接，当业务量较小时，客户端部分连接使用率较低，当两次使用之间的间隔超过120秒时，redis服务端就主动关闭了这个连接，而等客户端下次再使用这个连接对象时，发现服务端已经关闭了连接，进而报错。</p>
<p>于是，再查看访问redis的系统（客户端）的配置：</p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20140601-redis%E8%BF%9E%E6%8E%A5%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/1.png" alt=""></p>
<p>客户端使用的是jedis内置的连接池，看其源码本质上是基于apache commons-pool实现的，其中有一个eviction线程，用于回收idle对象，对于redis连接池来说，也就是回收空闲连接。</p>
<p>JedisPoolConfig类继承自GenericObjectPoolConfig并覆盖了几项关于eviction线程的配置，具体如下：</p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20140601-redis%E8%BF%9E%E6%8E%A5%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/2.png" alt=""></p>
<p><em><font color="red">_timeBetweenEvictionRunsMillis</font></em>：eviction线程的运行周期。默认是-1，表示不启动eviction线程。这里设置为30秒。</p>
<p><em><font color="red">_minEvictableIdleTimeMillis</font></em>：对象处于idle状态的最长时间，默认是30分钟，这里设置为60秒。</p>
<p>通过客户端的默认配置看，对象的最大空闲时长是小于服务端的配置的，应该不是配置上的问题了。</p>
<p>于是，继续看是不是客户端代码使用上的问题。追踪到客户端代码如下：</p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20140601-redis%E8%BF%9E%E6%8E%A5%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/3.png" alt=""></p>
<p>可见，客户端首先尝试从本线程的ThreadLocal对象中获取jedis对象，若获取不到，再从masterJedisPool中取得jedis对象并放入ThreadLocal对象以便下次使用，并且jedis对象使用完毕后，没有从ThreadLocal中清除，也没有returnResource给masterJedisPool。</p>
<p>因此，问题产生的原因就在于此。ThreadLocal中的这个jedis对象被取出后没有return，对于对象池来说是处于非idle状态，因此不会被对象池evict。<font color="red">当业务量大时，这个jedis会被频繁使用，服务端认为这个jedis对应的连接是非空闲的，或者空闲时间达不到120秒，不会主动关闭，所以没什么问题。然而当业务量小时，这个jedis使用频率很低，当两次之间的使用间隔超出120秒时，服务端会主动把这个jedis的连接关闭，第二次调用时，就会出现上面的报错。</font></p>
<p>从代码开发者的角度来说，这么做的目的是避免频繁从pool中获取jedis对象和return jedis对象以提高性能。</p>
<p>解决方案有两个：</p>
<ol>
<li>
<p>在redis-cli下在线修改redis 的配置，把timeout改回为0，无需重启redis即可直接生效，但redis若重启，配置会恢复。</p>
</li>
<li>
<p>修改客户端代码，使用完jedis对象后，从ThreadLocal中清除，再返回给连接池。</p>
</li>
</ol>
<p>出于改动成本考虑，先采用了第一种方案，在线修改redis配置后，报错不再出现。</p>
]]></content>
      <categories>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>redis</tag>
        <tag>连接断开</tag>
      </tags>
  </entry>
  <entry>
    <title>Storm源码编译及本地调试方法</title>
    <url>/20160713/storm%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%E5%8F%8A%E6%9C%AC%E5%9C%B0%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<h2 id="基础环境"><a class="markdownIt-Anchor" href="#基础环境"></a> 基础环境</h2>
<ul>
<li>IDE开发环境：intelliJIdea</li>
<li>JDK1.7  64bit</li>
<li>intelliJIdea安装maven插件，配置好仓库源</li>
<li>intelliJIdea安装clojure插件Cursive（需要注册并获取一个license，否则只能使用30天）</li>
<li>如果需要自己创建clojure项目进行开发，需要安装leiningen，<span class="exturl" data-url="aHR0cDovL2xlaW5pbmdlbi5vcmcv">下载地址<i class="fa fa-external-link-alt"></i></span></li>
</ul>
<h2 id="源码获取"><a class="markdownIt-Anchor" href="#源码获取"></a> 源码获取</h2>
<p>从github checkout代码到本地即可，<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FwYWNoZS9zdG9ybS5naXQ=">https://github.com/apache/storm.git<i class="fa fa-external-link-alt"></i></span></p>
<p>我这里编译的是我们目前正在用的0.10.0版本的代码。</p>
<h2 id="导入idea及编译"><a class="markdownIt-Anchor" href="#导入idea及编译"></a> 导入idea及编译</h2>
<p>打开idea，新建project，从源码导入，如下：</p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20160713-storm%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%E5%8F%8A%E8%B0%83%E8%AF%95/1.png" alt=""></p>
<p>导入后，idea会自动根据pom.xml下载相关依赖包，部分依赖包如果下载不到，需要手动添加。完成后，可以看到project的module如下图所示：</p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20160713-storm%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%E5%8F%8A%E8%B0%83%E8%AF%95/2.png" alt=""></p>
<span id="more"></span>
<p>这时候，通过idea就可以直接跟踪看源码了，但直接运行storm-starter中的例子还是会报错并提示有些类找不到，经查看是clojure的代码还未编译出class文件。可以在源码目录下执行mvn compile进行编译。</p>
<h2 id="使用idea调试源码"><a class="markdownIt-Anchor" href="#使用idea调试源码"></a> 使用idea调试源码</h2>
<p>编译完成后，可以直接启动storm-starter中的例子运行。期间可能出现找不到类，检查classpath，依赖包的scope由provided改为compile。</p>
<p>在源代码中加断点，run或者debug即可。</p>
<figure class="highlight stylus"><table><tbody><tr><td class="code"><pre><span class="line">&gt; <span class="number">2739</span> <span class="selector-attr">[main]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.u</span><span class="selector-class">.Utils</span> - Using defaults<span class="selector-class">.yaml</span> from resources</span><br><span class="line">&gt; <span class="number">4546</span> <span class="selector-attr">[main]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.u</span><span class="selector-class">.Utils</span> - Using defaults<span class="selector-class">.yaml</span> from resources</span><br><span class="line">&gt; <span class="number">5218</span> <span class="selector-attr">[main]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.zookeeper</span> - Starting inprocess zookeeper at port <span class="number">2000</span> and dir /var/folders/c0/<span class="number">0</span>bgvmbb10jz1609_1xjqdsj00000gn/T<span class="comment">//eeb57be9-5478-4fa9-ab31-6dfce38e7695</span></span><br><span class="line">&gt; <span class="number">5243</span> <span class="selector-attr">[main]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.u</span><span class="selector-class">.Utils</span> - Using defaults<span class="selector-class">.yaml</span> from resources</span><br><span class="line">&gt; <span class="number">5340</span> <span class="selector-attr">[main]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.nimbus</span> - Starting Nimbus with conf {<span class="string">"topology.builtin.metrics.bucket.size.secs"</span> <span class="number">60</span>, ......</span><br><span class="line">&gt; <span class="number">5342</span> <span class="selector-attr">[main]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.nimbus</span> - Using default scheduler</span><br><span class="line">&gt; <span class="number">5360</span> <span class="selector-attr">[main]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.u</span><span class="selector-class">.StormBoundedExponentialBackoffRetry</span> - The baseSleepTimeMs <span class="selector-attr">[1000]</span> the maxSleepTimeMs <span class="selector-attr">[30000]</span> the maxRetries <span class="selector-attr">[5]</span></span><br><span class="line">&gt; <span class="number">5457</span> <span class="selector-attr">[main]</span> INFO  o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.f</span><span class="selector-class">.i</span><span class="selector-class">.CuratorFrameworkImpl</span> - Starting</span><br><span class="line">&gt; <span class="number">5529</span> <span class="selector-attr">[main-EventThread]</span> INFO  o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.f</span><span class="selector-class">.s</span><span class="selector-class">.ConnectionStateManager</span> - State change: CONNECTED</span><br><span class="line">&gt; <span class="number">5531</span> <span class="selector-attr">[main-EventThread]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.zookeeper</span> - Zookeeper state update: :connected:<span class="attribute">none</span></span><br><span class="line">&gt; <span class="number">6569</span> <span class="selector-attr">[main]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.u</span><span class="selector-class">.StormBoundedExponentialBackoffRetry</span> - The baseSleepTimeMs <span class="selector-attr">[1000]</span> the maxSleepTimeMs <span class="selector-attr">[30000]</span> the maxRetries <span class="selector-attr">[5]</span></span><br><span class="line">&gt; <span class="number">6569</span> <span class="selector-attr">[main]</span> INFO  o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.f</span><span class="selector-class">.i</span><span class="selector-class">.CuratorFrameworkImpl</span> - Starting</span><br><span class="line">&gt; <span class="number">6574</span> <span class="selector-attr">[main-EventThread]</span> INFO  o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.f</span><span class="selector-class">.s</span><span class="selector-class">.ConnectionStateManager</span> - State change: CONNECTED</span><br><span class="line">&gt; <span class="number">6605</span> <span class="selector-attr">[main]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.u</span><span class="selector-class">.StormBoundedExponentialBackoffRetry</span> - The baseSleepTimeMs <span class="selector-attr">[1000]</span> the maxSleepTimeMs <span class="selector-attr">[30000]</span> the maxRetries <span class="selector-attr">[5]</span></span><br><span class="line">&gt; <span class="number">6605</span> <span class="selector-attr">[main]</span> INFO  o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.f</span><span class="selector-class">.i</span><span class="selector-class">.CuratorFrameworkImpl</span> - Starting</span><br><span class="line">&gt; <span class="number">6609</span> <span class="selector-attr">[main-EventThread]</span> INFO  o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.f</span><span class="selector-class">.s</span><span class="selector-class">.ConnectionStateManager</span> - State change: CONNECTED</span><br><span class="line">&gt; <span class="number">6609</span> <span class="selector-attr">[main-EventThread]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.zookeeper</span> - Zookeeper state update: :connected:<span class="attribute">none</span></span><br><span class="line">&gt; <span class="number">6617</span> <span class="selector-attr">[main]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.u</span><span class="selector-class">.StormBoundedExponentialBackoffRetry</span> - The baseSleepTimeMs <span class="selector-attr">[1000]</span> the maxSleepTimeMs <span class="selector-attr">[30000]</span> the maxRetries <span class="selector-attr">[5]</span></span><br><span class="line">&gt; <span class="number">6618</span> <span class="selector-attr">[main]</span> INFO  o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.f</span><span class="selector-class">.i</span><span class="selector-class">.CuratorFrameworkImpl</span> - Starting</span><br><span class="line">&gt; <span class="number">6620</span> <span class="selector-attr">[main]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.u</span><span class="selector-class">.StormBoundedExponentialBackoffRetry</span> - The baseSleepTimeMs <span class="selector-attr">[1000]</span> the maxSleepTimeMs <span class="selector-attr">[30000]</span> the maxRetries <span class="selector-attr">[5]</span></span><br><span class="line">&gt; <span class="number">6621</span> <span class="selector-attr">[main]</span> INFO  o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.f</span><span class="selector-class">.i</span><span class="selector-class">.CuratorFrameworkImpl</span> - Starting</span><br><span class="line">&gt; <span class="number">6623</span> <span class="selector-attr">[main-EventThread]</span> INFO  o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.f</span><span class="selector-class">.s</span><span class="selector-class">.ConnectionStateManager</span> - State change: CONNECTED</span><br><span class="line">&gt; <span class="number">6625</span> <span class="selector-attr">[main-EventThread]</span> INFO  o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.f</span><span class="selector-class">.s</span><span class="selector-class">.ConnectionStateManager</span> - State change: CONNECTED</span><br><span class="line">&gt; <span class="number">6649</span> <span class="selector-attr">[main-EventThread]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.zookeeper</span> - Zookeeper state update: :connected:<span class="attribute">none</span></span><br><span class="line">&gt; <span class="number">6652</span> <span class="selector-attr">[main]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.u</span><span class="selector-class">.StormBoundedExponentialBackoffRetry</span> - The baseSleepTimeMs <span class="selector-attr">[1000]</span> the maxSleepTimeMs <span class="selector-attr">[30000]</span> the maxRetries <span class="selector-attr">[5]</span></span><br><span class="line">&gt; <span class="number">6653</span> <span class="selector-attr">[main]</span> INFO  o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.f</span><span class="selector-class">.i</span><span class="selector-class">.CuratorFrameworkImpl</span> - Starting</span><br><span class="line">&gt; <span class="number">6657</span> <span class="selector-attr">[main-EventThread]</span> INFO  o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.f</span><span class="selector-class">.s</span><span class="selector-class">.ConnectionStateManager</span> - State change: CONNECTED</span><br><span class="line">&gt; <span class="number">6671</span> <span class="selector-attr">[main]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.supervisor</span> - Starting Supervisor with conf {<span class="string">"topology.builtin.metrics.bucket.size.secs"</span> <span class="number">60</span>, ......</span><br><span class="line">&gt; <span class="number">6693</span> <span class="selector-attr">[main]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.u</span><span class="selector-class">.StormBoundedExponentialBackoffRetry</span> - The baseSleepTimeMs <span class="selector-attr">[1000]</span> the maxSleepTimeMs <span class="selector-attr">[30000]</span> the maxRetries <span class="selector-attr">[5]</span></span><br><span class="line">&gt; <span class="number">6694</span> <span class="selector-attr">[main]</span> INFO  o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.f</span><span class="selector-class">.i</span><span class="selector-class">.CuratorFrameworkImpl</span> - Starting</span><br><span class="line">&gt; <span class="number">6697</span> <span class="selector-attr">[main-EventThread]</span> INFO  o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.f</span><span class="selector-class">.s</span><span class="selector-class">.ConnectionStateManager</span> - State change: CONNECTED</span><br><span class="line">&gt; <span class="number">6697</span> <span class="selector-attr">[main-EventThread]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.zookeeper</span> - Zookeeper state update: :connected:<span class="attribute">none</span></span><br><span class="line">&gt; <span class="number">6700</span> <span class="selector-attr">[main]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.u</span><span class="selector-class">.StormBoundedExponentialBackoffRetry</span> - The baseSleepTimeMs <span class="selector-attr">[1000]</span> the maxSleepTimeMs <span class="selector-attr">[30000]</span> the maxRetries <span class="selector-attr">[5]</span></span><br><span class="line">&gt; <span class="number">6701</span> <span class="selector-attr">[main]</span> INFO  o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.f</span><span class="selector-class">.i</span><span class="selector-class">.CuratorFrameworkImpl</span> - Starting</span><br><span class="line">&gt; <span class="number">6704</span> <span class="selector-attr">[main-EventThread]</span> INFO  o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.f</span><span class="selector-class">.s</span><span class="selector-class">.ConnectionStateManager</span> - State change: CONNECTED</span><br><span class="line">&gt; <span class="number">6722</span> <span class="selector-attr">[main]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.supervisor</span> - Starting supervisor with id <span class="number">913</span>c90f6-<span class="number">3</span>f78-<span class="number">4646</span>-<span class="number">8998</span>-aa901ae3c360 at host localhost</span><br><span class="line">&gt; <span class="number">6725</span> <span class="selector-attr">[main]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.supervisor</span> - Starting Supervisor with conf {<span class="string">"topology.builtin.metrics.bucket.size.secs"</span> <span class="number">60</span>, .....</span><br><span class="line">&gt; <span class="number">6732</span> <span class="selector-attr">[main]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.u</span><span class="selector-class">.StormBoundedExponentialBackoffRetry</span> - The baseSleepTimeMs <span class="selector-attr">[1000]</span> the maxSleepTimeMs <span class="selector-attr">[30000]</span> the maxRetries <span class="selector-attr">[5]</span></span><br><span class="line">&gt; <span class="number">6732</span> <span class="selector-attr">[main]</span> INFO  o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.f</span><span class="selector-class">.i</span><span class="selector-class">.CuratorFrameworkImpl</span> - Starting</span><br><span class="line">&gt; <span class="number">6736</span> <span class="selector-attr">[main-EventThread]</span> INFO  o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.f</span><span class="selector-class">.s</span><span class="selector-class">.ConnectionStateManager</span> - State change: CONNECTED</span><br><span class="line">&gt; <span class="number">6736</span> <span class="selector-attr">[main-EventThread]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.zookeeper</span> - Zookeeper state update: :connected:<span class="attribute">none</span></span><br><span class="line">&gt; <span class="number">6740</span> <span class="selector-attr">[main]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.u</span><span class="selector-class">.StormBoundedExponentialBackoffRetry</span> - The baseSleepTimeMs <span class="selector-attr">[1000]</span> the maxSleepTimeMs <span class="selector-attr">[30000]</span> the maxRetries <span class="selector-attr">[5]</span></span><br><span class="line">&gt; <span class="number">6741</span> <span class="selector-attr">[main]</span> INFO  o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.f</span><span class="selector-class">.i</span><span class="selector-class">.CuratorFrameworkImpl</span> - Starting</span><br><span class="line">&gt; <span class="number">6744</span> <span class="selector-attr">[main-EventThread]</span> INFO  o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.f</span><span class="selector-class">.s</span><span class="selector-class">.ConnectionStateManager</span> - State change: CONNECTED</span><br><span class="line">&gt; <span class="number">6753</span> <span class="selector-attr">[main]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.supervisor</span> - Starting supervisor with id <span class="number">49</span>c35a73-<span class="number">7500</span>-<span class="number">4</span>ea4-aaa2-<span class="number">4</span>b1c1f231fd4 at host localhost</span><br><span class="line">&gt; <span class="number">7035</span> <span class="selector-attr">[main]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.nimbus</span> - <span class="selector-attr">[req 1]</span> Access from:  principal: op:submitTopology</span><br><span class="line">&gt; <span class="number">7113</span> <span class="selector-attr">[main]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.nimbus</span> - Received topology submission <span class="keyword">for</span> wordCounter with conf {<span class="string">"topology.max.task.parallelism"</span> nil, <span class="string">"topology.submitter.principal"</span> <span class="string">""</span>, <span class="string">"topology.acker.executors"</span> nil, <span class="string">"topology.max.spout.pending"</span> <span class="number">20</span>, <span class="string">"storm.zookeeper.superACL"</span> nil, <span class="string">"topology.users"</span> (), <span class="string">"topology.submitter.user"</span> <span class="string">""</span>, <span class="string">"topology.kryo.register"</span> {<span class="string">"storm.trident.topology.TransactionAttempt"</span> nil, <span class="string">"storm.trident.spout.RichSpoutBatchId"</span> <span class="string">"storm.trident.spout.RichSpoutBatchIdSerializer"</span>}, <span class="string">"topology.kryo.decorators"</span> (), <span class="string">"storm.id"</span> <span class="string">"wordCounter-1-1468420782"</span>, <span class="string">"topology.name"</span> <span class="string">"wordCounter"</span>}</span><br><span class="line">&gt; <span class="number">7123</span> <span class="selector-attr">[main]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.nimbus</span> - nimbus file location:/var/folders/c0/<span class="number">0</span>bgvmbb10jz1609_1xjqdsj00000gn/T<span class="comment">//333ed6da-9ef5-4781-bd82-4f315facd4a8/nimbus/stormdist/wordCounter-1-1468420782</span></span><br><span class="line">&gt; <span class="number">7152</span> <span class="selector-attr">[main]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.nimbus</span> - Activating wordCounter: wordCounter-<span class="number">1</span>-<span class="number">1468420782</span></span><br><span class="line">&gt; <span class="number">7346</span> <span class="selector-attr">[main]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.s</span><span class="selector-class">.EvenScheduler</span> - Available slots: (<span class="selector-attr">[<span class="string">"49c35a73-7500-4ea4-aaa2-4b1c1f231fd4"</span> 1027]</span> <span class="selector-attr">[<span class="string">"49c35a73-7500-4ea4-aaa2-4b1c1f231fd4"</span> 1028]</span> <span class="selector-attr">[<span class="string">"49c35a73-7500-4ea4-aaa2-4b1c1f231fd4"</span> 1029]</span> <span class="selector-attr">[<span class="string">"913c90f6-3f78-4646-8998-aa901ae3c360"</span> 1024]</span> <span class="selector-attr">[<span class="string">"913c90f6-3f78-4646-8998-aa901ae3c360"</span> 1025]</span> <span class="selector-attr">[<span class="string">"913c90f6-3f78-4646-8998-aa901ae3c360"</span> 1026]</span>)</span><br><span class="line">&gt; <span class="number">7398</span> <span class="selector-attr">[main]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.nimbus</span> - Setting new assignment <span class="keyword">for</span> topology id wordCounter-<span class="number">1</span>-<span class="number">1468420782</span>: <span class="selector-id">#backtype</span><span class="selector-class">.storm</span><span class="selector-class">.daemon</span><span class="selector-class">.common</span>.Assignment{:master-code-dir <span class="string">"/var/folders/c0/0bgvmbb10jz1609_1xjqdsj00000gn/T//333ed6da-9ef5-4781-bd82-4f315facd4a8/nimbus/stormdist/wordCounter-1-1468420782"</span>, :node-&gt;host {<span class="string">"49c35a73-7500-4ea4-aaa2-4b1c1f231fd4"</span> <span class="string">"localhost"</span>}, :executor-&gt;node+port {<span class="selector-attr">[8 8]</span> <span class="selector-attr">[<span class="string">"49c35a73-7500-4ea4-aaa2-4b1c1f231fd4"</span> 1027]</span>, <span class="selector-attr">[12 12]</span> <span class="selector-attr">[<span class="string">"49c35a73-7500-4ea4-aaa2-4b1c1f231fd4"</span> 1027]</span>, <span class="selector-attr">[2 2]</span> <span class="selector-attr">[<span class="string">"49c35a73-7500-4ea4-aaa2-4b1c1f231fd4"</span> 1027]</span>, <span class="selector-attr">[7 7]</span> <span class="selector-attr">[<span class="string">"49c35a73-7500-4ea4-aaa2-4b1c1f231fd4"</span> 1027]</span>, <span class="selector-attr">[22 22]</span> <span class="selector-attr">[<span class="string">"49c35a73-7500-4ea4-aaa2-4b1c1f231fd4"</span> 1027]</span>, <span class="selector-attr">[3 3]</span> <span class="selector-attr">[<span class="string">"49c35a73-7500-4ea4-aaa2-4b1c1f231fd4"</span> 1027]</span>, <span class="selector-attr">[24 24]</span> <span class="selector-attr">[<span class="string">"49c35a73-7500-4ea4-aaa2-4b1c1f231fd4"</span> 1027]</span>, <span class="selector-attr">[1 1]</span> <span class="selector-attr">[<span class="string">"49c35a73-7500-4ea4-aaa2-4b1c1f231fd4"</span> 1027]</span>, <span class="selector-attr">[18 18]</span> <span class="selector-attr">[<span class="string">"49c35a73-7500-4ea4-aaa2-4b1c1f231fd4"</span> 1027]</span>, <span class="selector-attr">[6 6]</span> <span class="selector-attr">[<span class="string">"49c35a73-7500-4ea4-aaa2-4b1c1f231fd4"</span> 1027]</span>, <span class="selector-attr">[20 20]</span> <span class="selector-attr">[<span class="string">"49c35a73-7500-4ea4-aaa2-4b1c1f231fd4"</span> 1027]</span>, <span class="selector-attr">[9 9]</span> <span class="selector-attr">[<span class="string">"49c35a73-7500-4ea4-aaa2-4b1c1f231fd4"</span> 1027]</span>, <span class="selector-attr">[23 23]</span> <span class="selector-attr">[<span class="string">"49c35a73-7500-4ea4-aaa2-4b1c1f231fd4"</span> 1027]</span>, <span class="selector-attr">[11 11]</span> <span class="selector-attr">[<span class="string">"49c35a73-7500-4ea4-aaa2-4b1c1f231fd4"</span> 1027]</span>, <span class="selector-attr">[16 16]</span> <span class="selector-attr">[<span class="string">"49c35a73-7500-4ea4-aaa2-4b1c1f231fd4"</span> 1027]</span>, <span class="selector-attr">[13 13]</span> <span class="selector-attr">[<span class="string">"49c35a73-7500-4ea4-aaa2-4b1c1f231fd4"</span> 1027]</span>, <span class="selector-attr">[19 19]</span> <span class="selector-attr">[<span class="string">"49c35a73-7500-4ea4-aaa2-4b1c1f231fd4"</span> 1027]</span>, <span class="selector-attr">[21 21]</span> <span class="selector-attr">[<span class="string">"49c35a73-7500-4ea4-aaa2-4b1c1f231fd4"</span> 1027]</span>, <span class="selector-attr">[5 5]</span> <span class="selector-attr">[<span class="string">"49c35a73-7500-4ea4-aaa2-4b1c1f231fd4"</span> 1027]</span>, <span class="selector-attr">[26 26]</span> <span class="selector-attr">[<span class="string">"49c35a73-7500-4ea4-aaa2-4b1c1f231fd4"</span> 1027]</span>, <span class="selector-attr">[10 10]</span> <span class="selector-attr">[<span class="string">"49c35a73-7500-4ea4-aaa2-4b1c1f231fd4"</span> 1027]</span>, <span class="selector-attr">[14 14]</span> <span class="selector-attr">[<span class="string">"49c35a73-7500-4ea4-aaa2-4b1c1f231fd4"</span> 1027]</span>, <span class="selector-attr">[4 4]</span> <span class="selector-attr">[<span class="string">"49c35a73-7500-4ea4-aaa2-4b1c1f231fd4"</span> 1027]</span>, <span class="selector-attr">[15 15]</span> <span class="selector-attr">[<span class="string">"49c35a73-7500-4ea4-aaa2-4b1c1f231fd4"</span> 1027]</span>, <span class="selector-attr">[25 25]</span> <span class="selector-attr">[<span class="string">"49c35a73-7500-4ea4-aaa2-4b1c1f231fd4"</span> 1027]</span>, <span class="selector-attr">[17 17]</span> <span class="selector-attr">[<span class="string">"49c35a73-7500-4ea4-aaa2-4b1c1f231fd4"</span> 1027]</span>}, :executor-&gt;start-time-secs {<span class="selector-attr">[8 8]</span> <span class="number">1468420782</span>, <span class="selector-attr">[12 12]</span> <span class="number">1468420782</span>, <span class="selector-attr">[2 2]</span> <span class="number">1468420782</span>, <span class="selector-attr">[7 7]</span> <span class="number">1468420782</span>, <span class="selector-attr">[22 22]</span> <span class="number">1468420782</span>, <span class="selector-attr">[3 3]</span> <span class="number">1468420782</span>, <span class="selector-attr">[24 24]</span> <span class="number">1468420782</span>, <span class="selector-attr">[1 1]</span> <span class="number">1468420782</span>, <span class="selector-attr">[18 18]</span> <span class="number">1468420782</span>, <span class="selector-attr">[6 6]</span> <span class="number">1468420782</span>, <span class="selector-attr">[20 20]</span> <span class="number">1468420782</span>, <span class="selector-attr">[9 9]</span> <span class="number">1468420782</span>, <span class="selector-attr">[23 23]</span> <span class="number">1468420782</span>, <span class="selector-attr">[11 11]</span> <span class="number">1468420782</span>, <span class="selector-attr">[16 16]</span> <span class="number">1468420782</span>, <span class="selector-attr">[13 13]</span> <span class="number">1468420782</span>, <span class="selector-attr">[19 19]</span> <span class="number">1468420782</span>, <span class="selector-attr">[21 21]</span> <span class="number">1468420782</span>, <span class="selector-attr">[5 5]</span> <span class="number">1468420782</span>, <span class="selector-attr">[26 26]</span> <span class="number">1468420782</span>, <span class="selector-attr">[10 10]</span> <span class="number">1468420782</span>, <span class="selector-attr">[14 14]</span> <span class="number">1468420782</span>, <span class="selector-attr">[4 4]</span> <span class="number">1468420782</span>, <span class="selector-attr">[15 15]</span> <span class="number">1468420782</span>, <span class="selector-attr">[25 25]</span> <span class="number">1468420782</span>, <span class="selector-attr">[17 17]</span> <span class="number">1468420782</span>}}</span><br><span class="line">&gt; <span class="number">7751</span> <span class="selector-attr">[Thread-7]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.supervisor</span> - Extracting resources from jar at /Library/Java/JavaVirtualMachines/jdk1.<span class="number">7.0</span>_79.jdk/Contents/Home/lib/ant-javafx<span class="selector-class">.jar</span> to /var/folders/c0/<span class="number">0</span>bgvmbb10jz1609_1xjqdsj00000gn/T<span class="comment">//29645b09-90e9-4b9a-a657-60c418f92841/supervisor/stormdist/wordCounter-1-1468420782/resources</span></span><br><span class="line">&gt; <span class="number">7788</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.supervisor</span> - Launching worker with assignment {:storm-id <span class="string">"wordCounter-1-1468420782"</span>, :executors <span class="selector-attr">[[8 8]</span> <span class="selector-attr">[12 12]</span> <span class="selector-attr">[2 2]</span> <span class="selector-attr">[7 7]</span> <span class="selector-attr">[22 22]</span> <span class="selector-attr">[3 3]</span> <span class="selector-attr">[24 24]</span> <span class="selector-attr">[1 1]</span> <span class="selector-attr">[18 18]</span> <span class="selector-attr">[6 6]</span> <span class="selector-attr">[20 20]</span> <span class="selector-attr">[9 9]</span> <span class="selector-attr">[23 23]</span> <span class="selector-attr">[11 11]</span> <span class="selector-attr">[16 16]</span> <span class="selector-attr">[13 13]</span> <span class="selector-attr">[19 19]</span> <span class="selector-attr">[21 21]</span> <span class="selector-attr">[5 5]</span> <span class="selector-attr">[26 26]</span> <span class="selector-attr">[10 10]</span> <span class="selector-attr">[14 14]</span> <span class="selector-attr">[4 4]</span> <span class="selector-attr">[15 15]</span> <span class="selector-attr">[25 25]</span> <span class="selector-attr">[17 17]</span>]} <span class="keyword">for</span> this supervisor <span class="number">49</span>c35a73-<span class="number">7500</span>-<span class="number">4</span>ea4-aaa2-<span class="number">4</span>b1c1f231fd4 on port <span class="number">1027</span> with id <span class="number">9</span>dd8aeac-<span class="number">1</span>cd6-<span class="number">467</span>a-a84c-<span class="number">2637</span>d0825d99</span><br><span class="line">&gt; <span class="number">7791</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.worker</span> - Launching worker <span class="keyword">for</span> wordCounter-<span class="number">1</span>-<span class="number">1468420782</span> on <span class="number">49</span>c35a73-<span class="number">7500</span>-<span class="number">4</span>ea4-aaa2-<span class="number">4</span>b1c1f231fd4:<span class="number">1027</span> with id <span class="number">9</span>dd8aeac-<span class="number">1</span>cd6-<span class="number">467</span>a-a84c-<span class="number">2637</span>d0825d99 and conf {<span class="string">"topology.builtin.metrics.bucket.size.secs"</span> <span class="number">60</span>, ......</span><br><span class="line">&gt; <span class="number">7793</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.u</span><span class="selector-class">.StormBoundedExponentialBackoffRetry</span> - The baseSleepTimeMs <span class="selector-attr">[1000]</span> the maxSleepTimeMs <span class="selector-attr">[30000]</span> the maxRetries <span class="selector-attr">[5]</span></span><br><span class="line">&gt; <span class="number">7794</span> <span class="selector-attr">[Thread-8]</span> INFO  o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.f</span><span class="selector-class">.i</span><span class="selector-class">.CuratorFrameworkImpl</span> - Starting</span><br><span class="line">&gt; <span class="number">7798</span> <span class="selector-attr">[Thread-8-EventThread]</span> INFO  o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.f</span><span class="selector-class">.s</span><span class="selector-class">.ConnectionStateManager</span> - State change: CONNECTED</span><br><span class="line">&gt; <span class="number">7798</span> <span class="selector-attr">[Thread-8-EventThread]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.zookeeper</span> - Zookeeper state update: :connected:<span class="attribute">none</span></span><br><span class="line">&gt; <span class="number">7801</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.u</span><span class="selector-class">.StormBoundedExponentialBackoffRetry</span> - The baseSleepTimeMs <span class="selector-attr">[1000]</span> the maxSleepTimeMs <span class="selector-attr">[30000]</span> the maxRetries <span class="selector-attr">[5]</span></span><br><span class="line">&gt; <span class="number">7802</span> <span class="selector-attr">[Thread-8]</span> INFO  o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.f</span><span class="selector-class">.i</span><span class="selector-class">.CuratorFrameworkImpl</span> - Starting</span><br><span class="line">&gt; <span class="number">7805</span> <span class="selector-attr">[Thread-8-EventThread]</span> INFO  o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.f</span><span class="selector-class">.s</span><span class="selector-class">.ConnectionStateManager</span> - State change: CONNECTED</span><br><span class="line">&gt; <span class="number">7809</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.s</span><span class="selector-class">.a</span><span class="selector-class">.AuthUtils</span> - Got AutoCreds <span class="selector-attr">[]</span></span><br><span class="line">&gt; <span class="number">7811</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.worker</span> - Reading Assignments.</span><br><span class="line">&gt; <span class="number">7881</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.worker</span> - Launching receive-thread <span class="keyword">for</span> <span class="number">49</span>c35a73-<span class="number">7500</span>-<span class="number">4</span>ea4-aaa2-<span class="number">4</span>b1c1f231fd4:<span class="number">1027</span></span><br><span class="line">&gt; <span class="number">7884</span> <span class="selector-attr">[Thread-9-worker-receiver-thread-0]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.m</span><span class="selector-class">.loader</span> - Starting receive-thread: <span class="selector-attr">[stormId: wordCounter-1-1468420782, port: 1027, thread-id: 0 ]</span></span><br><span class="line">&gt; <span class="number">8261</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loading executor b-<span class="number">2</span>:<span class="selector-attr">[8 8]</span></span><br><span class="line">&gt; <span class="number">8285</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loaded executor tasks b-<span class="number">2</span>:<span class="selector-attr">[8 8]</span></span><br><span class="line">&gt; <span class="number">8300</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Finished loading executor b-<span class="number">2</span>:<span class="selector-attr">[8 8]</span></span><br><span class="line">&gt; <span class="number">8311</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loading executor b-<span class="number">2</span>:<span class="selector-attr">[12 12]</span></span><br><span class="line">&gt; <span class="number">8329</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loaded executor tasks b-<span class="number">2</span>:<span class="selector-attr">[12 12]</span></span><br><span class="line">&gt; <span class="number">8331</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Finished loading executor b-<span class="number">2</span>:<span class="selector-attr">[12 12]</span></span><br><span class="line">&gt; <span class="number">8340</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loading executor <span class="variable">$spoutcoord</span>-spout0:<span class="selector-attr">[2 2]</span></span><br><span class="line">&gt; <span class="number">8343</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loaded executor tasks <span class="variable">$spoutcoord</span>-spout0:<span class="selector-attr">[2 2]</span></span><br><span class="line">&gt; <span class="number">8346</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Finished loading executor <span class="variable">$spoutcoord</span>-spout0:<span class="selector-attr">[2 2]</span></span><br><span class="line">&gt; <span class="number">8355</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loading executor b-<span class="number">2</span>:<span class="selector-attr">[7 7]</span></span><br><span class="line">&gt; <span class="number">8372</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loaded executor tasks b-<span class="number">2</span>:<span class="selector-attr">[7 7]</span></span><br><span class="line">&gt; <span class="number">8375</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Finished loading executor b-<span class="number">2</span>:<span class="selector-attr">[7 7]</span></span><br><span class="line">&gt; <span class="number">8381</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loading executor b-<span class="number">3</span>:<span class="selector-attr">[22 22]</span></span><br><span class="line">&gt; <span class="number">8401</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loaded executor tasks b-<span class="number">3</span>:<span class="selector-attr">[22 22]</span></span><br><span class="line">&gt; <span class="number">8404</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Finished loading executor b-<span class="number">3</span>:<span class="selector-attr">[22 22]</span></span><br><span class="line">&gt; <span class="number">8412</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loading executor __acker:<span class="selector-attr">[3 3]</span></span><br><span class="line">&gt; <span class="number">8414</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loaded executor tasks __acker:<span class="selector-attr">[3 3]</span></span><br><span class="line">&gt; <span class="number">8424</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Timeouts disabled <span class="keyword">for</span> executor __acker:<span class="selector-attr">[3 3]</span></span><br><span class="line">&gt; <span class="number">8425</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Finished loading executor __acker:<span class="selector-attr">[3 3]</span></span><br><span class="line">&gt; <span class="number">8443</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loading executor b-<span class="number">5</span>:<span class="selector-attr">[24 24]</span></span><br><span class="line">&gt; <span class="number">8465</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loaded executor tasks b-<span class="number">5</span>:<span class="selector-attr">[24 24]</span></span><br><span class="line">&gt; <span class="number">8467</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Finished loading executor b-<span class="number">5</span>:<span class="selector-attr">[24 24]</span></span><br><span class="line">&gt; <span class="number">8530</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loading executor <span class="variable">$mastercoord</span>-bg0:<span class="selector-attr">[1 1]</span></span><br><span class="line">&gt; <span class="number">8539</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loaded executor tasks <span class="variable">$mastercoord</span>-bg0:<span class="selector-attr">[1 1]</span></span><br><span class="line">&gt; <span class="number">8576</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Finished loading executor <span class="variable">$mastercoord</span>-bg0:<span class="selector-attr">[1 1]</span></span><br><span class="line">&gt; <span class="number">8603</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loading executor b-<span class="number">2</span>:<span class="selector-attr">[18 18]</span></span><br><span class="line">&gt; <span class="number">8633</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loaded executor tasks b-<span class="number">2</span>:<span class="selector-attr">[18 18]</span></span><br><span class="line">&gt; <span class="number">8635</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Finished loading executor b-<span class="number">2</span>:<span class="selector-attr">[18 18]</span></span><br><span class="line">&gt; <span class="number">8646</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loading executor b-<span class="number">2</span>:<span class="selector-attr">[6 6]</span></span><br><span class="line">&gt; <span class="number">8681</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loaded executor tasks b-<span class="number">2</span>:<span class="selector-attr">[6 6]</span></span><br><span class="line">&gt; <span class="number">8683</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Finished loading executor b-<span class="number">2</span>:<span class="selector-attr">[6 6]</span></span><br><span class="line">&gt; <span class="number">8719</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loading executor b-<span class="number">2</span>:<span class="selector-attr">[20 20]</span></span><br><span class="line">&gt; <span class="number">8757</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loaded executor tasks b-<span class="number">2</span>:<span class="selector-attr">[20 20]</span></span><br><span class="line">&gt; <span class="number">8763</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Finished loading executor b-<span class="number">2</span>:<span class="selector-attr">[20 20]</span></span><br><span class="line">&gt; <span class="number">8782</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loading executor b-<span class="number">2</span>:<span class="selector-attr">[9 9]</span></span><br><span class="line">&gt; <span class="number">8808</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loaded executor tasks b-<span class="number">2</span>:<span class="selector-attr">[9 9]</span></span><br><span class="line">&gt; <span class="number">8818</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Finished loading executor b-<span class="number">2</span>:<span class="selector-attr">[9 9]</span></span><br><span class="line">&gt; <span class="number">8828</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loading executor b-<span class="number">4</span>:<span class="selector-attr">[23 23]</span></span><br><span class="line">&gt; <span class="number">8847</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loaded executor tasks b-<span class="number">4</span>:<span class="selector-attr">[23 23]</span></span><br><span class="line">&gt; <span class="number">8851</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Finished loading executor b-<span class="number">4</span>:<span class="selector-attr">[23 23]</span></span><br><span class="line">&gt; <span class="number">8858</span> <span class="selector-attr">[refresh-active-timer]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.worker</span> - All connections are ready <span class="keyword">for</span> worker <span class="number">49</span>c35a73-<span class="number">7500</span>-<span class="number">4</span>ea4-aaa2-<span class="number">4</span>b1c1f231fd4:<span class="number">1027</span> with id <span class="number">9</span>dd8aeac-<span class="number">1</span>cd6-<span class="number">467</span>a-a84c-<span class="number">2637</span>d0825d99</span><br><span class="line">&gt; <span class="number">8864</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loading executor b-<span class="number">2</span>:<span class="selector-attr">[11 11]</span></span><br><span class="line">&gt; <span class="number">8877</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loaded executor tasks b-<span class="number">2</span>:<span class="selector-attr">[11 11]</span></span><br><span class="line">&gt; <span class="number">8879</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Finished loading executor b-<span class="number">2</span>:<span class="selector-attr">[11 11]</span></span><br><span class="line">&gt; <span class="number">8886</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loading executor __system:<span class="selector-attr">[-1 -1]</span></span><br><span class="line">&gt; <span class="number">8887</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loaded executor tasks __system:<span class="selector-attr">[-1 -1]</span></span><br><span class="line">&gt; <span class="number">8890</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Finished loading executor __system:<span class="selector-attr">[-1 -1]</span></span><br><span class="line">&gt; <span class="number">8914</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loading executor b-<span class="number">2</span>:<span class="selector-attr">[16 16]</span></span><br><span class="line">&gt; <span class="number">9052</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loaded executor tasks b-<span class="number">2</span>:<span class="selector-attr">[16 16]</span></span><br><span class="line">&gt; <span class="number">9055</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Finished loading executor b-<span class="number">2</span>:<span class="selector-attr">[16 16]</span></span><br><span class="line">&gt; <span class="number">9070</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loading executor b-<span class="number">2</span>:<span class="selector-attr">[13 13]</span></span><br><span class="line">&gt; <span class="number">9081</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loaded executor tasks b-<span class="number">2</span>:<span class="selector-attr">[13 13]</span></span><br><span class="line">&gt; <span class="number">9089</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Finished loading executor b-<span class="number">2</span>:<span class="selector-attr">[13 13]</span></span><br><span class="line">&gt; <span class="number">9116</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loading executor b-<span class="number">2</span>:<span class="selector-attr">[19 19]</span></span><br><span class="line">&gt; <span class="number">9129</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loaded executor tasks b-<span class="number">2</span>:<span class="selector-attr">[19 19]</span></span><br><span class="line">&gt; <span class="number">9132</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Finished loading executor b-<span class="number">2</span>:<span class="selector-attr">[19 19]</span></span><br><span class="line">&gt; <span class="number">9148</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loading executor b-<span class="number">2</span>:<span class="selector-attr">[21 21]</span></span><br><span class="line">&gt; <span class="number">9160</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loaded executor tasks b-<span class="number">2</span>:<span class="selector-attr">[21 21]</span></span><br><span class="line">&gt; <span class="number">9163</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Finished loading executor b-<span class="number">2</span>:<span class="selector-attr">[21 21]</span></span><br><span class="line">&gt; <span class="number">9178</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loading executor b-<span class="number">1</span>:<span class="selector-attr">[5 5]</span></span><br><span class="line">&gt; <span class="number">9192</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loaded executor tasks b-<span class="number">1</span>:<span class="selector-attr">[5 5]</span></span><br><span class="line">&gt; <span class="number">9194</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Finished loading executor b-<span class="number">1</span>:<span class="selector-attr">[5 5]</span></span><br><span class="line">&gt; <span class="number">9204</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loading executor spout1:<span class="selector-attr">[26 26]</span></span><br><span class="line">&gt; <span class="number">9205</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loaded executor tasks spout1:<span class="selector-attr">[26 26]</span></span><br><span class="line">&gt; <span class="number">9208</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Finished loading executor spout1:<span class="selector-attr">[26 26]</span></span><br><span class="line">&gt; <span class="number">9220</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loading executor b-<span class="number">2</span>:<span class="selector-attr">[10 10]</span></span><br><span class="line">&gt; <span class="number">9226</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loaded executor tasks b-<span class="number">2</span>:<span class="selector-attr">[10 10]</span></span><br><span class="line">&gt; <span class="number">9228</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Finished loading executor b-<span class="number">2</span>:<span class="selector-attr">[10 10]</span></span><br><span class="line">&gt; <span class="number">9234</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loading executor b-<span class="number">2</span>:<span class="selector-attr">[14 14]</span></span><br><span class="line">&gt; <span class="number">9237</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loaded executor tasks b-<span class="number">2</span>:<span class="selector-attr">[14 14]</span></span><br><span class="line">&gt; <span class="number">9239</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Finished loading executor b-<span class="number">2</span>:<span class="selector-attr">[14 14]</span></span><br><span class="line">&gt; <span class="number">9244</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loading executor b-<span class="number">0</span>:<span class="selector-attr">[4 4]</span></span><br><span class="line">&gt; <span class="number">9248</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loaded executor tasks b-<span class="number">0</span>:<span class="selector-attr">[4 4]</span></span><br><span class="line">&gt; <span class="number">9249</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Finished loading executor b-<span class="number">0</span>:<span class="selector-attr">[4 4]</span></span><br><span class="line">&gt; <span class="number">9255</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loading executor b-<span class="number">2</span>:<span class="selector-attr">[15 15]</span></span><br><span class="line">&gt; <span class="number">9260</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loaded executor tasks b-<span class="number">2</span>:<span class="selector-attr">[15 15]</span></span><br><span class="line">&gt; <span class="number">9261</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Finished loading executor b-<span class="number">2</span>:<span class="selector-attr">[15 15]</span></span><br><span class="line">&gt; <span class="number">9273</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loading executor spout0:<span class="selector-attr">[25 25]</span></span><br><span class="line">&gt; <span class="number">9275</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loaded executor tasks spout0:<span class="selector-attr">[25 25]</span></span><br><span class="line">&gt; <span class="number">9277</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Finished loading executor spout0:<span class="selector-attr">[25 25]</span></span><br><span class="line">&gt; <span class="number">9284</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loading executor b-<span class="number">2</span>:<span class="selector-attr">[17 17]</span></span><br><span class="line">&gt; <span class="number">9289</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Loaded executor tasks b-<span class="number">2</span>:<span class="selector-attr">[17 17]</span></span><br><span class="line">&gt; <span class="number">9291</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Finished loading executor b-<span class="number">2</span>:<span class="selector-attr">[17 17]</span></span><br><span class="line">&gt; <span class="number">9298</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.worker</span> - Worker has topology config {<span class="string">"topology.builtin.metrics.bucket.size.secs"</span> <span class="number">60</span>, ......</span><br><span class="line">&gt; <span class="number">9298</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.worker</span> - Worker <span class="number">9</span>dd8aeac-<span class="number">1</span>cd6-<span class="number">467</span>a-a84c-<span class="number">2637</span>d0825d99 <span class="keyword">for</span> storm wordCounter-<span class="number">1</span>-<span class="number">1468420782</span> on <span class="number">49</span>c35a73-<span class="number">7500</span>-<span class="number">4</span>ea4-aaa2-<span class="number">4</span>b1c1f231fd4:<span class="number">1027</span> has finished loading</span><br><span class="line">&gt; <span class="number">9298</span> <span class="selector-attr">[Thread-8]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.config</span> - SET worker-user <span class="number">9</span>dd8aeac-<span class="number">1</span>cd6-<span class="number">467</span>a-a84c-<span class="number">2637</span>d0825d99</span><br><span class="line">&gt; <span class="number">9875</span> <span class="selector-attr">[Thread-27-b-2]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Preparing bolt b-<span class="number">2</span>:(<span class="number">18</span>)</span><br><span class="line">&gt; <span class="number">9882</span> <span class="selector-attr">[Thread-35-b-4]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Preparing bolt b-<span class="number">4</span>:(<span class="number">23</span>)</span><br><span class="line">&gt; <span class="number">9882</span> <span class="selector-attr">[Thread-41-b-2]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Preparing bolt b-<span class="number">2</span>:(<span class="number">16</span>)</span><br><span class="line">&gt; <span class="number">9883</span> <span class="selector-attr">[Thread-13-b-2]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Preparing bolt b-<span class="number">2</span>:(<span class="number">12</span>)</span><br><span class="line">&gt; <span class="number">9883</span> <span class="selector-attr">[Thread-59-b-2]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Preparing bolt b-<span class="number">2</span>:(<span class="number">15</span>)</span><br><span class="line">&gt; <span class="number">9883</span> <span class="selector-attr">[Thread-47-b-2]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Preparing bolt b-<span class="number">2</span>:(<span class="number">21</span>)</span><br><span class="line">&gt; <span class="number">9893</span> <span class="selector-attr">[Thread-35-b-4]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Prepared bolt b-<span class="number">4</span>:(<span class="number">23</span>)</span><br><span class="line">&gt; <span class="number">9896</span> <span class="selector-attr">[Thread-47-b-2]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Prepared bolt b-<span class="number">2</span>:(<span class="number">21</span>)</span><br><span class="line">&gt; <span class="number">9896</span> <span class="selector-attr">[Thread-59-b-2]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Prepared bolt b-<span class="number">2</span>:(<span class="number">15</span>)</span><br><span class="line">&gt; <span class="number">9896</span> <span class="selector-attr">[Thread-27-b-2]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Prepared bolt b-<span class="number">2</span>:(<span class="number">18</span>)</span><br><span class="line">&gt; <span class="number">9896</span> <span class="selector-attr">[Thread-13-b-2]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Prepared bolt b-<span class="number">2</span>:(<span class="number">12</span>)</span><br><span class="line">&gt; <span class="number">9896</span> <span class="selector-attr">[Thread-41-b-2]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Prepared bolt b-<span class="number">2</span>:(<span class="number">16</span>)</span><br><span class="line">&gt; <span class="number">9898</span> <span class="selector-attr">[Thread-31-b-2]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Preparing bolt b-<span class="number">2</span>:(<span class="number">20</span>)</span><br><span class="line">&gt; <span class="number">9898</span> <span class="selector-attr">[Thread-15-$spoutcoord-spout0]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Preparing bolt <span class="variable">$spoutcoord</span>-spout0:(<span class="number">2</span>)</span><br><span class="line">&gt; <span class="number">9899</span> <span class="selector-attr">[Thread-61-spout0]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Preparing bolt spout0:(<span class="number">25</span>)</span><br><span class="line">&gt; <span class="number">9900</span> <span class="selector-attr">[Thread-15-$spoutcoord-spout0]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.u</span><span class="selector-class">.StormBoundedExponentialBackoffRetry</span> - The baseSleepTimeMs <span class="selector-attr">[1000]</span> the maxSleepTimeMs <span class="selector-attr">[30000]</span> the maxRetries <span class="selector-attr">[5]</span></span><br><span class="line">&gt; <span class="number">9900</span> <span class="selector-attr">[Thread-61-spout0]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Prepared bolt spout0:(<span class="number">25</span>)</span><br><span class="line">&gt; <span class="number">9901</span> <span class="selector-attr">[Thread-15-$spoutcoord-spout0]</span> INFO  o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.f</span><span class="selector-class">.i</span><span class="selector-class">.CuratorFrameworkImpl</span> - Starting</span><br><span class="line">&gt; <span class="number">9901</span> <span class="selector-attr">[Thread-31-b-2]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Prepared bolt b-<span class="number">2</span>:(<span class="number">20</span>)</span><br><span class="line">&gt; <span class="number">9907</span> <span class="selector-attr">[Thread-15-$spoutcoord-spout0-EventThread]</span> INFO  o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.f</span><span class="selector-class">.s</span><span class="selector-class">.ConnectionStateManager</span> - State change: CONNECTED</span><br><span class="line">&gt; <span class="number">9908</span> <span class="selector-attr">[Thread-43-b-2]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Preparing bolt b-<span class="number">2</span>:(<span class="number">13</span>)</span><br><span class="line">&gt; <span class="number">9908</span> <span class="selector-attr">[Thread-37-b-2]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Preparing bolt b-<span class="number">2</span>:(<span class="number">11</span>)</span><br><span class="line">&gt; <span class="number">9908</span> <span class="selector-attr">[Thread-63-b-2]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Preparing bolt b-<span class="number">2</span>:(<span class="number">17</span>)</span><br><span class="line">&gt; <span class="number">9910</span> <span class="selector-attr">[Thread-43-b-2]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Prepared bolt b-<span class="number">2</span>:(<span class="number">13</span>)</span><br><span class="line">&gt; <span class="number">9910</span> <span class="selector-attr">[Thread-37-b-2]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Prepared bolt b-<span class="number">2</span>:(<span class="number">11</span>)</span><br><span class="line">&gt; <span class="number">9911</span> <span class="selector-attr">[Thread-63-b-2]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Prepared bolt b-<span class="number">2</span>:(<span class="number">17</span>)</span><br><span class="line">&gt; <span class="number">9918</span> <span class="selector-attr">[Thread-49-b-1]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Preparing bolt b-<span class="number">1</span>:(<span class="number">5</span>)</span><br><span class="line">&gt; <span class="number">9918</span> <span class="selector-attr">[Thread-39-__system]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Preparing bolt __system:(-<span class="number">1</span>)</span><br><span class="line">&gt; <span class="number">9918</span> <span class="selector-attr">[Thread-29-b-2]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Preparing bolt b-<span class="number">2</span>:(<span class="number">6</span>)</span><br><span class="line">&gt; <span class="number">9920</span> <span class="selector-attr">[Thread-49-b-1]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Prepared bolt b-<span class="number">1</span>:(<span class="number">5</span>)</span><br><span class="line">&gt; <span class="number">9920</span> <span class="selector-attr">[Thread-29-b-2]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Prepared bolt b-<span class="number">2</span>:(<span class="number">6</span>)</span><br><span class="line">&gt; <span class="number">9921</span> <span class="selector-attr">[Thread-15-$spoutcoord-spout0]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.u</span><span class="selector-class">.StormBoundedExponentialBackoffRetry</span> - The baseSleepTimeMs <span class="selector-attr">[1000]</span> the maxSleepTimeMs <span class="selector-attr">[30000]</span> the maxRetries <span class="selector-attr">[5]</span></span><br><span class="line">&gt; <span class="number">9922</span> <span class="selector-attr">[Thread-15-$spoutcoord-spout0]</span> INFO  o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.f</span><span class="selector-class">.i</span><span class="selector-class">.CuratorFrameworkImpl</span> - Starting</span><br><span class="line">&gt; <span class="number">9924</span> <span class="selector-attr">[Thread-39-__system]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Prepared bolt __system:(-<span class="number">1</span>)</span><br><span class="line">&gt; <span class="number">9929</span> <span class="selector-attr">[Thread-51-spout1]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Opening spout spout1:(<span class="number">26</span>)</span><br><span class="line">&gt; <span class="number">9929</span> <span class="selector-attr">[Thread-25-$mastercoord-bg0]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Opening spout <span class="variable">$mastercoord</span>-bg0:(<span class="number">1</span>)</span><br><span class="line">&gt; <span class="number">9929</span> <span class="selector-attr">[Thread-15-$spoutcoord-spout0-EventThread]</span> INFO  o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.f</span><span class="selector-class">.s</span><span class="selector-class">.ConnectionStateManager</span> - State change: CONNECTED</span><br><span class="line">&gt; <span class="number">9938</span> <span class="selector-attr">[Thread-51-spout1]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Opened spout spout1:(<span class="number">26</span>)</span><br><span class="line">&gt; <span class="number">9937</span> <span class="selector-attr">[Thread-25-$mastercoord-bg0]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.u</span><span class="selector-class">.StormBoundedExponentialBackoffRetry</span> - The baseSleepTimeMs <span class="selector-attr">[1000]</span> the maxSleepTimeMs <span class="selector-attr">[30000]</span> the maxRetries <span class="selector-attr">[5]</span></span><br><span class="line">&gt; <span class="number">9940</span> <span class="selector-attr">[Thread-25-$mastercoord-bg0]</span> INFO  o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.f</span><span class="selector-class">.i</span><span class="selector-class">.CuratorFrameworkImpl</span> - Starting</span><br><span class="line">&gt; <span class="number">9940</span> <span class="selector-attr">[Thread-33-b-2]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Preparing bolt b-<span class="number">2</span>:(<span class="number">9</span>)</span><br><span class="line">&gt; <span class="number">9942</span> <span class="selector-attr">[Thread-51-spout1]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Activating spout spout1:(<span class="number">26</span>)</span><br><span class="line">&gt; <span class="number">9942</span> <span class="selector-attr">[Thread-33-b-2]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Prepared bolt b-<span class="number">2</span>:(<span class="number">9</span>)</span><br><span class="line">&gt; <span class="number">9947</span> <span class="selector-attr">[Thread-53-b-2]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Preparing bolt b-<span class="number">2</span>:(<span class="number">10</span>)</span><br><span class="line">&gt; <span class="number">9950</span> <span class="selector-attr">[Thread-53-b-2]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Prepared bolt b-<span class="number">2</span>:(<span class="number">10</span>)</span><br><span class="line">&gt; <span class="number">9956</span> <span class="selector-attr">[Thread-11-b-2]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Preparing bolt b-<span class="number">2</span>:(<span class="number">8</span>)</span><br><span class="line">&gt; <span class="number">9956</span> <span class="selector-attr">[Thread-45-b-2]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Preparing bolt b-<span class="number">2</span>:(<span class="number">19</span>)</span><br><span class="line">&gt; <span class="number">9957</span> <span class="selector-attr">[Thread-23-b-5]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Preparing bolt b-<span class="number">5</span>:(<span class="number">24</span>)</span><br><span class="line">&gt; <span class="number">9958</span> <span class="selector-attr">[Thread-23-b-5]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Prepared bolt b-<span class="number">5</span>:(<span class="number">24</span>)</span><br><span class="line">&gt; <span class="number">9958</span> <span class="selector-attr">[Thread-11-b-2]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Prepared bolt b-<span class="number">2</span>:(<span class="number">8</span>)</span><br><span class="line">&gt; <span class="number">9958</span> <span class="selector-attr">[Thread-17-b-2]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Preparing bolt b-<span class="number">2</span>:(<span class="number">7</span>)</span><br><span class="line">&gt; <span class="number">9959</span> <span class="selector-attr">[Thread-55-b-2]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Preparing bolt b-<span class="number">2</span>:(<span class="number">14</span>)</span><br><span class="line">&gt; <span class="number">9959</span> <span class="selector-attr">[Thread-19-b-3]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Preparing bolt b-<span class="number">3</span>:(<span class="number">22</span>)</span><br><span class="line">&gt; <span class="number">9960</span> <span class="selector-attr">[Thread-19-b-3]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Prepared bolt b-<span class="number">3</span>:(<span class="number">22</span>)</span><br><span class="line">&gt; <span class="number">9960</span> <span class="selector-attr">[Thread-25-$mastercoord-bg0-EventThread]</span> INFO  o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.f</span><span class="selector-class">.s</span><span class="selector-class">.ConnectionStateManager</span> - State change: CONNECTED</span><br><span class="line">&gt; <span class="number">9960</span> <span class="selector-attr">[Thread-17-b-2]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Prepared bolt b-<span class="number">2</span>:(<span class="number">7</span>)</span><br><span class="line">&gt; <span class="number">9962</span> <span class="selector-attr">[Thread-45-b-2]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Prepared bolt b-<span class="number">2</span>:(<span class="number">19</span>)</span><br><span class="line">&gt; <span class="number">9963</span> <span class="selector-attr">[Thread-55-b-2]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Prepared bolt b-<span class="number">2</span>:(<span class="number">14</span>)</span><br><span class="line">&gt; <span class="number">9964</span> <span class="selector-attr">[Thread-57-b-0]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Preparing bolt b-<span class="number">0</span>:(<span class="number">4</span>)</span><br><span class="line">&gt; <span class="number">9964</span> <span class="selector-attr">[Thread-21-__acker]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Preparing bolt __acker:(<span class="number">3</span>)</span><br><span class="line">&gt; <span class="number">9965</span> <span class="selector-attr">[Thread-57-b-0]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Prepared bolt b-<span class="number">0</span>:(<span class="number">4</span>)</span><br><span class="line">&gt; <span class="number">9966</span> <span class="selector-attr">[Thread-21-__acker]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Prepared bolt __acker:(<span class="number">3</span>)</span><br><span class="line">&gt; <span class="number">9969</span> <span class="selector-attr">[Thread-15-$spoutcoord-spout0]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Prepared bolt <span class="variable">$spoutcoord</span>-spout0:(<span class="number">2</span>)</span><br><span class="line">&gt; <span class="number">9971</span> <span class="selector-attr">[Thread-25-$mastercoord-bg0]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.u</span><span class="selector-class">.StormBoundedExponentialBackoffRetry</span> - The baseSleepTimeMs <span class="selector-attr">[1000]</span> the maxSleepTimeMs <span class="selector-attr">[30000]</span> the maxRetries <span class="selector-attr">[5]</span></span><br><span class="line">&gt; <span class="number">9972</span> <span class="selector-attr">[Thread-25-$mastercoord-bg0]</span> INFO  o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.f</span><span class="selector-class">.i</span><span class="selector-class">.CuratorFrameworkImpl</span> - Starting</span><br><span class="line">&gt; <span class="number">9984</span> <span class="selector-attr">[Thread-25-$mastercoord-bg0-EventThread]</span> INFO  o<span class="selector-class">.a</span><span class="selector-class">.c</span><span class="selector-class">.f</span><span class="selector-class">.s</span><span class="selector-class">.ConnectionStateManager</span> - State change: CONNECTED</span><br><span class="line">&gt; DRPC RESULT: <span class="selector-attr">[[0]</span>]</span><br><span class="line">&gt; <span class="number">9988</span> <span class="selector-attr">[Thread-25-$mastercoord-bg0]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Opened spout <span class="variable">$mastercoord</span>-bg0:(<span class="number">1</span>)</span><br><span class="line">&gt; <span class="number">9988</span> <span class="selector-attr">[Thread-25-$mastercoord-bg0]</span> INFO  <span class="selector-tag">b</span><span class="selector-class">.s</span><span class="selector-class">.d</span><span class="selector-class">.executor</span> - Activating spout <span class="variable">$mastercoord</span>-bg0:(<span class="number">1</span>)</span><br><span class="line">&gt; DRPC RESULT: <span class="selector-attr">[[60]</span>]</span><br><span class="line">&gt; DRPC RESULT: <span class="selector-attr">[[120]</span>]</span><br><span class="line">&gt; DRPC RESULT: <span class="selector-attr">[[179]</span>]</span><br><span class="line">&gt; DRPC RESULT: <span class="selector-attr">[[239]</span>]</span><br><span class="line">&gt; DRPC RESULT: <span class="selector-attr">[[299]</span>]</span><br><span class="line">&gt; DRPC RESULT: <span class="selector-attr">[[359]</span>]</span><br><span class="line">&gt; DRPC RESULT: <span class="selector-attr">[[414]</span>]</span><br><span class="line">&gt; DRPC RESULT: <span class="selector-attr">[[474]</span>]</span><br><span class="line">&gt; DRPC RESULT: <span class="selector-attr">[[534]</span>]</span><br><span class="line">&gt; DRPC RESULT: <span class="selector-attr">[[593]</span>]</span><br><span class="line">&gt; DRPC RESULT: <span class="selector-attr">[[653]</span>]</span><br><span class="line">&gt; DRPC RESULT: <span class="selector-attr">[[713]</span>]</span><br><span class="line">&gt; DRPC RESULT: <span class="selector-attr">[[768]</span>]</span><br><span class="line">&gt;</span><br><span class="line">&gt; Process finished with exit <span class="selector-tag">code</span> <span class="number">130</span></span><br></pre></td></tr></tbody></table></figure>
]]></content>
      <categories>
        <category>Storm</category>
      </categories>
      <tags>
        <tag>storm</tag>
        <tag>源码编译</tag>
        <tag>本地调试</tag>
      </tags>
  </entry>
  <entry>
    <title>storm集群supervisor节点异常退出问题排查</title>
    <url>/20170703/storm%E9%9B%86%E7%BE%A4supervisor%E8%8A%82%E7%82%B9%E5%BC%82%E5%B8%B8%E9%80%80%E5%87%BA%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/</url>
    <content><![CDATA[<h2 id="问题出现"><a class="markdownIt-Anchor" href="#问题出现"></a> 问题出现</h2>
<p>测试storm集群为0.9.4版本，前段时间出现supervisor进程挂掉，而其上work进程仍然运行的诡异情况，通过日志看到supervisor进程挂掉之前出现以下异常：</p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20150701/1.png" alt=""></p>
<h2 id="问题排查过程"><a class="markdownIt-Anchor" href="#问题排查过程"></a> 问题排查过程</h2>
<p>很明显，是commons-io包的FileUtils工具类抛出的异常，原因是在调用commons-io包的FileUtils工具类做move directory操作时，目的文件夹已存在。</p>
<p>查看调用代码（supervisor.clj的第374行），是调用download-storm-code方法从nimbus下载topology的代码，并且download-storm-code方法中做代码下载前加了锁避免并发写文件。</p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20150701/2.png" alt=""></p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20150701/3.png" alt=""></p>
<p>果然，这里没有判断stormroot文件夹是否已存在，是个bug，具体可见这个issue：<span class="exturl" data-url="aHR0cHM6Ly9pc3N1ZXMuYXBhY2hlLm9yZy9qaXJhL2Jyb3dzZS9TVE9STS04MDU=">https://issues.apache.org/jira/browse/STORM-805<i class="fa fa-external-link-alt"></i></span>。</p>
<p>这个问题在0.9.5版本中随着STORM-130一起修复了，代码如下：</p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20150701/4.png" alt=""></p>
<p>但这里有三个问题：</p>
<ol>
<li>
<p>在调用download-storm-code方法前，代码中已做判断是否已下载topology代码，若已下载就不会调用download-storm-code方法了。为何进入这个方法后，做move directory操作时，代码却已经下载好了呢？</p>
</li>
<li>
<p>storm的历史发布版本有很多，为何0.9.4版本里会出现这个不该出现的问题，0.9.4相对老的版本是不是做了什么修改？</p>
</li>
<li>
<p>为何抛出异常后，supervisor进程就这么直接退出了？太弱了吧。。</p>
</li>
</ol>
<span id="more"></span>
<p>继续看0.9.4的源码发现，<strong>supervisor中有以下两个事件线程，都会调用download-storm-code方法</strong>：</p>
<p><strong>一个是synchronize-supervisor，用于同步nimbus任务</strong>，每隔10秒执行一次，会调用mk-synchronize-supervisor方法，以及时获取nimbus分配给该supervisor的新任务并移除已分配但不再需要执行的任务。</p>
<p><strong>另一个是sync-processes，用于根据任务变化同步管理worker进程</strong>，执行周期由SUPERVISOR-MONITOR-FREQUENCY-SECS（默认3秒）指定，会调用sync-processes方法，以关闭当前不处于valid状态的worker和启动新分配给该supervisor的worker。</p>
<p>其中，mk-synchronize-supervisor方法和sync-processes方法都会调用download-storm-code方法。</p>
<p>两个事件线程的定义：</p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20150701/5.png" alt=""></p>
<p>mk-synchronize-supervisor方法调用download-storm-code方法：</p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20150701/6.png" alt=""></p>
<p>sync-processes调用download-storm-code方法：</p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20150701/7.png" alt=""></p>
<p>mk-synchronize-supervisor方法和sync-processes方法在调用前都会判断topology代码是否已下载，所以，出现上述异常的原因很可能是两个线程再调用download-storm-code方法时不同步引起的，即同时判断到需要下载topology代码并进入了download-storm-code方法，从而产生两次move directory的操作引发异常。</p>
<p>虽然download-storm-code方法内部通过加锁控制了写文件时的并发，但对进入download-storm-code方法并没有做好同步。</p>
<p>再回过头看0.9.5版本的代码，虽然在move directory前判断了目的文件夹是否存在以避免问题，但实际上还是存在两个线程同时进入download-storm-code方法的问题。</p>
<p>最后再比较了下0.9.3和0.9.4的代码（supervisor.clj），发现0.9.4的sync-processes方法中调用download-storm-code的逻辑是新加进去的，也就是说这个bug是0.9.4新引入的，以前的版本不会存在这个问题。</p>
<p>左边为0.9.3，右边为0.9.4：</p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20150701/8.png" alt=""></p>
<p>关于第3个问题，再回看定义synchronize-supervisor事件线程的代码，是通过事件管理器event-manager来实现的，查看event.clj中的实现，event-manager会从一个LinkedBlockingQueue取出新事件并启动线程处理，线程若抛出非Interrupted异常，则直接退出进程了。</p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20150701/9.png" alt=""></p>
<p>至此，问题分析完毕。</p>
]]></content>
      <categories>
        <category>Storm</category>
      </categories>
      <tags>
        <tag>storm</tag>
        <tag>supervisor</tag>
        <tag>异常排查</tag>
      </tags>
  </entry>
  <entry>
    <title>交换空间使用率过高问题分析</title>
    <url>/20170622/%E4%BA%A4%E6%8D%A2%E7%A9%BA%E9%97%B4%E4%BD%BF%E7%94%A8%E7%8E%87%E8%BF%87%E9%AB%98%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<h2 id="问题现象"><a class="markdownIt-Anchor" href="#问题现象"></a> 问题现象</h2>
<p>线上两台java后台服务每次上线后再过段时间，就出现swap空间使用率较高的现象，而jvm内存使用和垃圾回收情况则很正常。相关图表如下：</p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20150622%E4%BA%A4%E6%8D%A2%E7%A9%BA%E9%97%B4%E4%BD%BF%E7%94%A8%E7%8E%87%E8%BF%87%E9%AB%98%E9%97%AE%E9%A2%98/1.png" alt=""></p>
<p>图中，每次上线后过一段时间，swap空间使用量会出现一个陡增，并随时间推移逐渐增加，期间会出现小幅度下降。</p>
<p>首先，从操作系统层面分析，swap空间使用较高，说明是系统物理内存不够用从而发生内存页交换，将部分内存数据搬至虚拟内存空间，也就是swap空间。但究竟是什么原因引起物理内存不足呢？因为Jvm堆大小是固定的，所以推断是因堆外内存占用空间较大引起。</p>
<p>于是，使用jmap -histo:live <pid>把进程中的对象信息dump出来，dump信息如下：</pid></p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20150622%E4%BA%A4%E6%8D%A2%E7%A9%BA%E9%97%B4%E4%BD%BF%E7%94%A8%E7%8E%87%E8%BF%87%E9%AB%98%E9%97%AE%E9%A2%98/2.png" alt=""></p>
<p>确实发现存在大量DirectByteBuffer对象，这说明内存中确实有大量引用了堆外内存的对象没有被回收！</p>
<p>同时，内存中也对应存在着大量的sun.misc.Cleaner和java.nio.DirectByteBuffer$Deallocator对象。这两个类是用于回收堆外内存的。Cleaner对象是在DirectByteBuffer的构造函数中创建，其中封装了回收堆外内存的逻辑，Cleaner执行clean资源的操作是通过启动Deallocator线程实现的，这个线程把DirectByteBuffer对象引用的堆外内存做回收。</p>
<p>那么问题来了：</p>
<ol>
<li>
<p>为什么DirectByteBuffer对象没有被回收？</p>
</li>
<li>
<p>怎么做才能让DirectByteBuffer对象能被及时回收？</p>
</li>
</ol>
<h2 id="问题分析"><a class="markdownIt-Anchor" href="#问题分析"></a> 问题分析</h2>
<span id="more"></span>
<p>先看了下启动jvm参数为-Xmn8192M -Xms13312M -Xmx13312M -XX:PermSize=512m -XX:MaxPermSize=512m，很明显，新生代空间配的太大，同时，也没有指定堆外内存的最大空间（-XX:MaxDirectMemorySize），这个参数没设置则默认等于-Xmx，然而服务器总内存只有16G，所以时间长了很可能会发生堆外内存溢出！</p>
<p>因为此服务是kafka集群的消费者，每天接收的报文量在1亿以上，这个过程中产生了大量的DirectByteBuffer对象，这些对象直接引用堆外内存，而同时，这些临时对象也会被回收，由于新生代空间配的很大，触发minor GC的频率不够高，从而不能及时释放已被占用的堆外内存，随着时间的推移，进程启动过一段时间后，堆外内存占用越来越多，最终被OS交换到swap空间。</p>
<h2 id="解决方案"><a class="markdownIt-Anchor" href="#解决方案"></a> 解决方案</h2>
<p>调整jvm参数，减少新生代大小为jvm堆空间的3/8，并指定堆外内存大小，调整后的jvm参数为-Xmn3840M -Xms10240M -Xmx10240M -XX:PermSize=512m -XX:MaxPermSize=512m -XX:MaxDirectMemorySize=4096m</p>
<p>调整后，swap空间占用情况有所好转，但依然占用2G左右！如下图所示。</p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20150622%E4%BA%A4%E6%8D%A2%E7%A9%BA%E9%97%B4%E4%BD%BF%E7%94%A8%E7%8E%87%E8%BF%87%E9%AB%98%E9%97%AE%E9%A2%98/3.png" alt=""></p>
<p>4月21日调整参数重启服务后，在相当长的一段时间内，swap空间占用率极低，但在5月2日又出现swap空间使用率上升的情况。继续看了下jvm堆空间使用情况和full gc情况，如下：</p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20150622%E4%BA%A4%E6%8D%A2%E7%A9%BA%E9%97%B4%E4%BD%BF%E7%94%A8%E7%8E%87%E8%BF%87%E9%AB%98%E9%97%AE%E9%A2%98/4.png" alt=""></p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20150622%E4%BA%A4%E6%8D%A2%E7%A9%BA%E9%97%B4%E4%BD%BF%E7%94%A8%E7%8E%87%E8%BF%87%E9%AB%98%E9%97%AE%E9%A2%98/5.png" alt=""></p>
<p>结合上面两张图，可见young gc较多，jvm堆空间整体使用率稳步上升，在5月2日与5月8日发生了两次full gc，并且每次发生fullgc后，jvm堆空间使用率下降较多，swap空间使用量只有小范围下降。这说明有一部分DirectByteBuffer对象在fullgc阶段做了回收，但依然有很多DirectByteBuffer对象没有被回收，仍然占用着堆外内存。</p>
<p>选择一台机器，继续减小其堆空间，jvm参数为-Xmn2048M -Xms6144M -Xmx6144M -XX:PermSize=512m -XX:MaxPermSize=512m -XX:MaxDirectMemorySize=4096m，经过一段时间观察，交换空间使用率很低，应该没再发生内存页交换了，同时gc频率变高，jvm堆空间的使用率在正常范围，说明DirectByteBuffer对象被更及时的回收了。</p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20150622%E4%BA%A4%E6%8D%A2%E7%A9%BA%E9%97%B4%E4%BD%BF%E7%94%A8%E7%8E%87%E8%BF%87%E9%AB%98%E9%97%AE%E9%A2%98/6.png" alt=""></p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20150622%E4%BA%A4%E6%8D%A2%E7%A9%BA%E9%97%B4%E4%BD%BF%E7%94%A8%E7%8E%87%E8%BF%87%E9%AB%98%E9%97%AE%E9%A2%98/7.png" alt=""></p>
<p><font color="red">由此可见，swap空间占用率高的原因主要还是JVM堆空间太高导致的堆外内存回收不及时。</font></p>
<h2 id="遗留问题"><a class="markdownIt-Anchor" href="#遗留问题"></a> 遗留问题</h2>
<p>看了下kafka-client的源码，接受消息时使用的是ByteBuffer，并没有使用DirectByteBuffer，所以很奇怪，这些大量的DirectByteBuffer对象是从哪生成的？哪里用到的？</p>
<p>运行命令jmap -dump:live,format=b,file=/data/server.dump <pid>，dump出内存快照，并用eclipse mat分析后，发现是zkclient中的一个地方用的，由于dump出的这个快照是问题解决后的内存快照，所以并不能说明问题，如果要找到根本原因，还是需要复现swap空间过高的场景，再做内存快照的dump。</pid></p>
]]></content>
      <categories>
        <category>问题分析</category>
      </categories>
      <tags>
        <tag>swap分区</tag>
        <tag>问题分析</tag>
        <tag>jvm调优</tag>
      </tags>
  </entry>
  <entry>
    <title>使用hexo+gitpage搭建博客</title>
    <url>/20160902/%E4%BD%BF%E7%94%A8hexo-gitpage%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/</url>
    <content><![CDATA[<h2 id="环境准备"><a class="markdownIt-Anchor" href="#环境准备"></a> 环境准备</h2>
<p>系统：mac osx<br>
软件：Node.js，npm，git，hexo<br>
具体安装以及git与github打通的配置就不详述了，可以google到各种方法。</p>
<h2 id="hexo命令"><a class="markdownIt-Anchor" href="#hexo命令"></a> hexo命令</h2>
<p>hexo init &lt;folder&gt;  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #表示执行init命令初始化hexo到你指定的目录<br>
<font color="red">以下命令需要在&lt;folder&gt;目录下执行：</font><br>
hexo generate  &nbsp;&nbsp;&nbsp;#自动根据当前目录下文件,生成静态网页<br>
hexo server &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#运行本地服务</p>
<p>启动服务后，就可以通过访问 <span class="exturl" data-url="aHR0cDovL2xvY2FsaG9zdDo0MDAw">http://localhost:4000<i class="fa fa-external-link-alt"></i></span> 来看看效果了。<br>
接下来，可以使用以下命令来创建一篇新博文：<br>
hexo new “test blog 1”<br>
创建一个名为test blog 1的博客页面，对应的md文件路径是&lt;folder&gt;/source/_posts\test blog <span class="exturl" data-url="aHR0cDovLzEubWQ=">1.md<i class="fa fa-external-link-alt"></i></span></p>
<p>接下来就可以在这个md文件中写文章了，我使用的是MacDown来编辑md文件，支持实时查看页面效果，还是挺好用的。</p>
<h2 id="发布博客"><a class="markdownIt-Anchor" href="#发布博客"></a> 发布博客</h2>
<p>文章写好后，通过以下方式发布到github上。<br>
1.编辑./_config.yml文件，修改以下部分，配置本地内容同步至github：</p>
<blockquote>
<p>deploy:<br>
&nbsp;&nbsp;type: git<br>
&nbsp;&nbsp;repository: <span class="exturl" data-url="bWFpbHRvOmdpdEBnaXRodWIuY29t">git@github.com<i class="fa fa-external-link-alt"></i></span>:maohong/maohong.github.io.git<br>
&nbsp;&nbsp;branch: master</p>
</blockquote>
<p>2.执行hexo generate(hexo g)生成html内容<br>
3.执行hexo deploy(hexo d)讲更新内容发布至guthub</p>
<p>然后就可以访问主页查看效果了，可以使用github帐户名.github.io进行访问, 也可以设置个性域名。</p>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>hexo</tag>
        <tag>gitpage</tag>
      </tags>
  </entry>
  <entry>
    <title>使用httpclient引起的tcp连接数超高问题</title>
    <url>/20150328/%E4%BD%BF%E7%94%A8httpclient%E5%BC%95%E8%B5%B7%E7%9A%84tcp%E8%BF%9E%E6%8E%A5%E6%95%B0%E8%B6%85%E9%AB%98%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<p>组内的一个系统新上线了通过图片url上传图片到图片存储平台的功能。其中使用了httpclient，通过向图片存储平台发送MultipartPostMethod上传图片。当业务量较大时，10个处理线程满负荷运行，上传图片时，发现应用系统服务器的tcp连接数陡然升高，<font color="red">峰值能达到几万个tcp连接数！</font></p>
<p>排查系统代码并结合分析httpclient的源码发现，应用系统每次上传图片时，都会做new HttpClient()操作，这个操作内部默认使用的是SimpleHttpConnectionManager来管理http连接，而SimpleHttpConnectionManager有个默认字段alwaysClose=false，表示当外部程序调用了HttpMethod.releaseConnection()时并不会立即释放连接，而是保持这个连接并尝试用于后续的请求，在连接空闲一段时间后（默认3秒）才真正释放。</p>
<p>因此，当业务量较大，<font color="red">系统高并发发送post请求时，new出来的HttpClient对象会很多，而这个对象使用完毕后，而当中建立的client对象在短时间内并不会立即释放连接</font>，因此，随着时间的积累，tcp连接数保持居高不下。</p>
<p>通过查看官方文档，建议在高并发环境下使用MultiThreadedHttpConnectionManager来管理httpclient，因此，我们将httpclient改为单例后，tcp连接数回复正常水平。</p>
<p>通过管理httpclient的代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> HttpClient <span class="title function_">initHttpClient</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">HttpConnectionManagerParams</span> <span class="variable">params</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpConnectionManagerParams</span>();</span><br><span class="line">    <span class="comment">//指定向每个host发起的最大连接数，默认是2，太少了</span></span><br><span class="line">    params.setDefaultMaxConnectionsPerHost(<span class="number">1000</span>);</span><br><span class="line">    <span class="comment">//指定总共发起的最大连接数，默认是20，太少了</span></span><br><span class="line">    params.setMaxTotalConnections(<span class="number">5000</span>);</span><br><span class="line">    <span class="comment">//连接超时时间-10s</span></span><br><span class="line">    params.setConnectionTimeout(<span class="number">60</span>*<span class="number">1000</span>);</span><br><span class="line">    <span class="comment">//读取数据超时时间-60s</span></span><br><span class="line">    params.setSoTimeout(<span class="number">60</span>*<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">MultiThreadedHttpConnectionManager</span> <span class="variable">manager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MultiThreadedHttpConnectionManager</span>();</span><br><span class="line">    manager.setParams(params);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HttpClient</span>(manager);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>]]></content>
      <categories>
        <category>问题分析</category>
      </categories>
      <tags>
        <tag>httpclient</tag>
        <tag>tcp连接数</tag>
      </tags>
  </entry>
  <entry>
    <title>基于zookeeper的分布式独占锁实现</title>
    <url>/20140513/%E5%9F%BA%E4%BA%8Ezookeeper%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%8B%AC%E5%8D%A0%E9%94%81%E5%AE%9E%E7%8E%B0/</url>
    <content><![CDATA[<h2 id="背景"><a class="markdownIt-Anchor" href="#背景"></a> 背景</h2>
<p>在分布式系统中，经常遇到这样一种场景：选举一个节点执行某一个任务，当此节点宕机后，其他节点可以接管并继续执行这个任务。由于各个节点运行的代码是一样的，彼此之间也是平等的，各个节点如何可以知道自己是否可以执行这个任务呢？当有节点宕机时，又如何判断自己是否可以接管任务呢？在我们的分布式任务调度系统中，需要选取调度器集群中的一个节点进行轮询任务状态，这里使用了zookeeper来实现一个统一的分布式锁，从而选出轮询节点。</p>
<h2 id="原理"><a class="markdownIt-Anchor" href="#原理"></a> 原理</h2>
<p>如图所示，每台服务器启动后，都在同一目录下建一个临时顺序节点（EPHEMERAL_SEQUENTIAL），并获取此目录下的所有节点信息，如果自己的序号是最小的，就认为获取到了锁，可以执行任务。若自己的节点不是最小的，就认为自己没有获取到锁，不执行任务，同时，在比自己小1个序号的节点上增加监听。当比自己小1个序号的节点发生变化的时候，再次检查自己是否是最小序号的节点，如果是则获取锁，否则继续监听比自己小1个序号的节点。</p>
<p><img src="https://raw.githubusercontent.com/maohong/picture/master/20140502-%E5%9F%BA%E4%BA%8Ezookeeper%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E7%8B%AC%E5%8D%A0%E9%94%81%E5%AE%9E%E7%8E%B0/1.jpg" alt=""></p>
<h2 id="实现"><a class="markdownIt-Anchor" href="#实现"></a> 实现</h2>
<p>以下是一个demo实现程序：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributedExclusiveLock</span> <span class="keyword">implements</span> <span class="title class_">Watcher</span></span><br><span class="line">{</span><br><span class="line">	<span class="keyword">private</span> ZooKeeper zk;</span><br><span class="line">	<span class="keyword">private</span> <span class="type">String</span> <span class="variable">lockDir</span> <span class="operator">=</span> <span class="string">"/testlock"</span>;<span class="comment">//锁节点所在zk的目录</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">String</span> <span class="variable">lockSymbol</span> <span class="operator">=</span> <span class="string">"_lock_"</span>;<span class="comment">//锁节点标志</span></span><br><span class="line">	<span class="keyword">private</span> String lockName;<span class="comment">//锁节点前缀，构造锁时由外部传入</span></span><br><span class="line">	<span class="keyword">private</span> String waitNodePath;<span class="comment">//等待的前一个锁的节点名称</span></span><br><span class="line">	<span class="keyword">private</span> String myNodePath;<span class="comment">//当前锁</span></span><br><span class="line">	<span class="keyword">private</span> CountDownLatch latch;<span class="comment">//计数器</span></span><br><span class="line">	<span class="keyword">private</span> String threadId;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 创建分布式锁</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> lockName 竞争资源标志,lockName中不能包含单词lock</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">DistributedExclusiveLock</span><span class="params">(String zkServers, String lockName)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">	{</span><br><span class="line">		<span class="comment">//简单校验lockDir路径</span></span><br><span class="line">		<span class="keyword">if</span> (!lockDir.startsWith(<span class="string">"/"</span>))</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">"LockDir Path must start with / character! lockDir="</span> + lockDir);</span><br><span class="line">		<span class="keyword">if</span> (lockDir.endsWith(<span class="string">"/"</span>))</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">"LockDir Path must not end with / character! lockDir="</span> + lockDir);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">this</span>.lockName = lockName;</span><br><span class="line">		<span class="built_in">this</span>.threadId = getThreadId();</span><br><span class="line">		<span class="comment">// 创建一个与服务器的连接</span></span><br><span class="line">		<span class="keyword">try</span></span><br><span class="line">		{</span><br><span class="line">			zk = <span class="keyword">new</span> <span class="title class_">ZooKeeper</span>(zkServers, <span class="number">3000</span>, <span class="built_in">this</span>);</span><br><span class="line">			createLockDirIfNecessary(lockDir);</span><br><span class="line">		} <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">"Error while initializing DistributedExclusiveLock!"</span> + e.getMessage(), e);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String <span class="title function_">getThreadId</span><span class="params">()</span></span><br><span class="line">	{</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"Thread-"</span> + Thread.currentThread().getId();</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 在zk上建立lock目录，如果目录不存在，逐级创建节点</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">createLockDirIfNecessary</span><span class="params">(String zkDir)</span> <span class="keyword">throws</span> KeeperException, InterruptedException</span><br><span class="line">	{</span><br><span class="line">		<span class="comment">//zkDir是一级节点，如/cloudscheduler</span></span><br><span class="line">		<span class="keyword">if</span> (zkDir.indexOf(<span class="string">"/"</span>) == zkDir.lastIndexOf(<span class="string">"/"</span>))</span><br><span class="line">		{</span><br><span class="line">			<span class="type">Stat</span> <span class="variable">stat</span> <span class="operator">=</span> zk.exists(zkDir, <span class="literal">false</span>);</span><br><span class="line">			<span class="keyword">if</span>(stat == <span class="literal">null</span>){</span><br><span class="line">				<span class="comment">// 创建一级节点</span></span><br><span class="line">				zk.create(zkDir, <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>], Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">else</span>	<span class="comment">//zkDir非一级节点</span></span><br><span class="line">		{</span><br><span class="line">			<span class="type">String</span> <span class="variable">parentDir</span> <span class="operator">=</span> zkDir.substring(<span class="number">0</span>, zkDir.lastIndexOf(<span class="string">"/"</span>));</span><br><span class="line">			<span class="keyword">if</span> (zk.exists(parentDir, <span class="literal">false</span>) != <span class="literal">null</span>)</span><br><span class="line">			{	<span class="comment">//如果父节点存在，建当前节点</span></span><br><span class="line">				<span class="type">Stat</span> <span class="variable">stat</span> <span class="operator">=</span> zk.exists(zkDir, <span class="literal">false</span>);</span><br><span class="line">				<span class="keyword">if</span>(stat == <span class="literal">null</span>){</span><br><span class="line">					<span class="comment">// 创建非一级节点</span></span><br><span class="line">					zk.create(zkDir, <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>], Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			{	<span class="comment">//否则，先建父节点，再建当前节点</span></span><br><span class="line">				createLockDirIfNecessary(parentDir);</span><br><span class="line">				createLockDirIfNecessary(zkDir);</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * zookeeper节点的监视器</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(WatchedEvent event)</span></span><br><span class="line">	{</span><br><span class="line">		<span class="keyword">if</span> (event.getType() == EventType.NodeDeleted)</span><br><span class="line">		{</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">this</span>.latch!=<span class="literal">null</span>)</span><br><span class="line">				<span class="built_in">this</span>.latch.countDown();</span><br><span class="line">			<span class="keyword">try</span></span><br><span class="line">			{</span><br><span class="line">				List&lt;String&gt; childrenNodes = zk.getChildren(lockDir, <span class="literal">false</span>);</span><br><span class="line">				<span class="comment">// 排序</span></span><br><span class="line">				Collections.sort(childrenNodes);</span><br><span class="line">				System.out.println(<span class="string">"Node: "</span> + event.getPath()</span><br><span class="line">						+ <span class="string">" change event is deleted! Current locked nodes:\n\t"</span></span><br><span class="line">						+ StringUtils.join(childrenNodes,<span class="string">"\n\t"</span>));</span><br><span class="line">			}</span><br><span class="line">			<span class="keyword">catch</span> (KeeperException e)</span><br><span class="line">			{</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			}</span><br><span class="line">			<span class="keyword">catch</span> (InterruptedException e)</span><br><span class="line">			{</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">()</span></span><br><span class="line">	{</span><br><span class="line">		<span class="keyword">try</span></span><br><span class="line">		{</span><br><span class="line">			<span class="keyword">if</span>(tryLockInner())</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				<span class="keyword">return</span> waitForLockInner(waitNodePath);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">catch</span> (Exception e)</span><br><span class="line">		{</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">tryLockInner</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span><br><span class="line">	{</span><br><span class="line">		<span class="keyword">try</span></span><br><span class="line">		{</span><br><span class="line">			<span class="keyword">if</span>(lockName.contains(lockSymbol))</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">"lockName can not contains "</span> + lockSymbol);</span><br><span class="line">			<span class="comment">//创建临时子节点</span></span><br><span class="line">			myNodePath = zk.create(lockDir + <span class="string">"/"</span> + lockName + lockSymbol, <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>], Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL);</span><br><span class="line">			System.out.println(threadId + <span class="string">" created "</span> + myNodePath);</span><br><span class="line">			<span class="comment">//取出所有子节点</span></span><br><span class="line">			List&lt;String&gt; subNodes = zk.getChildren(lockDir, <span class="literal">false</span>);</span><br><span class="line">			<span class="comment">//取出所有lockName的锁</span></span><br><span class="line">			List&lt;String&gt; lockedNodes = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line">			<span class="keyword">for</span> (String node : subNodes) {</span><br><span class="line">				<span class="type">String</span> <span class="variable">nodePrefix</span> <span class="operator">=</span> node.split(lockSymbol)[<span class="number">0</span>];</span><br><span class="line">				<span class="keyword">if</span>(nodePrefix.equals(lockName)){<span class="comment">//对锁名做个判断，前缀相同即为同一组锁</span></span><br><span class="line">					lockedNodes.add(node);</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line">			Collections.sort(lockedNodes);</span><br><span class="line">			System.out.println(<span class="string">"Current locked nodes: \n\t"</span> + StringUtils.join(lockedNodes, <span class="string">"\n\t"</span>));</span><br><span class="line">			<span class="keyword">if</span>(myNodePath.equals(lockDir + <span class="string">"/"</span> + lockedNodes.get(<span class="number">0</span>))){</span><br><span class="line">				<span class="comment">//如果是最小的节点,则表示取得锁</span></span><br><span class="line">	            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	        }</span><br><span class="line">			<span class="comment">//如果不是最小的节点，找到比自己小1的节点，在List中的位置是自己的前一位</span></span><br><span class="line">			<span class="type">String</span> <span class="variable">myZnodeName</span> <span class="operator">=</span> myNodePath.substring(myNodePath.lastIndexOf(<span class="string">"/"</span>) + <span class="number">1</span>);</span><br><span class="line">			waitNodePath = lockDir + <span class="string">"/"</span> + lockedNodes.get(lockedNodes.indexOf(myZnodeName)-<span class="number">1</span>);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">catch</span> (KeeperException e)</span><br><span class="line">		{</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">catch</span> (InterruptedException e)</span><br><span class="line">		{</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">waitForLockInner</span><span class="params">(String waitPath)</span> <span class="keyword">throws</span> InterruptedException, KeeperException {</span><br><span class="line">        <span class="type">Stat</span> <span class="variable">stat</span> <span class="operator">=</span> zk.exists(waitPath, <span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//判断比自己小一个数的节点是否存在,如果存在则需等待锁,同时注册监听</span></span><br><span class="line">        <span class="keyword">if</span> (stat != <span class="literal">null</span>)</span><br><span class="line">        {</span><br><span class="line">        	System.out.println(threadId + <span class="string">" waiting for "</span> + waitPath);</span><br><span class="line">        	<span class="built_in">this</span>.latch = <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line">        	<span class="built_in">this</span>.latch.await(); <span class="comment">//不加超时时间，无限等待</span></span><br><span class="line">        	<span class="comment">//</span></span><br><span class="line">        	<span class="comment">//waiting</span></span><br><span class="line">        	<span class="comment">//Zzzzz...</span></span><br><span class="line">        	<span class="comment">//still waiting</span></span><br><span class="line">        	<span class="comment">//</span></span><br><span class="line">        	<span class="comment">// 探测到节点变化，刷新节点信息</span></span><br><span class="line">        	<span class="built_in">this</span>.latch = <span class="literal">null</span>;</span><br><span class="line">        	<span class="keyword">try</span></span><br><span class="line">			{</span><br><span class="line">				<span class="comment">// 确认myNodePath是否真的是列表中的最小节点</span></span><br><span class="line">				List&lt;String&gt; childrenNodes = zk.getChildren(lockDir, <span class="literal">false</span>);</span><br><span class="line">				<span class="comment">// 排序</span></span><br><span class="line">				Collections.sort(childrenNodes);</span><br><span class="line">				<span class="keyword">if</span>(myNodePath.equals(lockDir + <span class="string">"/"</span> + childrenNodes.get(<span class="number">0</span>)))</span><br><span class="line">					<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				{</span><br><span class="line">				    <span class="comment">// 说明waitNodePath是由于出现异常而挂掉的 , 更新waitNodePath</span></span><br><span class="line">					<span class="type">String</span> <span class="variable">thisNodeName</span> <span class="operator">=</span> myNodePath.substring(myNodePath.lastIndexOf(<span class="string">"/"</span>) + <span class="number">1</span>);</span><br><span class="line">					<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> childrenNodes.indexOf(thisNodeName);</span><br><span class="line">					waitNodePath = lockDir + <span class="string">"/"</span> + childrenNodes.get(index - <span class="number">1</span>);</span><br><span class="line">					<span class="comment">//重新等待锁</span></span><br><span class="line">					<span class="keyword">return</span> waitForLockInner(waitNodePath);</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line">			<span class="keyword">catch</span> (KeeperException e)</span><br><span class="line">			{</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">			}</span><br><span class="line">			<span class="keyword">catch</span> (InterruptedException e)</span><br><span class="line">			{</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">			}</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span><br><span class="line">	{</span><br><span class="line">		<span class="keyword">try</span></span><br><span class="line">		{</span><br><span class="line">			System.out.println(threadId + <span class="string">" unlock "</span> + myNodePath);</span><br><span class="line">			zk.delete(myNodePath,-<span class="number">1</span>);</span><br><span class="line">			myNodePath = <span class="literal">null</span>;</span><br><span class="line">			zk.close();</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">catch</span> (InterruptedException e)</span><br><span class="line">		{</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">"Error while releasing lock! "</span> + e.getMessage(), e);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">catch</span> (KeeperException e)</span><br><span class="line">		{</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">"Error while releasing lock! "</span> + e.getMessage(), e);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">	{</span><br><span class="line">	        <span class="comment">//一个简单的测试</span></span><br><span class="line">		List&lt;Thread&gt; workers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Thread&gt;(<span class="number">10</span>);</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span>; i&lt;<span class="number">10</span>; ++i)</span><br><span class="line">		{</span><br><span class="line">			<span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>()</span><br><span class="line">			{</span><br><span class="line">				<span class="type">String</span> <span class="variable">zk</span> <span class="operator">=</span> <span class="string">"10.12.10.169:2181,10.12.139.141:2181"</span>;</span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span></span><br><span class="line">				{</span><br><span class="line">					<span class="keyword">try</span></span><br><span class="line">					{</span><br><span class="line">						<span class="type">DistributedExclusiveLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DistributedExclusiveLock</span>(zk, <span class="string">"zkLock"</span>);</span><br><span class="line">						<span class="keyword">if</span> (lock.tryLock());</span><br><span class="line">						{</span><br><span class="line">							<span class="type">String</span> <span class="variable">tid</span> <span class="operator">=</span> <span class="string">"Thread-"</span> + Thread.currentThread().getId();</span><br><span class="line">							<span class="type">int</span> <span class="variable">time</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">5000</span>);</span><br><span class="line">							System.out.println(tid + <span class="string">" gets lock and is working, sleep for "</span> + time + <span class="string">" ms"</span>);</span><br><span class="line">							Thread.sleep(time);</span><br><span class="line">							lock.unlock();</span><br><span class="line">							System.out.println(tid + <span class="string">" releases lock"</span>);</span><br><span class="line">						}</span><br><span class="line">					}</span><br><span class="line">					<span class="keyword">catch</span> (Exception e)</span><br><span class="line">					{</span><br><span class="line">						e.printStackTrace();</span><br><span class="line">					}</span><br><span class="line">				}</span><br><span class="line">			});</span><br><span class="line">			thread.setDaemon(<span class="literal">true</span>);</span><br><span class="line">			workers.add(thread);</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (Thread t : workers)</span><br><span class="line">		{</span><br><span class="line">			t.start();</span><br><span class="line">		}</span><br><span class="line">		Thread.sleep(<span class="number">100000</span>);</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
]]></content>
      <categories>
        <category>分布式应用</category>
      </categories>
      <tags>
        <tag>zookeeper</tag>
        <tag>分布式应用</tag>
        <tag>分布式协调</tag>
      </tags>
  </entry>
  <entry>
    <title>使用zookeeper协调多服务器的任务处理</title>
    <url>/20131113/%E4%BD%BF%E7%94%A8zookeeper%E5%8D%8F%E8%B0%83%E5%A4%9A%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E4%BB%BB%E5%8A%A1%E5%A4%84%E7%90%86/</url>
    <content><![CDATA[<h2 id="背景"><a class="markdownIt-Anchor" href="#背景"></a> 背景</h2>
<p><strong>Zookeeper</strong>是hadoop的子项目，是google的chubby的开源实现，是一个针对大规模分布式系统的可靠的分布式协调系统。Zookeeper一般部署在一个集群上，通过在集群间维护一个数据树，使得连接到集群的client能够获得统一的数据信息，比如系统公共配置信息、节点存活状态等等。因此，在互联网公司中，zookeeper被广泛运用于统一配置管理、名字服务、分布式同步等。</p>
<h2 id="问题"><a class="markdownIt-Anchor" href="#问题"></a> 问题</h2>
<p>我们看下这样一种场景：<br>
前台系统每时每刻都生成大量数据，这些原生数据由后台系统处理完毕后再作他用，我们暂且不谈这些数据的存储形式，只关注如何能够尽可能高效的处理。举个例子，前台系统可能是微博的前端发布系统、搜索引擎上的广告投放系统，或者是任务发布系统，后台系统则可能是对微博和广告信息的审查系统，比如用户发的微博如果包含近期敏感信息则不予显示，若是任务，后台系统则负责处理任务具体的执行。<br>
若数据量和任务量较小，单节点的后台系统或许可以处理得过来，但是如果数据量和任务量很大（比如新浪微博，龙年正月初一0点0分0秒，共有32312条微博同时发布），单节点的后台系统肯定吃不消，这时候，可想而知的是多节点同时处理前台过来的数据。<br>
最简单的方法是，按消息id对后台节点数取模（msgid%server_num=mod），每个后台节点取自己那份数据进行处理，这就需要每个节点都知晓当前有多少个后台节点以及本节点所应取的mod数。但是，当某个节点宕机时，这个节点所应处理的数据无法被继续处理了，势必会造成阻塞，除非重新配置各节点上的参数，将节点数server_num减1，并修改各节点取数据的mod数。<br>
毋庸置疑，这样非常麻烦！如果能够将这种配置信息（实际上是数据在节点间分配的控制信息）统一管理起来，在配置信息发生变化时，各个后台节点能够及时知晓其变化，就可以避免上述情况的发生。<br>
因此，采用多节点处理数据时，有两个问题：<br>
1.避免多个节点重复处理同一条数据，否则造成资源浪费。<br>
2.不能有数据被遗漏处理，尤其是在有后台节点down掉的时候。<br>
也就是说，采用多节点同时处理数据时，需要将数据隔离开，分别给不同的节点处理，而且在有节点宕机的情况下，所有数据也必须可以无误的被其他可用节点处理。如何做到这一点呢，使用zookeeper吧！</p>
<span id="more"></span>
<h2 id="解决方案"><a class="markdownIt-Anchor" href="#解决方案"></a> 解决方案</h2>
<p>我们通过zookeeper维护一个目录（比如/app/config），服务器启动时连接zookeeper集群并在该目录下创建表示自己的临时节点（CreateMode.EPHEMERAL），相当于注册一个节点，节点名可以是本服务器的ip，节点的值为该服务器的mod值，按注册顺序从0递增，即第一个注册的节点值为0，第二个为1，依次下去，因此/app/config的子节点数就是注册到zookeeper的服务器数。同时，各服务器监听/app/config目录，当其发生变化（新加入子节点、子节点失效等）时，每个服务器都将获取到这个事件并进行相应的处理。</p>
<h2 id="demo"><a class="markdownIt-Anchor" href="#demo"></a> demo</h2>
<p>下面针对以上场景给出一个示例demo。<br>
<strong>Server类</strong>：服务器<br>
<strong>ClientThread类</strong>：服务器上的单个线程<br>
<strong>NodeStateWatcher类</strong>：服务器监听zookeeper集群的监听器<br>
<strong>ZkOperationImpl类</strong>：zookeeper的操作封装（实现ZkOperation接口）</p>
<p>Server.java</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Server</span> <span class="keyword">extends</span> <span class="title class_">Thread</span></span><br><span class="line">{</span><br><span class="line"> <span class="keyword">private</span> ClientThread[] clients = <span class="keyword">new</span> <span class="title class_">ClientThread</span>[Constant.THREAD_COUNT]; <span class="comment">// 数据处理线程</span></span><br><span class="line"> <span class="keyword">private</span> <span class="type">ZkOperation</span> <span class="variable">operationCient</span> <span class="operator">=</span> <span class="literal">null</span>; <span class="comment">// 与zookeeper的连接</span></span><br><span class="line"> <span class="keyword">private</span> <span class="type">Watcher</span> <span class="variable">nodeWatcher</span> <span class="operator">=</span> <span class="literal">null</span>;  <span class="comment">// 向zookeeper注册的监听器</span></span><br><span class="line"> <span class="keyword">private</span> String name; <span class="comment">// 服务器名</span></span><br><span class="line"> <span class="keyword">private</span> String ip; <span class="comment">// 服务器ip</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> <span class="title function_">Server</span><span class="params">(String name, String ip)</span> <span class="keyword">throws</span> IOException, KeeperException, InterruptedException</span><br><span class="line"> {</span><br><span class="line">  <span class="built_in">this</span>.name = name;</span><br><span class="line">  <span class="built_in">this</span>.ip = ip;</span><br><span class="line">  <span class="built_in">this</span>.operationCient = <span class="keyword">new</span> <span class="title class_">ZkOperationImpl</span>();</span><br><span class="line">  <span class="built_in">this</span>.nodeWatcher = <span class="keyword">new</span> <span class="title class_">NodeStateWatcher</span>(<span class="built_in">this</span>);</span><br><span class="line">  <span class="built_in">this</span>.operationCient.init(Constant.ZK_ADDRESS, nodeWatcher);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;Constant.THREAD_COUNT; ++i)</span><br><span class="line">  {</span><br><span class="line">   <span class="type">ClientThread</span> <span class="variable">c</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClientThread</span>(i, ip, name);</span><br><span class="line">   <span class="built_in">this</span>.clients[i]= c;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  initialize();</span><br><span class="line"> }</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 向zookeeper集群注册</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@throws</span> KeeperException</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">registerServer</span><span class="params">()</span> <span class="keyword">throws</span> KeeperException, InterruptedException</span><br><span class="line"> {</span><br><span class="line">  List&lt;String&gt; children = operationCient.getChilds(Constant.ROOT_PATH);</span><br><span class="line">  <span class="type">int</span> <span class="variable">max</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span> (String childName : children)</span><br><span class="line">  {</span><br><span class="line">   <span class="type">String</span> <span class="variable">childPath</span> <span class="operator">=</span> Constant.ROOT_PATH + <span class="string">"/"</span> + childName;</span><br><span class="line">   <span class="type">int</span> <span class="variable">mod</span> <span class="operator">=</span> Integer.parseInt(operationCient.getData(childPath));</span><br><span class="line">   <span class="keyword">if</span> (mod &gt; max)</span><br><span class="line">    max = mod;</span><br><span class="line">  }</span><br><span class="line">  <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> Constant.ROOT_PATH + <span class="string">"/"</span> + ip;</span><br><span class="line">  operationCient.apendTempNode(path, String.valueOf(max&lt;<span class="number">0</span> ? <span class="number">0</span> : ++max));</span><br><span class="line"> }</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 启动数据处理线程</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span></span><br><span class="line"> {</span><br><span class="line">  <span class="keyword">for</span> (ClientThread c : clients)</span><br><span class="line">  {</span><br><span class="line">   CommonUtil.log(<span class="string">"Start thread-"</span> + c);</span><br><span class="line">   c.start();</span><br><span class="line">  }</span><br><span class="line"> }</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 服务器初始化</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@throws</span> KeeperException</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">()</span> <span class="keyword">throws</span> KeeperException, InterruptedException</span><br><span class="line"> {</span><br><span class="line">  CommonUtil.log(<span class="string">"================"</span>);</span><br><span class="line">  CommonUtil.log(<span class="built_in">this</span> + <span class="string">" initializing..."</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 配置信息的上级目录不存在</span></span><br><span class="line">  <span class="keyword">if</span> (!operationCient.exist(Constant.ROOT_PATH))</span><br><span class="line">  {</span><br><span class="line">   System.err.println(<span class="string">"Root path "</span> + Constant.ROOT_PATH + <span class="string">"does not exist!!! Create root path..."</span>);</span><br><span class="line">   operationCient.apendPresistentNode(Constant.ROOT_PATH, <span class="string">"1"</span>);</span><br><span class="line">   CommonUtil.log(<span class="string">"Create root path "</span> + Constant.ROOT_PATH + <span class="string">" successfully!"</span>);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  registerServer();</span><br><span class="line"></span><br><span class="line">  refreshConfig();</span><br><span class="line"></span><br><span class="line">  CommonUtil.log(<span class="built_in">this</span> + <span class="string">" finish initializing..."</span>);</span><br><span class="line">  CommonUtil.log(<span class="string">"================"</span>);</span><br><span class="line"> }</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * watch到节点变化后，刷新节点数和模数</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@throws</span> KeeperException</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">()</span> <span class="keyword">throws</span> KeeperException, InterruptedException</span><br><span class="line"> {</span><br><span class="line">  CommonUtil.log(<span class="string">"================"</span>);</span><br><span class="line">  CommonUtil.log(<span class="built_in">this</span> + <span class="string">":freshing..."</span>);</span><br><span class="line"></span><br><span class="line">  refreshConfig();</span><br><span class="line"></span><br><span class="line">  CommonUtil.log(<span class="built_in">this</span> + <span class="string">":end freshing..."</span>);</span><br><span class="line">  CommonUtil.log(<span class="string">"================"</span>);</span><br><span class="line"> }</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">refreshConfig</span><span class="params">()</span> <span class="keyword">throws</span> KeeperException, InterruptedException</span><br><span class="line"> {</span><br><span class="line">  <span class="type">String</span> <span class="variable">version</span> <span class="operator">=</span> operationCient.getData(Constant.ROOT_PATH);</span><br><span class="line">  CommonUtil.log(<span class="string">"SYSTEM VERSION: "</span> + version);</span><br><span class="line">  List&lt;String&gt; children = operationCient.getChilds(Constant.ROOT_PATH);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 1. 服务器数量为子节点的个数</span></span><br><span class="line">  <span class="type">int</span> <span class="variable">nodeCount</span> <span class="operator">=</span> children.size();</span><br><span class="line">  CommonUtil.log(<span class="string">"Server count:"</span> + nodeCount);</span><br><span class="line">  <span class="keyword">synchronized</span> (CommonUtil.BASE)</span><br><span class="line">  {</span><br><span class="line">   CommonUtil.BASE = nodeCount * Constant.THREAD_COUNT;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (CommonUtil.BASE.intValue() == <span class="number">0</span>)</span><br><span class="line">   <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">Integer</span> <span class="variable">mod</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (String childName : children)</span><br><span class="line">  {</span><br><span class="line">   <span class="comment">// 2. 获取本服务器的模数</span></span><br><span class="line">   <span class="keyword">if</span> (childName.equals(ip))</span><br><span class="line">   {</span><br><span class="line">    <span class="type">String</span> <span class="variable">childPath</span> <span class="operator">=</span> Constant.ROOT_PATH + <span class="string">"/"</span> + childName;</span><br><span class="line">    mod = Integer.parseInt(operationCient.getData(childPath));</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">   }</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// 3. 刷新数据处理线程的取模数</span></span><br><span class="line">  <span class="keyword">if</span> (mod == <span class="literal">null</span>)</span><br><span class="line">  {</span><br><span class="line">   System.err.println(<span class="string">"Did not get the mod number for "</span> + <span class="built_in">this</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  {</span><br><span class="line">   CommonUtil.log(<span class="built_in">this</span> + <span class="string">", mod="</span> + mod + <span class="string">",base="</span> + CommonUtil.BASE);</span><br><span class="line">   <span class="keyword">for</span> (ClientThread c : clients)</span><br><span class="line">   {</span><br><span class="line">    c.refresh(mod);</span><br><span class="line">   }</span><br><span class="line">  }</span><br><span class="line"> }</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span></span><br><span class="line"> {</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">this</span>.name + <span class="string">"@"</span> + <span class="built_in">this</span>.ip + <span class="string">""</span>;</span><br><span class="line"> }</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> ClientThread[] getClients()</span><br><span class="line"> {</span><br><span class="line">  <span class="keyword">return</span> clients;</span><br><span class="line"> }</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> ZkOperation <span class="title function_">getOperationCient</span><span class="params">()</span></span><br><span class="line"> {</span><br><span class="line">  <span class="keyword">return</span> operationCient;</span><br><span class="line"> }</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> Watcher <span class="title function_">getNodeWatcher</span><span class="params">()</span></span><br><span class="line"> {</span><br><span class="line">  <span class="keyword">return</span> nodeWatcher;</span><br><span class="line"> }</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> String <span class="title function_">getIp</span><span class="params">()</span></span><br><span class="line"> {</span><br><span class="line">  <span class="keyword">return</span> ip;</span><br><span class="line"> }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>ClientThread.java</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClientThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span></span><br><span class="line">{</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">modNum</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line"> <span class="keyword">private</span> Integer threadId;</span><br><span class="line"> <span class="keyword">private</span> String ip;</span><br><span class="line"> <span class="keyword">private</span> String clientName;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> <span class="title function_">ClientThread</span><span class="params">(Integer threadId, String ip, String clientName)</span> <span class="keyword">throws</span> IOException, KeeperException, InterruptedException</span><br><span class="line"> {</span><br><span class="line">  <span class="built_in">this</span>.threadId = threadId;</span><br><span class="line">  <span class="built_in">this</span>.ip = ip;</span><br><span class="line">  <span class="built_in">this</span>.clientName = clientName;</span><br><span class="line"> }</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * watch到节点变化后，调用刷新节点数和模数</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@throws</span> InterruptedException</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@throws</span> KeeperException</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">(<span class="type">int</span> mod)</span> <span class="keyword">throws</span> KeeperException, InterruptedException</span><br><span class="line"> {</span><br><span class="line"><span class="comment">//  CommonUtil.log("================");</span></span><br><span class="line"><span class="comment">//  CommonUtil.log(this + ":freshing...");</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="built_in">this</span>.modNum)</span><br><span class="line">  {</span><br><span class="line">   <span class="built_in">this</span>.modNum = threadId + mod * Constant.THREAD_COUNT;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  CommonUtil.log(<span class="built_in">this</span> + <span class="string">":"</span> + modNum + <span class="string">"/"</span> + CommonUtil.BASE);</span><br><span class="line"></span><br><span class="line"><span class="comment">//  CommonUtil.log(this + ":end freshing...");</span></span><br><span class="line"><span class="comment">//  CommonUtil.log("================");</span></span><br><span class="line"> }</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span></span><br><span class="line"> {</span><br><span class="line">  <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">  <span class="keyword">while</span> (System.currentTimeMillis() - start &lt; Constant.DURATION)</span><br><span class="line">  {</span><br><span class="line">   <span class="comment">// 处理数据</span></span><br><span class="line">   processData();</span><br><span class="line">   <span class="keyword">try</span></span><br><span class="line">   {</span><br><span class="line">    Thread.sleep(<span class="number">5000</span>); <span class="comment">//等待2秒</span></span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">catch</span> (InterruptedException e)</span><br><span class="line">   {</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">   }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line"> }</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 模拟处理数据逻辑：打印属于本线程的数据</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processData</span><span class="params">()</span></span><br><span class="line"> {</span><br><span class="line">  <span class="keyword">if</span> (CommonUtil.BASE.equals(<span class="number">0</span>) || modNum.equals(-<span class="number">1</span>))</span><br><span class="line">  {</span><br><span class="line">   CommonUtil.err(<span class="built_in">this</span> + <span class="string">": did not get server_count and modNum!!!"</span>);</span><br><span class="line">   <span class="keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="built_in">this</span> + <span class="string">"-"</span> + modNum + <span class="string">"/"</span> + CommonUtil.BASE + <span class="string">":"</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;Constant.NUMBERS.length; ++i)</span><br><span class="line">  {</span><br><span class="line">   <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> Constant.NUMBERS[i];</span><br><span class="line">   <span class="keyword">if</span> (n % CommonUtil.BASE == modNum)</span><br><span class="line">   {</span><br><span class="line">    sb.append(n).append(<span class="string">" "</span>);</span><br><span class="line">   }</span><br><span class="line">  }</span><br><span class="line">  CommonUtil.log(sb.toString());</span><br><span class="line"> }</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span></span><br><span class="line"> {</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"ClientThread_"</span> + <span class="built_in">this</span>.clientName + <span class="string">"@"</span> + <span class="built_in">this</span>.ip + <span class="string">"-thread_"</span> + <span class="built_in">this</span>.threadId;</span><br><span class="line"> }</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> Integer <span class="title function_">getModNum</span><span class="params">()</span></span><br><span class="line"> {</span><br><span class="line">  <span class="keyword">return</span> modNum;</span><br><span class="line"> }</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">setModNum</span><span class="params">(Integer modNum)</span></span><br><span class="line"> {</span><br><span class="line">  <span class="built_in">this</span>.modNum = modNum;</span><br><span class="line"> }</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> String <span class="title function_">getClientName</span><span class="params">()</span></span><br><span class="line"> {</span><br><span class="line">  <span class="keyword">return</span> clientName;</span><br><span class="line"> }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>NodeStateWatcher.java</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NodeStateWatcher</span> <span class="keyword">implements</span> <span class="title class_">Watcher</span></span><br><span class="line">{</span><br><span class="line"> <span class="keyword">private</span> Server server;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> <span class="title function_">NodeStateWatcher</span><span class="params">(Server server)</span></span><br><span class="line"> {</span><br><span class="line">  <span class="built_in">this</span>.server = server;</span><br><span class="line"> }</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(WatchedEvent event)</span></span><br><span class="line"> {</span><br><span class="line">  <span class="type">StringBuilder</span> <span class="variable">outputStr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">  <span class="keyword">if</span> (server.getName() != <span class="literal">null</span>)</span><br><span class="line">  {</span><br><span class="line">   outputStr.append(server.getName() + <span class="string">" get an event."</span>);</span><br><span class="line">  }</span><br><span class="line">  outputStr.append(<span class="string">"Path:"</span> + event.getPath());</span><br><span class="line">  outputStr.append(<span class="string">",state:"</span> + event.getState());</span><br><span class="line">  outputStr.append(<span class="string">",type:"</span> + event.getType());</span><br><span class="line">  CommonUtil.log(outputStr.toString());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 发现子节点有变化</span></span><br><span class="line">  <span class="keyword">if</span> (event.getType() == EventType.NodeChildrenChanged</span><br><span class="line">    || event.getType() == EventType.NodeDataChanged</span><br><span class="line">    || event.getType() == EventType.NodeDeleted)</span><br><span class="line">  {</span><br><span class="line">   CommonUtil.log(<span class="string">"In event: "</span> + event.getType());</span><br><span class="line">   <span class="keyword">try</span></span><br><span class="line">   {</span><br><span class="line">    server.refresh();</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">catch</span> (KeeperException e)</span><br><span class="line">   {</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">catch</span> (InterruptedException e)</span><br><span class="line">   {</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">   }</span><br><span class="line">   CommonUtil.log(<span class="string">"End event: "</span> + event.getType());</span><br><span class="line">  }</span><br><span class="line"> }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>ZkOperationImpl.java 部分zk操作代码</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">apendPresistentNode</span><span class="params">(String path, String data)</span></span><br><span class="line">   <span class="keyword">throws</span> KeeperException, InterruptedException</span><br><span class="line"> {</span><br><span class="line">  <span class="keyword">if</span> (zk != <span class="literal">null</span>)</span><br><span class="line">  {</span><br><span class="line">   zk.create(path, data.getBytes(), Ids.OPEN_ACL_UNSAFE,</span><br><span class="line">     CreateMode.PERSISTENT);</span><br><span class="line">  }</span><br><span class="line"> }</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delNode</span><span class="params">(String path)</span> <span class="keyword">throws</span> KeeperException,</span><br><span class="line">   InterruptedException</span><br><span class="line"> {</span><br><span class="line">  <span class="keyword">if</span> (zk != <span class="literal">null</span>)</span><br><span class="line">  {</span><br><span class="line">   zk.delete(path, -<span class="number">1</span>);</span><br><span class="line">  }</span><br><span class="line"> }</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">exist</span><span class="params">(String path)</span> <span class="keyword">throws</span> KeeperException,</span><br><span class="line">   InterruptedException</span><br><span class="line"> {</span><br><span class="line">  <span class="keyword">if</span> (zk != <span class="literal">null</span>)</span><br><span class="line">  {</span><br><span class="line">   <span class="keyword">return</span> zk.exists(path, <span class="literal">true</span>) != <span class="literal">null</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"> }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Main.java：主类，启动demo</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span></span><br><span class="line">{</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span><br><span class="line"> {</span><br><span class="line">  <span class="type">Server</span> <span class="variable">c1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Server</span>(<span class="string">"ServerA"</span>, <span class="string">"1.1.1.1"</span>);</span><br><span class="line">  <span class="type">Server</span> <span class="variable">c2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Server</span>(<span class="string">"ServerB"</span>, <span class="string">"1.1.1.2"</span>);</span><br><span class="line">  <span class="type">Server</span> <span class="variable">c3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Server</span>(<span class="string">"ServerC"</span>, <span class="string">"1.1.1.3"</span>);</span><br><span class="line"></span><br><span class="line">  c1.start();</span><br><span class="line">  c2.start();</span><br><span class="line">  c3.start();</span><br><span class="line"> }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="验证"><a class="markdownIt-Anchor" href="#验证"></a> 验证</h2>
<p>由于Server的3个实例在同一台机器上运行，连接到zookeeper时，用的是一个session，所以demo中没有通过程序断开server与zookeeper的连接，如果serverA断开，那么serverB和serverC与zookeeper的session连接也会失效，达不到演示效果，所以我们只能暂时在zookeeper客户端手工更改zookeeper上的配置信息，用于模拟server与zookeeper集群断开连接和增加server的情形。server启动后，会先向zookeeper注册节点，因此我们先手工删除节点，再手工添加节点。<br>
手工执行的命令如下：</p>
<blockquote>
<p>[zk: localhost:2181(CONNECTED) 141] delete /demo/1.1.1.3<br>
[zk: localhost:2181(CONNECTED) 142] delete /demo/1.1.1.2<br>
[zk: localhost:2181(CONNECTED) 143] delete /demo/1.1.1.1<br>
[zk: localhost:2181(CONNECTED) 144] create -e /demo/1.1.1.1 0<br>
[zk: localhost:2181(CONNECTED) 145] create -e /demo/1.1.1.2 1<br>
[zk: localhost:2181(CONNECTED) 146] create -e /demo/1.1.1.3 2</p>
</blockquote>
<p>可以通过程序打印信息发现，在节点配置信息每个服务器(Server)上的线程会动态的获取属于自己的数据并打印。当然，这里对数据的处理逻辑很简单，仅仅是打印出来，处理的数据也只是内存中的一个数组，对于类似这样的但是更复杂的应用场景，zookeeper同样适用，但是需要更多的考虑服务器与zookeeper集群连接的可靠性（比如session超时重连）、权限机制等等。<br>
上面的demo程序打印信息如下：</p>
<blockquote>
<p>[2012-11-14 15:18:42] New zk connection session: 0<br>
[2012-11-14 15:18:42] ================<br>
[2012-11-14 15:18:42] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckFAMS4xLjEuMQ==">ServerA@1.1.1.1<i class="fa fa-external-link-alt"></i></span> initializing…<br>
[2012-11-14 15:18:47] Thread-0 get an event.Path:null,state:SyncConnected,type:None<br>
[2012-11-14 15:18:47] Thread-0 get an event.Path:/demo,state:SyncConnected,type:NodeChildrenChanged<br>
[2012-11-14 15:18:47] In event: NodeChildrenChanged<br>
[2012-11-14 15:18:47] ================<br>
[2012-11-14 15:18:47] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckFAMS4xLjEuMQ==">ServerA@1.1.1.1<i class="fa fa-external-link-alt"></i></span>:freshing…<br>
[2012-11-14 15:18:47] SYSTEM VERSION: 1<br>
[2012-11-14 15:18:47] SYSTEM VERSION: 1<br>
[2012-11-14 15:18:47] Server count:1<br>
[2012-11-14 15:18:47] Server count:1<br>
[2012-11-14 15:18:47] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckFAMS4xLjEuMQ==">ServerA@1.1.1.1<i class="fa fa-external-link-alt"></i></span>, mod=0,base=5<br>
[2012-11-14 15:18:47] ClientThread_ServerA@1.1.1.1-thread_0:0/5<br>
[2012-11-14 15:18:47] ClientThread_ServerA@1.1.1.1-thread_1:1/5<br>
[2012-11-14 15:18:47] ClientThread_ServerA@1.1.1.1-thread_2:2/5<br>
[2012-11-14 15:18:47] ClientThread_ServerA@1.1.1.1-thread_3:3/5<br>
[2012-11-14 15:18:47] ClientThread_ServerA@1.1.1.1-thread_4:4/5<br>
[2012-11-14 15:18:47] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckFAMS4xLjEuMQ==">ServerA@1.1.1.1<i class="fa fa-external-link-alt"></i></span> finish initializing…<br>
[2012-11-14 15:18:47] ================<br>
[2012-11-14 15:18:47] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckFAMS4xLjEuMQ==">ServerA@1.1.1.1<i class="fa fa-external-link-alt"></i></span>, mod=0,base=5<br>
[2012-11-14 15:18:47] ClientThread_ServerA@1.1.1.1-thread_0:0/5<br>
[2012-11-14 15:18:47] ClientThread_ServerA@1.1.1.1-thread_1:1/5<br>
[2012-11-14 15:18:47] ClientThread_ServerA@1.1.1.1-thread_2:2/5<br>
[2012-11-14 15:18:47] ClientThread_ServerA@1.1.1.1-thread_3:3/5<br>
[2012-11-14 15:18:47] ClientThread_ServerA@1.1.1.1-thread_4:4/5<br>
[2012-11-14 15:18:47] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckFAMS4xLjEuMQ==">ServerA@1.1.1.1<i class="fa fa-external-link-alt"></i></span>:end freshing…<br>
[2012-11-14 15:18:47] ================<br>
[2012-11-14 15:18:47] End event: NodeChildrenChanged<br>
[2012-11-14 15:18:47] New zk connection session: 0<br>
[2012-11-14 15:18:47] ================<br>
[2012-11-14 15:18:47] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckJAMS4xLjEuMg==">ServerB@1.1.1.2<i class="fa fa-external-link-alt"></i></span> initializing…<br>
[2012-11-14 15:18:51] Thread-6 get an event.Path:null,state:SyncConnected,type:None<br>
[2012-11-14 15:18:51] Thread-0 get an event.Path:/demo,state:SyncConnected,type:NodeChildrenChanged<br>
[2012-11-14 15:18:51] In event: NodeChildrenChanged<br>
[2012-11-14 15:18:51] ================<br>
[2012-11-14 15:18:51] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckFAMS4xLjEuMQ==">ServerA@1.1.1.1<i class="fa fa-external-link-alt"></i></span>:freshing…<br>
[2012-11-14 15:18:51] Thread-6 get an event.Path:/demo,state:SyncConnected,type:NodeChildrenChanged<br>
[2012-11-14 15:18:51] In event: NodeChildrenChanged<br>
[2012-11-14 15:18:51] ================<br>
[2012-11-14 15:18:51] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckJAMS4xLjEuMg==">ServerB@1.1.1.2<i class="fa fa-external-link-alt"></i></span>:freshing…<br>
[2012-11-14 15:18:51] SYSTEM VERSION: 1<br>
[2012-11-14 15:18:51] SYSTEM VERSION: 1<br>
[2012-11-14 15:18:51] Server count:2<br>
[2012-11-14 15:18:51] SYSTEM VERSION: 1<br>
[2012-11-14 15:18:51] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckFAMS4xLjEuMQ==">ServerA@1.1.1.1<i class="fa fa-external-link-alt"></i></span>, mod=0,base=10<br>
[2012-11-14 15:18:51] ClientThread_ServerA@1.1.1.1-thread_0:0/10<br>
[2012-11-14 15:18:51] ClientThread_ServerA@1.1.1.1-thread_1:1/10<br>
[2012-11-14 15:18:51] ClientThread_ServerA@1.1.1.1-thread_2:2/10<br>
[2012-11-14 15:18:51] ClientThread_ServerA@1.1.1.1-thread_3:3/10<br>
[2012-11-14 15:18:51] ClientThread_ServerA@1.1.1.1-thread_4:4/10<br>
[2012-11-14 15:18:51] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckFAMS4xLjEuMQ==">ServerA@1.1.1.1<i class="fa fa-external-link-alt"></i></span>:end freshing…<br>
[2012-11-14 15:18:51] Server count:2<br>
[2012-11-14 15:18:51] ================<br>
[2012-11-14 15:18:51] End event: NodeChildrenChanged<br>
[2012-11-14 15:18:51] Server count:2<br>
[2012-11-14 15:18:51] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckJAMS4xLjEuMg==">ServerB@1.1.1.2<i class="fa fa-external-link-alt"></i></span>, mod=1,base=10<br>
[2012-11-14 15:18:51] ClientThread_ServerB@1.1.1.2-thread_0:5/10<br>
[2012-11-14 15:18:51] ClientThread_ServerB@1.1.1.2-thread_1:6/10<br>
[2012-11-14 15:18:51] ClientThread_ServerB@1.1.1.2-thread_2:7/10<br>
[2012-11-14 15:18:51] ClientThread_ServerB@1.1.1.2-thread_3:8/10<br>
[2012-11-14 15:18:51] ClientThread_ServerB@1.1.1.2-thread_4:9/10<br>
[2012-11-14 15:18:51] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckJAMS4xLjEuMg==">ServerB@1.1.1.2<i class="fa fa-external-link-alt"></i></span>:end freshing…<br>
[2012-11-14 15:18:51] ================<br>
[2012-11-14 15:18:51] End event: NodeChildrenChanged<br>
[2012-11-14 15:18:51] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckJAMS4xLjEuMg==">ServerB@1.1.1.2<i class="fa fa-external-link-alt"></i></span>, mod=1,base=10<br>
[2012-11-14 15:18:51] ClientThread_ServerB@1.1.1.2-thread_0:5/10<br>
[2012-11-14 15:18:51] ClientThread_ServerB@1.1.1.2-thread_1:6/10<br>
[2012-11-14 15:18:51] ClientThread_ServerB@1.1.1.2-thread_2:7/10<br>
[2012-11-14 15:18:51] ClientThread_ServerB@1.1.1.2-thread_3:8/10<br>
[2012-11-14 15:18:51] ClientThread_ServerB@1.1.1.2-thread_4:9/10<br>
[2012-11-14 15:18:51] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckJAMS4xLjEuMg==">ServerB@1.1.1.2<i class="fa fa-external-link-alt"></i></span> finish initializing…<br>
[2012-11-14 15:18:51] ================<br>
[2012-11-14 15:18:51] New zk connection session: 0<br>
[2012-11-14 15:18:51] ================<br>
[2012-11-14 15:18:51] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckNAMS4xLjEuMw==">ServerC@1.1.1.3<i class="fa fa-external-link-alt"></i></span> initializing…<br>
[2012-11-14 15:18:56] Thread-12 get an event.Path:null,state:SyncConnected,type:None<br>
[2012-11-14 15:18:56] Thread-0 get an event.Path:/demo,state:SyncConnected,type:NodeChildrenChanged<br>
[2012-11-14 15:18:56] In event: NodeChildrenChanged<br>
[2012-11-14 15:18:56] ================<br>
[2012-11-14 15:18:56] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckFAMS4xLjEuMQ==">ServerA@1.1.1.1<i class="fa fa-external-link-alt"></i></span>:freshing…<br>
[2012-11-14 15:18:56] Thread-6 get an event.Path:/demo,state:SyncConnected,type:NodeChildrenChanged<br>
[2012-11-14 15:18:56] In event: NodeChildrenChanged<br>
[2012-11-14 15:18:56] ================<br>
[2012-11-14 15:18:56] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckJAMS4xLjEuMg==">ServerB@1.1.1.2<i class="fa fa-external-link-alt"></i></span>:freshing…<br>
[2012-11-14 15:18:56] Thread-12 get an event.Path:/demo,state:SyncConnected,type:NodeChildrenChanged<br>
[2012-11-14 15:18:56] In event: NodeChildrenChanged<br>
[2012-11-14 15:18:56] ================<br>
[2012-11-14 15:18:56] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckNAMS4xLjEuMw==">ServerC@1.1.1.3<i class="fa fa-external-link-alt"></i></span>:freshing…<br>
[2012-11-14 15:18:56] SYSTEM VERSION: 1<br>
[2012-11-14 15:18:56] SYSTEM VERSION: 1<br>
[2012-11-14 15:18:56] SYSTEM VERSION: 1<br>
[2012-11-14 15:18:56] Server count:3<br>
[2012-11-14 15:18:56] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckFAMS4xLjEuMQ==">ServerA@1.1.1.1<i class="fa fa-external-link-alt"></i></span>, mod=0,base=15<br>
[2012-11-14 15:18:56] ClientThread_ServerA@1.1.1.1-thread_0:0/15<br>
[2012-11-14 15:18:56] Server count:3<br>
[2012-11-14 15:18:56] ClientThread_ServerA@1.1.1.1-thread_1:1/15<br>
[2012-11-14 15:18:56] ClientThread_ServerA@1.1.1.1-thread_2:2/15<br>
[2012-11-14 15:18:56] ClientThread_ServerA@1.1.1.1-thread_3:3/15<br>
[2012-11-14 15:18:56] ClientThread_ServerA@1.1.1.1-thread_4:4/15<br>
[2012-11-14 15:18:56] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckFAMS4xLjEuMQ==">ServerA@1.1.1.1<i class="fa fa-external-link-alt"></i></span>:end freshing…<br>
[2012-11-14 15:18:56] ================<br>
[2012-11-14 15:18:56] End event: NodeChildrenChanged<br>
[2012-11-14 15:18:56] SYSTEM VERSION: 1<br>
[2012-11-14 15:18:56] Server count:3<br>
[2012-11-14 15:18:56] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckJAMS4xLjEuMg==">ServerB@1.1.1.2<i class="fa fa-external-link-alt"></i></span>, mod=1,base=15<br>
[2012-11-14 15:18:56] ClientThread_ServerB@1.1.1.2-thread_0:5/15<br>
[2012-11-14 15:18:56] ClientThread_ServerB@1.1.1.2-thread_1:6/15<br>
[2012-11-14 15:18:56] ClientThread_ServerB@1.1.1.2-thread_2:7/15<br>
[2012-11-14 15:18:56] ClientThread_ServerB@1.1.1.2-thread_3:8/15<br>
[2012-11-14 15:18:56] ClientThread_ServerB@1.1.1.2-thread_4:9/15<br>
[2012-11-14 15:18:56] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckJAMS4xLjEuMg==">ServerB@1.1.1.2<i class="fa fa-external-link-alt"></i></span>:end freshing…<br>
[2012-11-14 15:18:56] ================<br>
[2012-11-14 15:18:56] End event: NodeChildrenChanged<br>
[2012-11-14 15:18:56] Server count:3<br>
[2012-11-14 15:18:56] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckNAMS4xLjEuMw==">ServerC@1.1.1.3<i class="fa fa-external-link-alt"></i></span>, mod=2,base=15<br>
[2012-11-14 15:18:56] ClientThread_ServerC@1.1.1.3-thread_0:10/15<br>
[2012-11-14 15:18:56] ClientThread_ServerC@1.1.1.3-thread_1:11/15<br>
[2012-11-14 15:18:56] ClientThread_ServerC@1.1.1.3-thread_2:12/15<br>
[2012-11-14 15:18:56] ClientThread_ServerC@1.1.1.3-thread_3:13/15<br>
[2012-11-14 15:18:56] ClientThread_ServerC@1.1.1.3-thread_4:14/15<br>
[2012-11-14 15:18:56] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckNAMS4xLjEuMw==">ServerC@1.1.1.3<i class="fa fa-external-link-alt"></i></span>:end freshing…<br>
[2012-11-14 15:18:56] ================<br>
[2012-11-14 15:18:56] End event: NodeChildrenChanged<br>
[2012-11-14 15:18:56] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckNAMS4xLjEuMw==">ServerC@1.1.1.3<i class="fa fa-external-link-alt"></i></span>, mod=2,base=15<br>
[2012-11-14 15:18:56] ClientThread_ServerC@1.1.1.3-thread_0:10/15<br>
[2012-11-14 15:18:56] ClientThread_ServerC@1.1.1.3-thread_1:11/15<br>
[2012-11-14 15:18:56] ClientThread_ServerC@1.1.1.3-thread_2:12/15<br>
[2012-11-14 15:18:56] ClientThread_ServerC@1.1.1.3-thread_3:13/15<br>
[2012-11-14 15:18:56] ClientThread_ServerC@1.1.1.3-thread_4:14/15<br>
[2012-11-14 15:18:56] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckNAMS4xLjEuMw==">ServerC@1.1.1.3<i class="fa fa-external-link-alt"></i></span> finish initializing…<br>
[2012-11-14 15:18:56] ================<br>
[2012-11-14 15:18:56] Start thread-ClientThread_ServerA@1.1.1.1-thread_0<br>
[2012-11-14 15:18:56] Start thread-ClientThread_ServerB@1.1.1.2-thread_0<br>
[2012-11-14 15:18:56] Start thread-ClientThread_ServerC@1.1.1.3-thread_0<br>
[2012-11-14 15:18:56] Start thread-ClientThread_ServerB@1.1.1.2-thread_1<br>
[2012-11-14 15:18:56] Start thread-ClientThread_ServerA@1.1.1.1-thread_1<br>
[2012-11-14 15:18:56] ClientThread_ServerA@1.1.1.1-thread_0-0/15:15 30<br>
[2012-11-14 15:18:56] Start thread-ClientThread_ServerA@1.1.1.1-thread_2<br>
[2012-11-14 15:18:56] ClientThread_ServerC@1.1.1.3-thread_0-10/15:10 25<br>
[2012-11-14 15:18:56] Start thread-ClientThread_ServerA@1.1.1.1-thread_3<br>
[2012-11-14 15:18:56] ClientThread_ServerB@1.1.1.2-thread_0-5/15:5 20<br>
[2012-11-14 15:18:56] Start thread-ClientThread_ServerA@1.1.1.1-thread_4<br>
[2012-11-14 15:18:56] ClientThread_ServerA@1.1.1.1-thread_1-1/15:1 16<br>
[2012-11-14 15:18:56] ClientThread_ServerA@1.1.1.1-thread_3-3/15:3 18<br>
[2012-11-14 15:18:56] ClientThread_ServerA@1.1.1.1-thread_2-2/15:2 17<br>
[2012-11-14 15:18:56] Start thread-ClientThread_ServerB@1.1.1.2-thread_2<br>
[2012-11-14 15:18:56] ClientThread_ServerB@1.1.1.2-thread_1-6/15:6 21<br>
[2012-11-14 15:18:56] Start thread-ClientThread_ServerB@1.1.1.2-thread_3<br>
[2012-11-14 15:18:56] ClientThread_ServerB@1.1.1.2-thread_2-7/15:7 22<br>
[2012-11-14 15:18:56] ClientThread_ServerB@1.1.1.2-thread_3-8/15:8 23<br>
[2012-11-14 15:18:56] Start thread-ClientThread_ServerC@1.1.1.3-thread_1<br>
[2012-11-14 15:18:56] Start thread-ClientThread_ServerB@1.1.1.2-thread_4<br>
[2012-11-14 15:18:56] ClientThread_ServerC@1.1.1.3-thread_1-11/15:11 26<br>
[2012-11-14 15:18:56] ClientThread_ServerA@1.1.1.1-thread_4-4/15:4 19<br>
[2012-11-14 15:18:56] Start thread-ClientThread_ServerC@1.1.1.3-thread_2<br>
[2012-11-14 15:18:56] ClientThread_ServerB@1.1.1.2-thread_4-9/15:9 24<br>
[2012-11-14 15:18:56] Start thread-ClientThread_ServerC@1.1.1.3-thread_3<br>
[2012-11-14 15:18:56] ClientThread_ServerC@1.1.1.3-thread_2-12/15:12 27<br>
[2012-11-14 15:18:56] Start thread-ClientThread_ServerC@1.1.1.3-thread_4<br>
[2012-11-14 15:18:56] ClientThread_ServerC@1.1.1.3-thread_3-13/15:13 28<br>
[2012-11-14 15:18:56] ClientThread_ServerC@1.1.1.3-thread_4-14/15:14 29<br>
[2012-11-14 15:19:01] ClientThread_ServerB@1.1.1.2-thread_0-5/15:5 20<br>
[2012-11-14 15:19:01] ClientThread_ServerA@1.1.1.1-thread_3-3/15:3 18<br>
[2012-11-14 15:19:01] ClientThread_ServerA@1.1.1.1-thread_0-0/15:15 30<br>
[2012-11-14 15:19:01] ClientThread_ServerB@1.1.1.2-thread_1-6/15:6 21<br>
[2012-11-14 15:19:01] ClientThread_ServerA@1.1.1.1-thread_1-1/15:1 16<br>
[2012-11-14 15:19:01] ClientThread_ServerC@1.1.1.3-thread_0-10/15:10 25<br>
[2012-11-14 15:19:01] ClientThread_ServerA@1.1.1.1-thread_2-2/15:2 17<br>
[2012-11-14 15:19:01] ClientThread_ServerB@1.1.1.2-thread_2-7/15:7 22<br>
[2012-11-14 15:19:01] ClientThread_ServerC@1.1.1.3-thread_1-11/15:11 26<br>
[2012-11-14 15:19:01] ClientThread_ServerB@1.1.1.2-thread_3-8/15:8 23<br>
[2012-11-14 15:19:01] ClientThread_ServerA@1.1.1.1-thread_4-4/15:4 19<br>
[2012-11-14 15:19:01] ClientThread_ServerC@1.1.1.3-thread_2-12/15:12 27<br>
[2012-11-14 15:19:01] ClientThread_ServerB@1.1.1.2-thread_4-9/15:9 24<br>
[2012-11-14 15:19:01] ClientThread_ServerC@1.1.1.3-thread_3-13/15:13 28<br>
[2012-11-14 15:19:01] ClientThread_ServerC@1.1.1.3-thread_4-14/15:14 29<br>
[2012-11-14 15:19:02] Thread-0 get an event.Path:/demo/1.1.1.1,state:SyncConnected,type:NodeDeleted<br>
[2012-11-14 15:19:02] In event: NodeDeleted<br>
[2012-11-14 15:19:02] ================<br>
[2012-11-14 15:19:02] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckFAMS4xLjEuMQ==">ServerA@1.1.1.1<i class="fa fa-external-link-alt"></i></span>:freshing…<br>
[2012-11-14 15:19:02] Thread-12 get an event.Path:/demo/1.1.1.1,state:SyncConnected,type:NodeDeleted<br>
[2012-11-14 15:19:02] In event: NodeDeleted<br>
[2012-11-14 15:19:02] ================<br>
[2012-11-14 15:19:02] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckNAMS4xLjEuMw==">ServerC@1.1.1.3<i class="fa fa-external-link-alt"></i></span>:freshing…<br>
[2012-11-14 15:19:02] Thread-6 get an event.Path:/demo/1.1.1.1,state:SyncConnected,type:NodeDeleted<br>
[2012-11-14 15:19:02] In event: NodeDeleted<br>
[2012-11-14 15:19:02] ================<br>
[2012-11-14 15:19:02] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckJAMS4xLjEuMg==">ServerB@1.1.1.2<i class="fa fa-external-link-alt"></i></span>:freshing…<br>
[2012-11-14 15:19:02] SYSTEM VERSION: 1<br>
[2012-11-14 15:19:02] SYSTEM VERSION: 1<br>
[2012-11-14 15:19:02] SYSTEM VERSION: 1<br>
[2012-11-14 15:19:02] Server count:2<br>
[2012-11-14 15:19:02] Server count:2<br>
Did not get the mod number for <span class="exturl" data-url="bWFpbHRvOlNlcnZlckFAMS4xLjEuMQ==">ServerA@1.1.1.1<i class="fa fa-external-link-alt"></i></span><br>
[2012-11-14 15:19:02] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckFAMS4xLjEuMQ==">ServerA@1.1.1.1<i class="fa fa-external-link-alt"></i></span>:end freshing…<br>
[2012-11-14 15:19:02] ================<br>
[2012-11-14 15:19:02] End event: NodeDeleted<br>
[2012-11-14 15:19:02] Thread-0 get an event.Path:/demo,state:SyncConnected,type:NodeChildrenChanged<br>
[2012-11-14 15:19:02] In event: NodeChildrenChanged<br>
[2012-11-14 15:19:02] ================<br>
[2012-11-14 15:19:02] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckFAMS4xLjEuMQ==">ServerA@1.1.1.1<i class="fa fa-external-link-alt"></i></span>:freshing…<br>
[2012-11-14 15:19:02] Server count:2<br>
[2012-11-14 15:19:02] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckNAMS4xLjEuMw==">ServerC@1.1.1.3<i class="fa fa-external-link-alt"></i></span>, mod=2,base=10<br>
[2012-11-14 15:19:02] ClientThread_ServerC@1.1.1.3-thread_0:10/10<br>
[2012-11-14 15:19:02] ClientThread_ServerC@1.1.1.3-thread_1:11/10<br>
[2012-11-14 15:19:02] ClientThread_ServerC@1.1.1.3-thread_2:12/10<br>
[2012-11-14 15:19:02] ClientThread_ServerC@1.1.1.3-thread_3:13/10<br>
[2012-11-14 15:19:02] ClientThread_ServerC@1.1.1.3-thread_4:14/10<br>
[2012-11-14 15:19:02] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckNAMS4xLjEuMw==">ServerC@1.1.1.3<i class="fa fa-external-link-alt"></i></span>:end freshing…<br>
[2012-11-14 15:19:02] ================<br>
[2012-11-14 15:19:02] End event: NodeDeleted<br>
[2012-11-14 15:19:02] Thread-12 get an event.Path:/demo,state:SyncConnected,type:NodeChildrenChanged<br>
[2012-11-14 15:19:02] In event: NodeChildrenChanged<br>
[2012-11-14 15:19:02] ================<br>
[2012-11-14 15:19:02] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckNAMS4xLjEuMw==">ServerC@1.1.1.3<i class="fa fa-external-link-alt"></i></span>:freshing…<br>
[2012-11-14 15:19:02] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckJAMS4xLjEuMg==">ServerB@1.1.1.2<i class="fa fa-external-link-alt"></i></span>, mod=1,base=10<br>
[2012-11-14 15:19:02] SYSTEM VERSION: 1<br>
[2012-11-14 15:19:02] ClientThread_ServerB@1.1.1.2-thread_0:5/10<br>
[2012-11-14 15:19:02] ClientThread_ServerB@1.1.1.2-thread_1:6/10<br>
[2012-11-14 15:19:02] ClientThread_ServerB@1.1.1.2-thread_2:7/10<br>
[2012-11-14 15:19:02] ClientThread_ServerB@1.1.1.2-thread_3:8/10<br>
[2012-11-14 15:19:02] ClientThread_ServerB@1.1.1.2-thread_4:9/10<br>
[2012-11-14 15:19:02] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckJAMS4xLjEuMg==">ServerB@1.1.1.2<i class="fa fa-external-link-alt"></i></span>:end freshing…<br>
[2012-11-14 15:19:02] ================<br>
[2012-11-14 15:19:02] End event: NodeDeleted<br>
[2012-11-14 15:19:02] Thread-6 get an event.Path:/demo,state:SyncConnected,type:NodeChildrenChanged<br>
[2012-11-14 15:19:02] In event: NodeChildrenChanged<br>
[2012-11-14 15:19:02] ================<br>
[2012-11-14 15:19:02] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckJAMS4xLjEuMg==">ServerB@1.1.1.2<i class="fa fa-external-link-alt"></i></span>:freshing…<br>
[2012-11-14 15:19:02] SYSTEM VERSION: 1<br>
[2012-11-14 15:19:02] Server count:2<br>
[2012-11-14 15:19:02] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckFAMS4xLjEuMQ==">ServerA@1.1.1.1<i class="fa fa-external-link-alt"></i></span>:end freshing…<br>
[2012-11-14 15:19:02] ================<br>
[2012-11-14 15:19:02] End event: NodeChildrenChanged<br>
Did not get the mod number for <span class="exturl" data-url="bWFpbHRvOlNlcnZlckFAMS4xLjEuMQ==">ServerA@1.1.1.1<i class="fa fa-external-link-alt"></i></span><br>
[2012-11-14 15:19:02] SYSTEM VERSION: 1<br>
[2012-11-14 15:19:02] Server count:2<br>
[2012-11-14 15:19:02] Server count:2<br>
[2012-11-14 15:19:02] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckNAMS4xLjEuMw==">ServerC@1.1.1.3<i class="fa fa-external-link-alt"></i></span>, mod=2,base=10<br>
[2012-11-14 15:19:02] ClientThread_ServerC@1.1.1.3-thread_0:10/10<br>
[2012-11-14 15:19:02] ClientThread_ServerC@1.1.1.3-thread_1:11/10<br>
[2012-11-14 15:19:02] ClientThread_ServerC@1.1.1.3-thread_2:12/10<br>
[2012-11-14 15:19:02] ClientThread_ServerC@1.1.1.3-thread_3:13/10<br>
[2012-11-14 15:19:02] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckJAMS4xLjEuMg==">ServerB@1.1.1.2<i class="fa fa-external-link-alt"></i></span>, mod=1,base=10<br>
[2012-11-14 15:19:02] ClientThread_ServerC@1.1.1.3-thread_4:14/10<br>
[2012-11-14 15:19:02] ClientThread_ServerB@1.1.1.2-thread_0:5/10<br>
[2012-11-14 15:19:02] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckNAMS4xLjEuMw==">ServerC@1.1.1.3<i class="fa fa-external-link-alt"></i></span>:end freshing…<br>
[2012-11-14 15:19:02] ClientThread_ServerB@1.1.1.2-thread_1:6/10<br>
[2012-11-14 15:19:02] ================<br>
[2012-11-14 15:19:02] End event: NodeChildrenChanged<br>
[2012-11-14 15:19:02] ClientThread_ServerB@1.1.1.2-thread_2:7/10<br>
[2012-11-14 15:19:02] ClientThread_ServerB@1.1.1.2-thread_3:8/10<br>
[2012-11-14 15:19:02] ClientThread_ServerB@1.1.1.2-thread_4:9/10<br>
[2012-11-14 15:19:02] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckJAMS4xLjEuMg==">ServerB@1.1.1.2<i class="fa fa-external-link-alt"></i></span>:end freshing…<br>
[2012-11-14 15:19:02] ================<br>
[2012-11-14 15:19:02] End event: NodeChildrenChanged<br>
[2012-11-14 15:19:06] ClientThread_ServerA@1.1.1.1-thread_1-1/10:1 11 21<br>
[2012-11-14 15:19:06] ClientThread_ServerB@1.1.1.2-thread_1-6/10:6 16 26<br>
[2012-11-14 15:19:06] ClientThread_ServerB@1.1.1.2-thread_0-5/10:5 15 25<br>
[2012-11-14 15:19:06] ClientThread_ServerA@1.1.1.1-thread_2-2/10:2 12 22<br>
[2012-11-14 15:19:06] ClientThread_ServerC@1.1.1.3-thread_0-10/10:<br>
[2012-11-14 15:19:06] ClientThread_ServerA@1.1.1.1-thread_3-3/10:3 13 23<br>
[2012-11-14 15:19:06] ClientThread_ServerA@1.1.1.1-thread_0-0/10:10 20 30<br>
[2012-11-14 15:19:06] ClientThread_ServerA@1.1.1.1-thread_4-4/10:4 14 24<br>
[2012-11-14 15:19:06] ClientThread_ServerB@1.1.1.2-thread_2-7/10:7 17 27<br>
[2012-11-14 15:19:06] ClientThread_ServerB@1.1.1.2-thread_3-8/10:8 18 28<br>
[2012-11-14 15:19:06] ClientThread_ServerC@1.1.1.3-thread_1-11/10:<br>
[2012-11-14 15:19:06] ClientThread_ServerC@1.1.1.3-thread_2-12/10:<br>
[2012-11-14 15:19:06] ClientThread_ServerB@1.1.1.2-thread_4-9/10:9 19 29<br>
[2012-11-14 15:19:06] ClientThread_ServerC@1.1.1.3-thread_3-13/10:<br>
[2012-11-14 15:19:06] ClientThread_ServerC@1.1.1.3-thread_4-14/10:<br>
[2012-11-14 15:19:07] Thread-0 get an event.Path:/demo,state:SyncConnected,type:NodeChildrenChanged<br>
[2012-11-14 15:19:07] In event: NodeChildrenChanged<br>
[2012-11-14 15:19:07] ================<br>
[2012-11-14 15:19:07] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckFAMS4xLjEuMQ==">ServerA@1.1.1.1<i class="fa fa-external-link-alt"></i></span>:freshing…<br>
[2012-11-14 15:19:07] Thread-12 get an event.Path:/demo/1.1.1.2,state:SyncConnected,type:NodeDeleted<br>
[2012-11-14 15:19:07] In event: NodeDeleted<br>
[2012-11-14 15:19:07] ================<br>
[2012-11-14 15:19:07] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckNAMS4xLjEuMw==">ServerC@1.1.1.3<i class="fa fa-external-link-alt"></i></span>:freshing…<br>
[2012-11-14 15:19:07] Thread-6 get an event.Path:/demo/1.1.1.2,state:SyncConnected,type:NodeDeleted<br>
[2012-11-14 15:19:07] In event: NodeDeleted<br>
[2012-11-14 15:19:07] ================<br>
[2012-11-14 15:19:07] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckJAMS4xLjEuMg==">ServerB@1.1.1.2<i class="fa fa-external-link-alt"></i></span>:freshing…<br>
[2012-11-14 15:19:07] SYSTEM VERSION: 1<br>
Did not get the mod number for <span class="exturl" data-url="bWFpbHRvOlNlcnZlckFAMS4xLjEuMQ==">ServerA@1.1.1.1<i class="fa fa-external-link-alt"></i></span><br>
[2012-11-14 15:19:07] Server count:1<br>
[2012-11-14 15:19:07] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckFAMS4xLjEuMQ==">ServerA@1.1.1.1<i class="fa fa-external-link-alt"></i></span>:end freshing…<br>
[2012-11-14 15:19:07] ================<br>
[2012-11-14 15:19:07] End event: NodeChildrenChanged<br>
[2012-11-14 15:19:07] SYSTEM VERSION: 1<br>
[2012-11-14 15:19:07] SYSTEM VERSION: 1<br>
[2012-11-14 15:19:07] Server count:1<br>
[2012-11-14 15:19:07] Server count:1<br>
[2012-11-14 15:19:07] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckJAMS4xLjEuMg==">ServerB@1.1.1.2<i class="fa fa-external-link-alt"></i></span>:end freshing…<br>
[2012-11-14 15:19:07] ================<br>
[2012-11-14 15:19:07] End event: NodeDeleted<br>
[2012-11-14 15:19:07] Thread-6 get an event.Path:/demo,state:SyncConnected,type:NodeChildrenChanged<br>
[2012-11-14 15:19:07] In event: NodeChildrenChanged<br>
[2012-11-14 15:19:07] ================<br>
[2012-11-14 15:19:07] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckJAMS4xLjEuMg==">ServerB@1.1.1.2<i class="fa fa-external-link-alt"></i></span>:freshing…<br>
Did not get the mod number for <span class="exturl" data-url="bWFpbHRvOlNlcnZlckJAMS4xLjEuMg==">ServerB@1.1.1.2<i class="fa fa-external-link-alt"></i></span><br>
[2012-11-14 15:19:07] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckNAMS4xLjEuMw==">ServerC@1.1.1.3<i class="fa fa-external-link-alt"></i></span>, mod=2,base=5<br>
[2012-11-14 15:19:07] ClientThread_ServerC@1.1.1.3-thread_0:10/5<br>
[2012-11-14 15:19:07] ClientThread_ServerC@1.1.1.3-thread_1:11/5<br>
[2012-11-14 15:19:07] ClientThread_ServerC@1.1.1.3-thread_2:12/5<br>
[2012-11-14 15:19:07] ClientThread_ServerC@1.1.1.3-thread_3:13/5<br>
[2012-11-14 15:19:07] ClientThread_ServerC@1.1.1.3-thread_4:14/5<br>
[2012-11-14 15:19:07] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckNAMS4xLjEuMw==">ServerC@1.1.1.3<i class="fa fa-external-link-alt"></i></span>:end freshing…<br>
[2012-11-14 15:19:07] ================<br>
[2012-11-14 15:19:07] End event: NodeDeleted<br>
[2012-11-14 15:19:07] Thread-12 get an event.Path:/demo,state:SyncConnected,type:NodeChildrenChanged<br>
[2012-11-14 15:19:07] In event: NodeChildrenChanged<br>
[2012-11-14 15:19:07] ================<br>
[2012-11-14 15:19:07] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckNAMS4xLjEuMw==">ServerC@1.1.1.3<i class="fa fa-external-link-alt"></i></span>:freshing…<br>
[2012-11-14 15:19:07] SYSTEM VERSION: 1<br>
Did not get the mod number for <span class="exturl" data-url="bWFpbHRvOlNlcnZlckJAMS4xLjEuMg==">ServerB@1.1.1.2<i class="fa fa-external-link-alt"></i></span><br>
[2012-11-14 15:19:07] Server count:1<br>
[2012-11-14 15:19:07] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckJAMS4xLjEuMg==">ServerB@1.1.1.2<i class="fa fa-external-link-alt"></i></span>:end freshing…<br>
[2012-11-14 15:19:07] ================<br>
[2012-11-14 15:19:07] End event: NodeChildrenChanged<br>
[2012-11-14 15:19:07] SYSTEM VERSION: 1<br>
[2012-11-14 15:19:07] Server count:1<br>
[2012-11-14 15:19:07] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckNAMS4xLjEuMw==">ServerC@1.1.1.3<i class="fa fa-external-link-alt"></i></span>, mod=2,base=5<br>
[2012-11-14 15:19:07] ClientThread_ServerC@1.1.1.3-thread_0:10/5<br>
[2012-11-14 15:19:07] ClientThread_ServerC@1.1.1.3-thread_1:11/5<br>
[2012-11-14 15:19:07] ClientThread_ServerC@1.1.1.3-thread_2:12/5<br>
[2012-11-14 15:19:07] ClientThread_ServerC@1.1.1.3-thread_3:13/5<br>
[2012-11-14 15:19:07] ClientThread_ServerC@1.1.1.3-thread_4:14/5<br>
[2012-11-14 15:19:07] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckNAMS4xLjEuMw==">ServerC@1.1.1.3<i class="fa fa-external-link-alt"></i></span>:end freshing…<br>
[2012-11-14 15:19:07] ================<br>
[2012-11-14 15:19:07] End event: NodeChildrenChanged<br>
[2012-11-14 15:19:11] ClientThread_ServerB@1.1.1.2-thread_1-6/5:<br>
[2012-11-14 15:19:11] ClientThread_ServerA@1.1.1.1-thread_0-0/5:5 10 15 20 25 30<br>
[2012-11-14 15:19:11] ClientThread_ServerC@1.1.1.3-thread_0-10/5:<br>
[2012-11-14 15:19:11] ClientThread_ServerA@1.1.1.1-thread_1-1/5:1 6 11 16 21 26<br>
[2012-11-14 15:19:11] ClientThread_ServerA@1.1.1.1-thread_3-3/5:3 8 13 18 23 28<br>
[2012-11-14 15:19:11] ClientThread_ServerB@1.1.1.2-thread_0-5/5:<br>
[2012-11-14 15:19:11] ClientThread_ServerA@1.1.1.1-thread_2-2/5:2 7 12 17 22 27<br>
[2012-11-14 15:19:11] ClientThread_ServerC@1.1.1.3-thread_1-11/5:<br>
[2012-11-14 15:19:11] ClientThread_ServerB@1.1.1.2-thread_3-8/5:<br>
[2012-11-14 15:19:11] ClientThread_ServerB@1.1.1.2-thread_2-7/5:<br>
[2012-11-14 15:19:11] ClientThread_ServerA@1.1.1.1-thread_4-4/5:4 9 14 19 24 29<br>
[2012-11-14 15:19:11] ClientThread_ServerB@1.1.1.2-thread_4-9/5:<br>
[2012-11-14 15:19:11] ClientThread_ServerC@1.1.1.3-thread_2-12/5:<br>
[2012-11-14 15:19:11] ClientThread_ServerC@1.1.1.3-thread_4-14/5:<br>
[2012-11-14 15:19:11] ClientThread_ServerC@1.1.1.3-thread_3-13/5:<br>
[2012-11-14 15:19:12] Thread-0 get an event.Path:/demo,state:SyncConnected,type:NodeChildrenChanged<br>
[2012-11-14 15:19:12] In event: NodeChildrenChanged<br>
[2012-11-14 15:19:12] ================<br>
[2012-11-14 15:19:12] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckFAMS4xLjEuMQ==">ServerA@1.1.1.1<i class="fa fa-external-link-alt"></i></span>:freshing…<br>
[2012-11-14 15:19:12] Thread-12 get an event.Path:/demo/1.1.1.3,state:SyncConnected,type:NodeDeleted<br>
[2012-11-14 15:19:12] In event: NodeDeleted<br>
[2012-11-14 15:19:12] ================<br>
[2012-11-14 15:19:12] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckNAMS4xLjEuMw==">ServerC@1.1.1.3<i class="fa fa-external-link-alt"></i></span>:freshing…<br>
[2012-11-14 15:19:12] Thread-6 get an event.Path:/demo,state:SyncConnected,type:NodeChildrenChanged<br>
[2012-11-14 15:19:12] In event: NodeChildrenChanged<br>
[2012-11-14 15:19:12] ================<br>
[2012-11-14 15:19:12] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckJAMS4xLjEuMg==">ServerB@1.1.1.2<i class="fa fa-external-link-alt"></i></span>:freshing…<br>
[2012-11-14 15:19:12] SYSTEM VERSION: 1<br>
[2012-11-14 15:19:12] SYSTEM VERSION: 1<br>
[2012-11-14 15:19:12] Server count:0<br>
[2012-11-14 15:19:12] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckJAMS4xLjEuMg==">ServerB@1.1.1.2<i class="fa fa-external-link-alt"></i></span>:end freshing…<br>
[2012-11-14 15:19:12] ================<br>
[2012-11-14 15:19:12] End event: NodeChildrenChanged<br>
[2012-11-14 15:19:12] SYSTEM VERSION: 1<br>
[2012-11-14 15:19:12] Server count:0<br>
[2012-11-14 15:19:12] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckFAMS4xLjEuMQ==">ServerA@1.1.1.1<i class="fa fa-external-link-alt"></i></span>:end freshing…<br>
[2012-11-14 15:19:12] ================<br>
[2012-11-14 15:19:12] End event: NodeChildrenChanged<br>
[2012-11-14 15:19:12] Server count:0<br>
[2012-11-14 15:19:12] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckNAMS4xLjEuMw==">ServerC@1.1.1.3<i class="fa fa-external-link-alt"></i></span>:end freshing…<br>
[2012-11-14 15:19:12] ================<br>
[2012-11-14 15:19:12] End event: NodeDeleted<br>
[2012-11-14 15:19:12] Thread-12 get an event.Path:/demo,state:SyncConnected,type:NodeChildrenChanged<br>
[2012-11-14 15:19:12] In event: NodeChildrenChanged<br>
[2012-11-14 15:19:12] ================<br>
[2012-11-14 15:19:12] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckNAMS4xLjEuMw==">ServerC@1.1.1.3<i class="fa fa-external-link-alt"></i></span>:freshing…<br>
[2012-11-14 15:19:12] SYSTEM VERSION: 1<br>
[2012-11-14 15:19:12] Server count:0<br>
[2012-11-14 15:19:12] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckNAMS4xLjEuMw==">ServerC@1.1.1.3<i class="fa fa-external-link-alt"></i></span>:end freshing…<br>
[2012-11-14 15:19:12] ================<br>
[2012-11-14 15:19:12] End event: NodeChildrenChanged<br>
[2012-11-14 15:19:16] ClientThread_ServerB@1.1.1.2-thread_1: did not get server_count and modNum!!!<br>
[2012-11-14 15:19:16] ClientThread_ServerA@1.1.1.1-thread_2: did not get server_count and modNum!!!<br>
[2012-11-14 15:19:16] ClientThread_ServerB@1.1.1.2-thread_0: did not get server_count and modNum!!!<br>
[2012-11-14 15:19:16] ClientThread_ServerA@1.1.1.1-thread_1: did not get server_count and modNum!!!<br>
[2012-11-14 15:19:16] ClientThread_ServerC@1.1.1.3-thread_0: did not get server_count and modNum!!!<br>
[2012-11-14 15:19:16] ClientThread_ServerA@1.1.1.1-thread_3: did not get server_count and modNum!!!<br>
[2012-11-14 15:19:16] ClientThread_ServerA@1.1.1.1-thread_0: did not get server_count and modNum!!!<br>
[2012-11-14 15:19:16] ClientThread_ServerA@1.1.1.1-thread_4: did not get server_count and modNum!!!<br>
[2012-11-14 15:19:16] ClientThread_ServerB@1.1.1.2-thread_3: did not get server_count and modNum!!!<br>
[2012-11-14 15:19:16] ClientThread_ServerC@1.1.1.3-thread_1: did not get server_count and modNum!!!<br>
[2012-11-14 15:19:16] ClientThread_ServerB@1.1.1.2-thread_2: did not get server_count and modNum!!!<br>
[2012-11-14 15:19:16] ClientThread_ServerB@1.1.1.2-thread_4: did not get server_count and modNum!!!<br>
[2012-11-14 15:19:16] ClientThread_ServerC@1.1.1.3-thread_2: did not get server_count and modNum!!!<br>
[2012-11-14 15:19:16] ClientThread_ServerC@1.1.1.3-thread_3: did not get server_count and modNum!!!<br>
[2012-11-14 15:19:16] ClientThread_ServerC@1.1.1.3-thread_4: did not get server_count and modNum!!!<br>
[2012-11-14 15:19:20] Thread-0 get an event.Path:/demo,state:SyncConnected,type:NodeChildrenChanged<br>
[2012-11-14 15:19:20] In event: NodeChildrenChanged<br>
[2012-11-14 15:19:20] ================<br>
[2012-11-14 15:19:20] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckFAMS4xLjEuMQ==">ServerA@1.1.1.1<i class="fa fa-external-link-alt"></i></span>:freshing…<br>
[2012-11-14 15:19:20] Thread-6 get an event.Path:/demo,state:SyncConnected,type:NodeChildrenChanged<br>
[2012-11-14 15:19:20] In event: NodeChildrenChanged<br>
[2012-11-14 15:19:20] ================<br>
[2012-11-14 15:19:20] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckJAMS4xLjEuMg==">ServerB@1.1.1.2<i class="fa fa-external-link-alt"></i></span>:freshing…<br>
[2012-11-14 15:19:20] Thread-12 get an event.Path:/demo,state:SyncConnected,type:NodeChildrenChanged<br>
[2012-11-14 15:19:20] In event: NodeChildrenChanged<br>
[2012-11-14 15:19:20] ================<br>
[2012-11-14 15:19:20] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckNAMS4xLjEuMw==">ServerC@1.1.1.3<i class="fa fa-external-link-alt"></i></span>:freshing…<br>
[2012-11-14 15:19:20] SYSTEM VERSION: 1<br>
[2012-11-14 15:19:20] SYSTEM VERSION: 1<br>
[2012-11-14 15:19:20] SYSTEM VERSION: 1<br>
[2012-11-14 15:19:20] Server count:1<br>
Did not get the mod number for <span class="exturl" data-url="bWFpbHRvOlNlcnZlckNAMS4xLjEuMw==">ServerC@1.1.1.3<i class="fa fa-external-link-alt"></i></span><br>
[2012-11-14 15:19:20] Server count:1<br>
[2012-11-14 15:19:20] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckNAMS4xLjEuMw==">ServerC@1.1.1.3<i class="fa fa-external-link-alt"></i></span>:end freshing…<br>
[2012-11-14 15:19:20] ================<br>
[2012-11-14 15:19:20] End event: NodeChildrenChanged<br>
[2012-11-14 15:19:20] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckFAMS4xLjEuMQ==">ServerA@1.1.1.1<i class="fa fa-external-link-alt"></i></span>, mod=0,base=5<br>
[2012-11-14 15:19:20] ClientThread_ServerA@1.1.1.1-thread_0:0/5<br>
[2012-11-14 15:19:20] ClientThread_ServerA@1.1.1.1-thread_1:1/5<br>
[2012-11-14 15:19:20] ClientThread_ServerA@1.1.1.1-thread_2:2/5<br>
[2012-11-14 15:19:20] ClientThread_ServerA@1.1.1.1-thread_3:3/5<br>
[2012-11-14 15:19:20] ClientThread_ServerA@1.1.1.1-thread_4:4/5<br>
[2012-11-14 15:19:20] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckFAMS4xLjEuMQ==">ServerA@1.1.1.1<i class="fa fa-external-link-alt"></i></span>:end freshing…<br>
[2012-11-14 15:19:20] ================<br>
[2012-11-14 15:19:20] End event: NodeChildrenChanged<br>
Did not get the mod number for <span class="exturl" data-url="bWFpbHRvOlNlcnZlckJAMS4xLjEuMg==">ServerB@1.1.1.2<i class="fa fa-external-link-alt"></i></span><br>
[2012-11-14 15:19:20] Server count:1<br>
[2012-11-14 15:19:20] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckJAMS4xLjEuMg==">ServerB@1.1.1.2<i class="fa fa-external-link-alt"></i></span>:end freshing…<br>
[2012-11-14 15:19:20] ================<br>
[2012-11-14 15:19:20] End event: NodeChildrenChanged<br>
[2012-11-14 15:19:21] ClientThread_ServerB@1.1.1.2-thread_1-6/5:<br>
[2012-11-14 15:19:21] ClientThread_ServerA@1.1.1.1-thread_0-0/5:5 10 15 20 25 30<br>
[2012-11-14 15:19:21] ClientThread_ServerA@1.1.1.1-thread_2-2/5:2 7 12 17 22 27<br>
[2012-11-14 15:19:21] ClientThread_ServerA@1.1.1.1-thread_1-1/5:1 6 11 16 21 26<br>
[2012-11-14 15:19:21] ClientThread_ServerA@1.1.1.1-thread_3-3/5:3 8 13 18 23 28<br>
[2012-11-14 15:19:21] ClientThread_ServerC@1.1.1.3-thread_0-10/5:<br>
[2012-11-14 15:19:21] ClientThread_ServerB@1.1.1.2-thread_0-5/5:<br>
[2012-11-14 15:19:21] ClientThread_ServerC@1.1.1.3-thread_1-11/5:<br>
[2012-11-14 15:19:21] ClientThread_ServerB@1.1.1.2-thread_3-8/5:<br>
[2012-11-14 15:19:21] ClientThread_ServerA@1.1.1.1-thread_4-4/5:4 9 14 19 24 29<br>
[2012-11-14 15:19:21] ClientThread_ServerB@1.1.1.2-thread_2-7/5:<br>
[2012-11-14 15:19:21] ClientThread_ServerC@1.1.1.3-thread_2-12/5:<br>
[2012-11-14 15:19:21] ClientThread_ServerB@1.1.1.2-thread_4-9/5:<br>
[2012-11-14 15:19:21] ClientThread_ServerC@1.1.1.3-thread_4-14/5:<br>
[2012-11-14 15:19:21] ClientThread_ServerC@1.1.1.3-thread_3-13/5:<br>
[2012-11-14 15:19:25] Thread-0 get an event.Path:/demo,state:SyncConnected,type:NodeChildrenChanged<br>
[2012-11-14 15:19:25] In event: NodeChildrenChanged<br>
[2012-11-14 15:19:25] ================<br>
[2012-11-14 15:19:25] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckFAMS4xLjEuMQ==">ServerA@1.1.1.1<i class="fa fa-external-link-alt"></i></span>:freshing…<br>
[2012-11-14 15:19:25] Thread-6 get an event.Path:/demo,state:SyncConnected,type:NodeChildrenChanged<br>
[2012-11-14 15:19:25] In event: NodeChildrenChanged<br>
[2012-11-14 15:19:25] ================<br>
[2012-11-14 15:19:25] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckJAMS4xLjEuMg==">ServerB@1.1.1.2<i class="fa fa-external-link-alt"></i></span>:freshing…<br>
[2012-11-14 15:19:25] Thread-12 get an event.Path:/demo,state:SyncConnected,type:NodeChildrenChanged<br>
[2012-11-14 15:19:25] In event: NodeChildrenChanged<br>
[2012-11-14 15:19:25] ================<br>
[2012-11-14 15:19:25] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckNAMS4xLjEuMw==">ServerC@1.1.1.3<i class="fa fa-external-link-alt"></i></span>:freshing…<br>
[2012-11-14 15:19:25] SYSTEM VERSION: 1<br>
[2012-11-14 15:19:25] SYSTEM VERSION: 1<br>
[2012-11-14 15:19:25] SYSTEM VERSION: 1<br>
[2012-11-14 15:19:25] Server count:2<br>
[2012-11-14 15:19:25] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckNAMS4xLjEuMw==">ServerC@1.1.1.3<i class="fa fa-external-link-alt"></i></span>:end freshing…<br>
[2012-11-14 15:19:25] ================<br>
Did not get the mod number for <span class="exturl" data-url="bWFpbHRvOlNlcnZlckNAMS4xLjEuMw==">ServerC@1.1.1.3<i class="fa fa-external-link-alt"></i></span><br>
[2012-11-14 15:19:25] End event: NodeChildrenChanged<br>
[2012-11-14 15:19:25] Server count:2<br>
[2012-11-14 15:19:25] Server count:2<br>
[2012-11-14 15:19:25] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckJAMS4xLjEuMg==">ServerB@1.1.1.2<i class="fa fa-external-link-alt"></i></span>, mod=1,base=10<br>
[2012-11-14 15:19:25] ClientThread_ServerB@1.1.1.2-thread_0:5/10<br>
[2012-11-14 15:19:25] ClientThread_ServerB@1.1.1.2-thread_1:6/10<br>
[2012-11-14 15:19:25] ClientThread_ServerB@1.1.1.2-thread_2:7/10<br>
[2012-11-14 15:19:25] ClientThread_ServerB@1.1.1.2-thread_3:8/10<br>
[2012-11-14 15:19:25] ClientThread_ServerB@1.1.1.2-thread_4:9/10<br>
[2012-11-14 15:19:25] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckJAMS4xLjEuMg==">ServerB@1.1.1.2<i class="fa fa-external-link-alt"></i></span>:end freshing…<br>
[2012-11-14 15:19:25] ================<br>
[2012-11-14 15:19:25] End event: NodeChildrenChanged<br>
[2012-11-14 15:19:25] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckFAMS4xLjEuMQ==">ServerA@1.1.1.1<i class="fa fa-external-link-alt"></i></span>, mod=0,base=10<br>
[2012-11-14 15:19:25] ClientThread_ServerA@1.1.1.1-thread_0:0/10<br>
[2012-11-14 15:19:25] ClientThread_ServerA@1.1.1.1-thread_1:1/10<br>
[2012-11-14 15:19:25] ClientThread_ServerA@1.1.1.1-thread_2:2/10<br>
[2012-11-14 15:19:25] ClientThread_ServerA@1.1.1.1-thread_3:3/10<br>
[2012-11-14 15:19:25] ClientThread_ServerA@1.1.1.1-thread_4:4/10<br>
[2012-11-14 15:19:25] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckFAMS4xLjEuMQ==">ServerA@1.1.1.1<i class="fa fa-external-link-alt"></i></span>:end freshing…<br>
[2012-11-14 15:19:25] ================<br>
[2012-11-14 15:19:25] End event: NodeChildrenChanged<br>
[2012-11-14 15:19:26] ClientThread_ServerA@1.1.1.1-thread_2-2/10:2 12 22<br>
[2012-11-14 15:19:26] ClientThread_ServerA@1.1.1.1-thread_3-3/10:3 13 23<br>
[2012-11-14 15:19:26] ClientThread_ServerA@1.1.1.1-thread_0-0/10:10 20 30<br>
[2012-11-14 15:19:26] ClientThread_ServerA@1.1.1.1-thread_1-1/10:1 11 21<br>
[2012-11-14 15:19:26] ClientThread_ServerC@1.1.1.3-thread_0-10/10:<br>
[2012-11-14 15:19:26] ClientThread_ServerB@1.1.1.2-thread_0-5/10:5 15 25<br>
[2012-11-14 15:19:26] ClientThread_ServerB@1.1.1.2-thread_1-6/10:6 16 26<br>
[2012-11-14 15:19:26] ClientThread_ServerA@1.1.1.1-thread_4-4/10:4 14 24<br>
[2012-11-14 15:19:26] ClientThread_ServerC@1.1.1.3-thread_1-11/10:<br>
[2012-11-14 15:19:26] ClientThread_ServerB@1.1.1.2-thread_3-8/10:8 18 28<br>
[2012-11-14 15:19:26] ClientThread_ServerB@1.1.1.2-thread_2-7/10:7 17 27<br>
[2012-11-14 15:19:26] ClientThread_ServerB@1.1.1.2-thread_4-9/10:9 19 29<br>
[2012-11-14 15:19:26] ClientThread_ServerC@1.1.1.3-thread_2-12/10:<br>
[2012-11-14 15:19:26] ClientThread_ServerC@1.1.1.3-thread_4-14/10:<br>
[2012-11-14 15:19:26] ClientThread_ServerC@1.1.1.3-thread_3-13/10:<br>
[2012-11-14 15:19:31] ClientThread_ServerA@1.1.1.1-thread_1-1/10:1 11 21<br>
[2012-11-14 15:19:31] ClientThread_ServerA@1.1.1.1-thread_0-0/10:10 20 30<br>
[2012-11-14 15:19:31] ClientThread_ServerB@1.1.1.2-thread_0-5/10:5 15 25<br>
[2012-11-14 15:19:31] ClientThread_ServerC@1.1.1.3-thread_0-10/10:<br>
[2012-11-14 15:19:31] ClientThread_ServerA@1.1.1.1-thread_2-2/10:2 12 22<br>
[2012-11-14 15:19:31] ClientThread_ServerA@1.1.1.1-thread_3-3/10:3 13 23<br>
[2012-11-14 15:19:31] ClientThread_ServerB@1.1.1.2-thread_1-6/10:6 16 26<br>
[2012-11-14 15:19:31] ClientThread_ServerC@1.1.1.3-thread_1-11/10:<br>
[2012-11-14 15:19:31] ClientThread_ServerA@1.1.1.1-thread_4-4/10:4 14 24<br>
[2012-11-14 15:19:31] ClientThread_ServerB@1.1.1.2-thread_3-8/10:8 18 28<br>
[2012-11-14 15:19:31] ClientThread_ServerB@1.1.1.2-thread_2-7/10:7 17 27<br>
[2012-11-14 15:19:31] ClientThread_ServerB@1.1.1.2-thread_4-9/10:9 19 29<br>
[2012-11-14 15:19:31] ClientThread_ServerC@1.1.1.3-thread_2-12/10:<br>
[2012-11-14 15:19:31] ClientThread_ServerC@1.1.1.3-thread_3-13/10:<br>
[2012-11-14 15:19:31] ClientThread_ServerC@1.1.1.3-thread_4-14/10:<br>
[2012-11-14 15:19:31] Thread-0 get an event.Path:/demo,state:SyncConnected,type:NodeChildrenChanged<br>
[2012-11-14 15:19:31] In event: NodeChildrenChanged<br>
[2012-11-14 15:19:31] ================<br>
[2012-11-14 15:19:31] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckFAMS4xLjEuMQ==">ServerA@1.1.1.1<i class="fa fa-external-link-alt"></i></span>:freshing…<br>
[2012-11-14 15:19:31] Thread-12 get an event.Path:/demo,state:SyncConnected,type:NodeChildrenChanged<br>
[2012-11-14 15:19:31] In event: NodeChildrenChanged<br>
[2012-11-14 15:19:31] ================<br>
[2012-11-14 15:19:31] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckNAMS4xLjEuMw==">ServerC@1.1.1.3<i class="fa fa-external-link-alt"></i></span>:freshing…<br>
[2012-11-14 15:19:31] Thread-6 get an event.Path:/demo,state:SyncConnected,type:NodeChildrenChanged<br>
[2012-11-14 15:19:31] In event: NodeChildrenChanged<br>
[2012-11-14 15:19:31] ================<br>
[2012-11-14 15:19:31] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckJAMS4xLjEuMg==">ServerB@1.1.1.2<i class="fa fa-external-link-alt"></i></span>:freshing…<br>
[2012-11-14 15:19:31] SYSTEM VERSION: 1<br>
[2012-11-14 15:19:31] SYSTEM VERSION: 1<br>
[2012-11-14 15:19:31] SYSTEM VERSION: 1<br>
[2012-11-14 15:19:31] Server count:3<br>
[2012-11-14 15:19:31] Server count:3<br>
[2012-11-14 15:19:31] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckFAMS4xLjEuMQ==">ServerA@1.1.1.1<i class="fa fa-external-link-alt"></i></span>, mod=0,base=15<br>
[2012-11-14 15:19:31] ClientThread_ServerA@1.1.1.1-thread_0:0/15<br>
[2012-11-14 15:19:31] ClientThread_ServerA@1.1.1.1-thread_1:1/15<br>
[2012-11-14 15:19:31] ClientThread_ServerA@1.1.1.1-thread_2:2/15<br>
[2012-11-14 15:19:31] ClientThread_ServerA@1.1.1.1-thread_3:3/15<br>
[2012-11-14 15:19:31] ClientThread_ServerA@1.1.1.1-thread_4:4/15<br>
[2012-11-14 15:19:31] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckFAMS4xLjEuMQ==">ServerA@1.1.1.1<i class="fa fa-external-link-alt"></i></span>:end freshing…<br>
[2012-11-14 15:19:31] ================<br>
[2012-11-14 15:19:31] End event: NodeChildrenChanged<br>
[2012-11-14 15:19:31] Server count:3<br>
[2012-11-14 15:19:31] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckNAMS4xLjEuMw==">ServerC@1.1.1.3<i class="fa fa-external-link-alt"></i></span>, mod=2,base=15<br>
[2012-11-14 15:19:31] ClientThread_ServerC@1.1.1.3-thread_0:10/15<br>
[2012-11-14 15:19:31] ClientThread_ServerC@1.1.1.3-thread_1:11/15<br>
[2012-11-14 15:19:31] ClientThread_ServerC@1.1.1.3-thread_2:12/15<br>
[2012-11-14 15:19:31] ClientThread_ServerC@1.1.1.3-thread_3:13/15<br>
[2012-11-14 15:19:31] ClientThread_ServerC@1.1.1.3-thread_4:14/15<br>
[2012-11-14 15:19:31] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckNAMS4xLjEuMw==">ServerC@1.1.1.3<i class="fa fa-external-link-alt"></i></span>:end freshing…<br>
[2012-11-14 15:19:31] ================<br>
[2012-11-14 15:19:31] End event: NodeChildrenChanged<br>
[2012-11-14 15:19:31] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckJAMS4xLjEuMg==">ServerB@1.1.1.2<i class="fa fa-external-link-alt"></i></span>, mod=1,base=15<br>
[2012-11-14 15:19:31] ClientThread_ServerB@1.1.1.2-thread_0:5/15<br>
[2012-11-14 15:19:31] ClientThread_ServerB@1.1.1.2-thread_1:6/15<br>
[2012-11-14 15:19:31] ClientThread_ServerB@1.1.1.2-thread_2:7/15<br>
[2012-11-14 15:19:31] ClientThread_ServerB@1.1.1.2-thread_3:8/15<br>
[2012-11-14 15:19:31] ClientThread_ServerB@1.1.1.2-thread_4:9/15<br>
[2012-11-14 15:19:31] <span class="exturl" data-url="bWFpbHRvOlNlcnZlckJAMS4xLjEuMg==">ServerB@1.1.1.2<i class="fa fa-external-link-alt"></i></span>:end freshing…<br>
[2012-11-14 15:19:31] ================<br>
[2012-11-14 15:19:31] End event: NodeChildrenChanged<br>
[2012-11-14 15:19:36] ClientThread_ServerB@1.1.1.2-thread_0-5/15:5 20<br>
[2012-11-14 15:19:36] ClientThread_ServerA@1.1.1.1-thread_2-2/15:2 17<br>
[2012-11-14 15:19:36] ClientThread_ServerA@1.1.1.1-thread_3-3/15:3 18<br>
[2012-11-14 15:19:36] ClientThread_ServerC@1.1.1.3-thread_0-10/15:10 25<br>
[2012-11-14 15:19:36] ClientThread_ServerA@1.1.1.1-thread_0-0/15:15 30<br>
[2012-11-14 15:19:36] ClientThread_ServerA@1.1.1.1-thread_1-1/15:1 16<br>
[2012-11-14 15:19:36] ClientThread_ServerB@1.1.1.2-thread_1-6/15:6 21<br>
[2012-11-14 15:19:36] ClientThread_ServerC@1.1.1.3-thread_1-11/15:11 26<br>
[2012-11-14 15:19:36] ClientThread_ServerB@1.1.1.2-thread_3-8/15:8 23<br>
[2012-11-14 15:19:36] ClientThread_ServerA@1.1.1.1-thread_4-4/15:4 19<br>
[2012-11-14 15:19:36] ClientThread_ServerB@1.1.1.2-thread_2-7/15:7 22<br>
[2012-11-14 15:19:36] ClientThread_ServerC@1.1.1.3-thread_2-12/15:12 27<br>
[2012-11-14 15:19:36] ClientThread_ServerB@1.1.1.2-thread_4-9/15:9 24<br>
[2012-11-14 15:19:36] ClientThread_ServerC@1.1.1.3-thread_4-14/15:14 29<br>
[2012-11-14 15:19:36] ClientThread_ServerC@1.1.1.3-thread_3-13/15:13 28<br>
[2012-11-14 15:19:41] ClientThread_ServerC@1.1.1.3-thread_0-10/15:10 25<br>
[2012-11-14 15:19:41] ClientThread_ServerA@1.1.1.1-thread_0-0/15:15 30<br>
[2012-11-14 15:19:41] ClientThread_ServerB@1.1.1.2-thread_1-6/15:6 21<br>
[2012-11-14 15:19:41] ClientThread_ServerA@1.1.1.1-thread_3-3/15:3 18<br>
[2012-11-14 15:19:41] ClientThread_ServerB@1.1.1.2-thread_0-5/15:5 20<br>
[2012-11-14 15:19:41] ClientThread_ServerA@1.1.1.1-thread_1-1/15:1 16<br>
[2012-11-14 15:19:41] ClientThread_ServerA@1.1.1.1-thread_2-2/15:2 17<br>
[2012-11-14 15:19:41] ClientThread_ServerB@1.1.1.2-thread_3-8/15:8 23<br>
[2012-11-14 15:19:41] ClientThread_ServerB@1.1.1.2-thread_2-7/15:7 22<br>
[2012-11-14 15:19:41] ClientThread_ServerA@1.1.1.1-thread_4-4/15:4 19<br>
[2012-11-14 15:19:41] ClientThread_ServerC@1.1.1.3-thread_1-11/15:11 26<br>
[2012-11-14 15:19:41] ClientThread_ServerC@1.1.1.3-thread_2-12/15:12 27<br>
[2012-11-14 15:19:41] ClientThread_ServerB@1.1.1.2-thread_4-9/15:9 24<br>
[2012-11-14 15:19:41] ClientThread_ServerC@1.1.1.3-thread_4-14/15:14 29<br>
[2012-11-14 15:19:41] ClientThread_ServerC@1.1.1.3-thread_3-13/15:13 28</p>
</blockquote>
]]></content>
      <categories>
        <category>分布式应用</category>
      </categories>
      <tags>
        <tag>zookeeper</tag>
        <tag>分布式协调</tag>
        <tag>横向扩展</tag>
      </tags>
  </entry>
  <entry>
    <title>将Hadoop RPC框架应用于多节点任务调度</title>
    <url>/20140121/%E5%B0%86Hadoop-RPC%E6%A1%86%E6%9E%B6%E5%BA%94%E7%94%A8%E4%BA%8E%E5%A4%9A%E8%8A%82%E7%82%B9%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6/</url>
    <content><![CDATA[<h2 id="背景"><a class="markdownIt-Anchor" href="#背景"></a> 背景</h2>
<p>在hadoop中，主从节点之间保持着心跳通信，用于传输节点状态信息、任务调度信息以及节点动作信息等等。 hdfs的namenode与datanode，mapreduce的jobtracker与tasktracker，hbase的hmaster与 regionserver之间的通信，都是基于hadoop RPC。Hadoop RPC是hadoop里非常基础的通信框架。hadoop 2.0以前hadoop RPC的数据序列化是通过实现自己定义的Writable接口实现，而从hadoop 2.0开始，数据的序列化工作交给了ProtocolBuffer去做。关于Hadoop RPC的实现原理已经有很多文章进行了详细的介绍（<span class="exturl" data-url="aHR0cDovL3dlaXhpYW9sdS5pdGV5ZS5jb20vYmxvZy8xNTA0ODk4">源码级强力分析hadoop的RPC机制<i class="fa fa-external-link-alt"></i></span>，<span class="exturl" data-url="aHR0cDovL3lhbmJvaGFwcHkuc2luYWFwcC5jb20vP3A9MTEw">Hadoop基于Protocol Buffer的RPC实现代码分析-Server端<i class="fa fa-external-link-alt"></i></span>，<span class="exturl" data-url="aHR0cDovL3lhbmJvaGFwcHkuc2luYWFwcC5jb20vP3A9MTE1">带有HA功能的Hadoop Client端RPC实现原理与代码分析<i class="fa fa-external-link-alt"></i></span>），这里就不在赘述了。下面就直接引入问题和方案吧。</p>
<h2 id="问题"><a class="markdownIt-Anchor" href="#问题"></a> 问题</h2>
<p>工作中经常需要在定时任务系统上写一些定时任务，随着业务规模的增长和扩大，需要定时处理的任务越来越多，任务之间的执行间隔越来越小，某一时间段内（比如0点、整点或半点）执行的任务会越来越密集，只在一台机器上执行这些任务的话，会出现较大的风险：</p>
<ul>
<li>任务并发度较高时，单机的系统资源将成为瓶颈</li>
<li>如果一个任务的运行占用了整个机器的大部分资源，比如sql查询耗费巨大内存和CPU资源，将直接影响其他任务的运行</li>
<li>任务失败后，如果仍然在同一台节点自动重新执行，失败率较高</li>
<li>机器宕机后，必须第一时间重启机器或重新部署定时任务系统，所有任务都不能按时执行</li>
<li>等等</li>
</ul>
<h2 id="方案"><a class="markdownIt-Anchor" href="#方案"></a> 方案</h2>
<p>可想而知的是，可以通过将定时任务系统进行分布式改造，使用多个节点执行任务，将任务分发到不同节点上进行处理，并且完善失败重试机制，从而提高系统稳定性，实现任务系统的高可靠。<br>
既然是在多个节点之间分发任务，肯定得有个任务的管理者(主节点)，在我们现有的系统中，也就是一套可以部署定时任务的web系统，任务代码更新后，部署好这套web系统，即可通过web页面设置定时任务并且进行调度(在单个节点上执行)。执行任务的节点(子节点)有多个以后，如何分发任务到子节点呢，我们可以把任务的信息封装成一个bean，通过RPC发布给子节点，子节点通过这个任务bean获得任务信息，并在指定的时刻执行任务。同时，子节点可以通过与主节点的心跳通信将节点状态和执行任务的情况告诉主节点。<br>
这样其实就与hadoop mapreduce分发任务有点相似了，呵呵，这里主节点与子节点之间的通信，我们就可以通过Hadoop RPC框架来实现了，不同的是，我们分发的任务是定时任务，发布任务时需要将任务的定时信息一并发给子节点。</p>
<h2 id="实现"><a class="markdownIt-Anchor" href="#实现"></a> 实现</h2>
<p>单点的定时任务系统是基于Quartz的，在分布式环境下，可以继续基于Quartz进行改造，任务的定时信息可以通过Quartz中的JobDetail和Trigger对象来描述并封装，加上任务执行的入口类信息，再通过RPC由主节点发给子节点。子节点收到封装好的任务信息对象后，再构造JobDetail和Trigger，设置好启动时间后，通过入口类启动任务。下面是一个简单的demo。</p>
<span id="more"></span>
<p>以下是一个简单的定时任务信息描述对象CronJobInfo，包括JobDetailInfo和TriggerInfo两个属性：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 定时任务信息，包括任务信息和触发器信息</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CronJobInfo</span> <span class="keyword">implements</span> <span class="title class_">Writable</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">private</span> <span class="type">JobDetailInfo</span> <span class="variable">jobDetailInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JobDetailInfo</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">TriggerInfo</span> <span class="variable">triggerInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TriggerInfo</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readFields</span><span class="params">(DataInput in)</span> <span class="keyword">throws</span> IOException</span><br><span class="line">    {</span><br><span class="line">        jobDetailInfo.readFields(in);</span><br><span class="line">        triggerInfo.readFields(in);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(DataOutput out)</span> <span class="keyword">throws</span> IOException</span><br><span class="line">    {</span><br><span class="line">        jobDetailInfo.write(out);</span><br><span class="line">        triggerInfo.write(out);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// getters and setters...</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>任务信息JobDetailInfo，由主节点构造，子节点解析构造JobDetail对象：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JobDetailInfo</span> <span class="keyword">implements</span> <span class="title class_">Writable</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">private</span> String name; <span class="comment">// 任务名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">group</span> <span class="operator">=</span> Scheduler.DEFAULT_GROUP; <span class="comment">// 任务组</span></span><br><span class="line">    <span class="keyword">private</span> String description; <span class="comment">// 任务描述</span></span><br><span class="line">    <span class="keyword">private</span> Class jobClass; <span class="comment">// 任务的启动类</span></span><br><span class="line">    <span class="keyword">private</span> JobDataMap jobDataMap; <span class="comment">// 任务所需的参数，用来给作业提供数据支持的数据结构</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">volatility</span> <span class="operator">=</span> <span class="literal">false</span>; <span class="comment">// &lt;span&gt;重启应用之后是否删除任务的相关信息,&lt;/span&gt;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">durability</span> <span class="operator">=</span> <span class="literal">false</span>; <span class="comment">// 任务完成之后是否依然保留到数据库</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">shouldRecover</span> <span class="operator">=</span> <span class="literal">false</span>; <span class="comment">// 应用重启之后时候忽略过期任务</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readFields</span><span class="params">(DataInput in)</span> <span class="keyword">throws</span> IOException</span><br><span class="line">    {</span><br><span class="line">        name = WritableUtils.readString(in);</span><br><span class="line">        group = WritableUtils.readString(in);</span><br><span class="line">        description = WritableUtils.readString(in);</span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> WritableUtils.readString(in);</span><br><span class="line">        <span class="keyword">if</span> (className != <span class="literal">null</span>)</span><br><span class="line">        {</span><br><span class="line">          <span class="keyword">try</span></span><br><span class="line">          {</span><br><span class="line">             jobClass = Class.forName(<span class="keyword">new</span> <span class="title class_">String</span>(className));</span><br><span class="line">          }</span><br><span class="line">          <span class="keyword">catch</span> (ClassNotFoundException e)</span><br><span class="line">          {</span><br><span class="line">             e.printStackTrace();</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">        <span class="type">int</span> <span class="variable">dataMapSize</span> <span class="operator">=</span> WritableUtils.readVInt(in);</span><br><span class="line">        <span class="keyword">while</span> (dataMapSize-- &gt; <span class="number">0</span>)</span><br><span class="line">        {</span><br><span class="line">           <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> WritableUtils.readString(in);</span><br><span class="line">           <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> WritableUtils.readString(in);</span><br><span class="line">           jobDataMap.put(key, value);</span><br><span class="line">        }</span><br><span class="line">        volatility = in.readBoolean();</span><br><span class="line">        durability = in.readBoolean();</span><br><span class="line">        shouldRecover = in.readBoolean();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(DataOutput out)</span> <span class="keyword">throws</span> IOException</span><br><span class="line">    {</span><br><span class="line">        WritableUtils.writeString(out, name);</span><br><span class="line">        WritableUtils.writeString(out, group);</span><br><span class="line">        WritableUtils.writeString(out, description);</span><br><span class="line">        WritableUtils.writeString(out, jobClass.getName());</span><br><span class="line">        <span class="keyword">if</span> (jobDataMap == <span class="literal">null</span>)</span><br><span class="line">            WritableUtils.writeVInt(out, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        {</span><br><span class="line">            WritableUtils.writeVInt(out, jobDataMap.size());</span><br><span class="line">            <span class="keyword">for</span> (Object k : jobDataMap.keySet())</span><br><span class="line">            {</span><br><span class="line">                WritableUtils.writeString(out, k.toString());</span><br><span class="line">                WritableUtils.writeString(out, jobDataMap.get(k).toString());</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        out.writeBoolean(volatility);</span><br><span class="line">        out.writeBoolean(durability);</span><br><span class="line">        out.writeBoolean(shouldRecover);</span><br><span class="line">   }</span><br><span class="line">   <span class="comment">//getters and setters</span></span><br><span class="line">   <span class="comment">//.....</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>任务触发器信息TriggerInfo ，由主节点构造，子节点解析构造Trigger对象：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TriggerInfo</span> <span class="keyword">implements</span> <span class="title class_">Writable</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">private</span> String name; <span class="comment">// trigger名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">group</span> <span class="operator">=</span> Scheduler.DEFAULT_GROUP; <span class="comment">// triger组名称</span></span><br><span class="line">    <span class="keyword">private</span> String description; <span class="comment">// trigger描述</span></span><br><span class="line">    <span class="keyword">private</span> Date startTime; <span class="comment">// 启动时间</span></span><br><span class="line">    <span class="keyword">private</span> Date endTime; <span class="comment">// 结束时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> repeatInterval; <span class="comment">// 重试时间间隔</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> repeatCount; <span class="comment">//重试次数</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readFields</span><span class="params">(DataInput in)</span> <span class="keyword">throws</span> IOException</span><br><span class="line">    {</span><br><span class="line">       name = WritableUtils.readString(in);</span><br><span class="line">       group = WritableUtils.readString(in);</span><br><span class="line">       description = WritableUtils.readString(in);</span><br><span class="line">       <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> in.readLong();</span><br><span class="line">       startTime = start==<span class="number">0</span> ? <span class="literal">null</span> : <span class="keyword">new</span> <span class="title class_">Date</span>(start);</span><br><span class="line">       <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> in.readLong();</span><br><span class="line">       endTime = end==<span class="number">0</span> ? <span class="literal">null</span> : <span class="keyword">new</span> <span class="title class_">Date</span>(end);</span><br><span class="line">       repeatInterval = in.readLong();</span><br><span class="line">       repeatCount = in.readInt();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(DataOutput out)</span> <span class="keyword">throws</span> IOException</span><br><span class="line">    {</span><br><span class="line">       WritableUtils.writeString(out, name);</span><br><span class="line">       WritableUtils.writeString(out, group);</span><br><span class="line">       WritableUtils.writeString(out, description);</span><br><span class="line">       out.writeLong(startTime == <span class="literal">null</span> ? <span class="number">0</span> : startTime.getTime());</span><br><span class="line">       out.writeLong(endTime == <span class="literal">null</span> ? <span class="number">0</span> : endTime.getTime());</span><br><span class="line">       out.writeLong(repeatInterval);</span><br><span class="line">       out.writeInt(repeatCount);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//getters and setters</span></span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>主从节点通信的协议：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TaskProtocol</span> <span class="keyword">extends</span> <span class="title class_">VersionedProtocol</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">public</span> CronJobInfo <span class="title function_">hearbeat</span><span class="params">()</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>在这个demo中，主节点启动后，启动RPC server线程，等待客户端（子节点）的连接，当客户端调用heartbeat方法时，主节点将会生成一个任务信息返回给客户端：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TaskScheduler</span> <span class="keyword">implements</span> <span class="title class_">TaskProtocol</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> Logger.getLogger(getClass());</span><br><span class="line">    <span class="keyword">private</span> Server server;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TaskScheduler</span><span class="params">()</span></span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        {</span><br><span class="line">            server = RPC.getServer(<span class="built_in">this</span>, <span class="string">"192.168.1.101"</span>, <span class="number">8888</span>, <span class="keyword">new</span> <span class="title class_">Configuration</span>());</span><br><span class="line">            server.start();</span><br><span class="line">            server.join();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">catch</span> (UnknownHostException e)</span><br><span class="line">        {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">catch</span> (IOException e)</span><br><span class="line">        {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">catch</span> (InterruptedException e)</span><br><span class="line">        {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getProtocolVersion</span><span class="params">(String arg0, <span class="type">long</span> arg1)</span> <span class="keyword">throws</span> IOException</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CronJobInfo <span class="title function_">generateCronJob</span><span class="params">()</span></span><br><span class="line">    {</span><br><span class="line">        <span class="comment">// 1、创建JobDetial对象</span></span><br><span class="line">        <span class="type">JobDetailInfo</span> <span class="variable">detail</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JobDetailInfo</span>();</span><br><span class="line">        <span class="comment">// 设置工作项</span></span><br><span class="line">        detail.setJobClass(DemoTask.class);</span><br><span class="line">        detail.setName(<span class="string">"MyJob_1"</span>);</span><br><span class="line">        detail.setGroup(<span class="string">"JobGroup_1"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2、创建Trigger对象</span></span><br><span class="line">        <span class="type">TriggerInfo</span> <span class="variable">trigger</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TriggerInfo</span>();</span><br><span class="line">        trigger.setName(<span class="string">"Trigger_1"</span>);</span><br><span class="line">        trigger.setGroup(<span class="string">"Trigger_Group_1"</span>);</span><br><span class="line">        trigger.setStartTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        <span class="comment">// 设置重复停止时间，并销毁该Trigger对象</span></span><br><span class="line">        <span class="type">Calendar</span> <span class="variable">c</span> <span class="operator">=</span> Calendar.getInstance();</span><br><span class="line">        c.setTimeInMillis(System.currentTimeMillis() + <span class="number">1000</span> * <span class="number">1L</span>);</span><br><span class="line">        trigger.setEndTime(c.getTime());</span><br><span class="line">        <span class="comment">// 设置重复间隔时间</span></span><br><span class="line">        trigger.setRepeatInterval(<span class="number">1000</span> * <span class="number">1L</span>);</span><br><span class="line">        <span class="comment">// 设置重复执行次数</span></span><br><span class="line">        trigger.setRepeatCount(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">CronJobInfo</span> <span class="variable">info</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CronJobInfo</span>();</span><br><span class="line">        info.setJobDetailInfo(detail);</span><br><span class="line">        info.setTriggerInfo(trigger);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span></span><br><span class="line">    {</span><br><span class="line">        <span class="type">TaskScheduler</span> <span class="variable">ts</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TaskScheduler</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>demo任务类，打印信息：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoTask</span> <span class="keyword">implements</span> <span class="title class_">Job</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(JobExecutionContext context)</span></span><br><span class="line">            <span class="keyword">throws</span> JobExecutionException</span><br><span class="line">    {</span><br><span class="line">        System.out.println(<span class="built_in">this</span> + <span class="string">": executing task @"</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>子节点demo，启动后连接主节点，远程调用generateCronJob方法，获得一个任务描述信息，并启动定时任务。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TaskRunner</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> Logger.getLogger(getClass());</span><br><span class="line">    <span class="keyword">private</span> TaskProtocol proxy;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TaskRunner</span><span class="params">()</span></span><br><span class="line">    {</span><br><span class="line">        <span class="type">InetSocketAddress</span> <span class="variable">addr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">"localhost"</span>, <span class="number">8888</span>);</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        {</span><br><span class="line">            proxy = (TaskProtocol) RPC.waitForProxy(TaskProtocol.class, <span class="number">1</span>, addr,</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Configuration</span>());</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">catch</span> (IOException e)</span><br><span class="line">        {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span></span><br><span class="line">    {</span><br><span class="line">        RPC.stopProxy(proxy);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从server获取一个定时任务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getCronJob</span><span class="params">()</span></span><br><span class="line">    {</span><br><span class="line">        <span class="type">CronJobInfo</span> <span class="variable">info</span> <span class="operator">=</span> proxy.generateCronJob();</span><br><span class="line">        <span class="type">JobDetail</span> <span class="variable">jobDetail</span> <span class="operator">=</span> getJobDetail(info.getJobDetailInfo());</span><br><span class="line">        <span class="type">SimpleTrigger</span> <span class="variable">trigger</span> <span class="operator">=</span> getTrigger(info.getTriggerInfo());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建Scheduler对象，并配置JobDetail和Trigger对象</span></span><br><span class="line">        <span class="type">SchedulerFactory</span> <span class="variable">sf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StdSchedulerFactory</span>();</span><br><span class="line">        <span class="type">Scheduler</span> <span class="variable">scheduler</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        {</span><br><span class="line">            scheduler = sf.getScheduler();</span><br><span class="line">            scheduler.scheduleJob(jobDetail, trigger);</span><br><span class="line">            <span class="comment">// 执行启动操作</span></span><br><span class="line">            scheduler.start();</span><br><span class="line"></span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">catch</span> (SchedulerException e)</span><br><span class="line">        {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jobDetailInfo</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> JobDetail <span class="title function_">getJobDetail</span><span class="params">(JobDetailInfo info)</span></span><br><span class="line">    {</span><br><span class="line">        <span class="type">JobDetail</span> <span class="variable">detail</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JobDetail</span>();</span><br><span class="line">        detail.setName(info.getName());</span><br><span class="line">        detail.setGroup(info.getGroup());</span><br><span class="line">        detail.setDescription(info.getDescription());</span><br><span class="line">        detail.setJobClass(info.getJobClass());</span><br><span class="line">        detail.setJobDataMap(info.getJobDataMap());</span><br><span class="line">        detail.setRequestsRecovery(info.isShouldRecover());</span><br><span class="line">        detail.setDurability(info.isDurability());</span><br><span class="line">        detail.setVolatility(info.isVolatility());</span><br><span class="line">        logger.info(<span class="string">"client get jobdetail:"</span> + detail);</span><br><span class="line">        <span class="keyword">return</span> detail;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> triggerInfo</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> SimpleTrigger <span class="title function_">getTrigger</span><span class="params">(TriggerInfo info)</span></span><br><span class="line">    {</span><br><span class="line">        <span class="type">SimpleTrigger</span> <span class="variable">trigger</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleTrigger</span>();</span><br><span class="line">        trigger.setName(info.getName());</span><br><span class="line">        trigger.setGroup(info.getGroup());</span><br><span class="line">        trigger.setDescription(info.getDescription());</span><br><span class="line">        trigger.setStartTime(info.getStartTime());</span><br><span class="line">        trigger.setEndTime(info.getEndTime());</span><br><span class="line">        trigger.setRepeatInterval(info.getRepeatInterval());</span><br><span class="line">        trigger.setRepeatCount(info.getRepeatCount());</span><br><span class="line">        logger.info(<span class="string">"client get trigger:"</span> + trigger);</span><br><span class="line">        <span class="keyword">return</span> trigger;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span></span><br><span class="line">    {</span><br><span class="line">        <span class="type">TaskRunner</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TaskRunner</span>();</span><br><span class="line">        t.getCronJob();</span><br><span class="line">        t.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>先启动TaskScheduler，再启动TaskRunner，结果如下：</p>
<blockquote>
<p>TaskScheduler日志:<br>
2013-01-20 15:42:21,661 [Socket Reader #1 for port 8888] INFO  [org.apache.hadoop.ipc.Server] – Starting Socket Reader #1 for port 8888<br>
2013-01-20 15:42:21,662 [main] INFO  [org.apache.hadoop.ipc.metrics.RpcMetrics] – Initializing RPC Metrics with hostName=TaskScheduler, port=8888<br>
2013-01-20 15:42:21,706 [main] INFO  [org.apache.hadoop.ipc.metrics.RpcDetailedMetrics] – Initializing RPC Metrics with hostName=TaskScheduler, port=8888<br>
2013-01-20 15:42:21,710 [IPC Server listener on 8888] INFO  [org.apache.hadoop.ipc.Server] – IPC Server listener on 8888: starting<br>
2013-01-20 15:42:21,711 [IPC Server Responder] INFO  [org.apache.hadoop.ipc.Server] – IPC Server Responder: starting<br>
2013-01-20 15:42:21,711 [IPC Server handler 0 on 8888] INFO  [org.apache.hadoop.ipc.Server] – IPC Server handler 0 on 8888: starting<br>
2013-01-20 15:42:24,084 [IPC Server handler 0 on 8888] INFO  [org.mh.rpc.task.TaskScheduler] – generate a task: org.mh.rpc.task.JobDetailInfo@1f26605</p>
<p>TaskRunner:<br>
2013-01-20 15:42:26,323 [main] INFO  [org.mh.rpc.task.TaskRunner] – client get jobdetail:JobDetail ‘JobGroup_1.MyJob_1′:  jobClass: ‘org.mh.rpc.quartz.GetSumTask isStateful: false isVolatile: false isDurable: false requestsRecovers: false<br>
2013-01-20 15:42:26,329 [main] INFO  [org.mh.rpc.task.TaskRunner] – client get trigger:Trigger ‘Trigger_Group_1.Trigger_1′:  triggerClass: ‘org.quartz.SimpleTrigger isVolatile: false calendar: ‘null’ misfireInstruction: 0 nextFireTime: null<br>
2013-01-20 15:42:26,382 [main] INFO  [org.quartz.simpl.SimpleThreadPool] – Job execution threads will use class loader of thread: main<br>
2013-01-20 15:42:26,411 [main] INFO  [org.quartz.core.SchedulerSignalerImpl] – Initialized Scheduler Signaller of type: class org.quartz.core.SchedulerSignalerImpl<br>
2013-01-20 15:42:26,411 [main] INFO  [org.quartz.core.QuartzScheduler] – Quartz Scheduler v.1.6.5 created.<br>
2013-01-20 15:42:26,413 [main] INFO  [org.quartz.simpl.RAMJobStore] – RAMJobStore initialized.<br>
2013-01-20 15:42:26,413 [main] INFO  [org.quartz.impl.StdSchedulerFactory] – Quartz scheduler ‘DefaultQuartzScheduler’ initialized from default resource file in Quartz package: ‘quartz.properties’<br>
2013-01-20 15:42:26,413 [main] INFO  [org.quartz.impl.StdSchedulerFactory] – Quartz scheduler version: 1.6.5<br>
2013-01-20 15:42:26,415 [main] INFO  [org.quartz.core.QuartzScheduler] – Scheduler DefaultQuartzScheduler_$_NON_CLUSTERED started.<br>
org.mh.rpc.quartz.DemoTask@1b66b06: executing task @Sun Jan 20 15:42:26 CST 2013</p>
</blockquote>
<p>上面是一个简单的demo，演示了如何通过RPC将任务调度给节点去执行，对于Quartz来说，任务的形式可以千变万化，关键就看怎么去使用了，分发到多个节点上执行的话，就还需要对任务的信息做更多的封装了。</p>
]]></content>
      <categories>
        <category>Hadoop</category>
      </categories>
      <tags>
        <tag>hadoop</tag>
        <tag>分布式应用</tag>
        <tag>RPC</tag>
        <tag>任务调度</tag>
      </tags>
  </entry>
</search>
